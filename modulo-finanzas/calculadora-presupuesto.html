<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Presupuesto Múltiple</title>
    <meta name="theme-color" content="#2563eb">
    <link rel="icon" href="/pwa/logo-app.png">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="estilos.css">
    <script defer src="javascript.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Estilos para el scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .tab-button {
            color: var(--color-text-secondary);
            border-bottom: 2px solid transparent;
            transition: color 0.2s ease, border-color 0.2s ease, background-color 0.2s ease;
        }
        .tab-button:hover {
            color: var(--color-accent-text);
        }
        .tab-button.tab-active {
            border-color: var(--color-accent-solid);
            color: var(--color-accent-text);
            background-color: var(--color-accent-bg);
        }
        .primary-accent-button {
            background-color: var(--color-accent-solid);
            color: #f8fafc;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .primary-accent-button:hover {
            background-color: var(--color-accent-solid-hover);
            transform: translateY(-1px);
        }
        .primary-accent-button:focus-visible {
            outline: 2px solid var(--color-accent-solid);
            outline-offset: 2px;
        }
        .primary-accent-chip {
            background: var(--color-accent-solid);
            color: #f8fafc;
            box-shadow: 0 10px 18px rgba(15, 23, 42, 0.14);
        }
        .secondary-accent-link {
            color: var(--color-accent-text);
            background-color: var(--color-accent-bg);
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .secondary-accent-link:hover {
            background-color: var(--color-accent-bg-hover);
        }
        .secondary-accent-link:focus-visible {
            outline: 2px solid var(--color-accent-solid);
            outline-offset: 2px;
        }
        .accent-progress {
            background-color: var(--color-accent-solid);
        }
        .accent-badge {
            background-color: var(--color-accent-bg);
            color: var(--color-accent-text);
        }
        .accent-outline {
            transition: box-shadow 0.2s ease, border-color 0.2s ease, outline-color 0.2s ease;
        }
        .accent-outline:focus,
        .accent-outline:focus-visible {
            outline: 2px solid var(--color-accent-solid);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px var(--color-accent-bg);
            border-color: var(--color-accent-solid);
        }
        .accent-text-strong {
            color: var(--color-accent-text);
        }
        [data-theme] .text-slate-900,
        [data-theme] .text-slate-800,
        [data-theme] .text-slate-700 {
            color: var(--color-text-primary) !important;
        }
        [data-theme] .text-slate-600,
        [data-theme] .text-slate-500,
        [data-theme] .text-slate-400 {
            color: var(--color-text-secondary) !important;
        }
        [data-theme] .bg-slate-50,
        [data-theme] .bg-slate-100 {
            background-color: var(--color-surface-alt) !important;
        }
        [data-theme] .bg-slate-200,
        [data-theme] .bg-slate-300 {
            background-color: var(--color-surface-muted) !important;
        }
        [data-theme] .border-slate-200,
        [data-theme] .border-slate-300,
        [data-theme] .border-slate-100 {
            border-color: var(--color-border) !important;
        }

        /* Animación para la aparición de elementos */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <!-- Contenedor principal de la aplicación -->
    <div id="app" class="min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="max-w-6xl mx-auto">
            
            <!-- Encabezado -->
            <header class="flex justify-between items-center mb-8">
                <div class="flex items-center gap-3">
                    <div class="primary-accent-chip p-2 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wallet"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>
                    </div>
                    <h1 id="main-title" class="text-2xl font-bold text-slate-900">Calculadora de Presupuestos</h1>
                </div>
                <div class="flex items-center gap-3">
                    <a href="ajustes.html" class="secondary-accent-link flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg transition-colors whitespace-nowrap">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                        Volver a Ajustes
                    </a>
                    <button id="back-to-manager-btn" class="hidden items-center gap-2 px-4 py-2 text-sm font-medium text-slate-600 bg-slate-200 rounded-lg hover:bg-slate-300 transition-colors whitespace-nowrap">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                        Volver
                    </button>
                </div>
            </header>

            <!-- Vistas Principales -->
            <main id="main-content">
                <!-- Vista: Gestor de Presupuestos -->
                <div id="manager-view">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold">Panel de Control</h2>
                        <button id="add-new-budget-btn" class="primary-accent-button text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2 whitespace-nowrap">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>
                            Nuevo Presupuesto
                        </button>
                    </div>
                    <div id="budgets-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    <div id="no-budgets-message" class="hidden text-center py-16 px-6 bg-white rounded-xl shadow-sm border border-slate-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-inbox mx-auto text-slate-400 mb-4"><path d="M22 12h-6l-2 3h-4l-2-3H2"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>
                        <h3 class="text-xl font-semibold mb-2">No tienes presupuestos</h3>
                        <p class="text-slate-500 mb-6">Crea tu primer presupuesto para empezar a organizar tus finanzas.</p>
                        <button id="create-first-budget-btn" class="primary-accent-button text-white font-bold py-2 px-4 rounded-lg transition-all">Crear mi primer presupuesto</button>
                    </div>
                </div>

                <!-- Vista: Dashboard del Presupuesto Activo -->
                <div id="dashboard-view" class="hidden">
                    <nav id="tabs-nav" class="mb-6">
                        <ul class="flex border-b border-slate-200">
                            <li><button data-tab="dashboard" class="tab-button py-3 px-5 font-semibold transition-colors tab-active">Resumen</button></li>
                            <li><button data-tab="expenses" class="tab-button py-3 px-5 font-semibold transition-colors">Gastos</button></li>
                        </ul>
                    </nav>
                    <div id="tabs-content">
                        <div id="dashboard-tab" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <h2 class="text-lg font-bold mb-4">Añadir Nuevo Gasto</h2>
                                <form id="expense-form" class="space-y-4">
                                    <input type="text" id="expense-name" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none accent-outline" placeholder="Nombre del Gasto" required>
                                    <input type="number" id="expense-amount" min="0.01" step="0.01" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none accent-outline" placeholder="0.00" required>
                                    <button type="submit" class="w-full primary-accent-button text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>
                                        Agregar Gasto
                                    </button>
                                </form>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-between">
                                <div>
                                    <h2 id="budget-title-summary" class="text-xl font-bold mb-2"></h2>
                                    <p id="budget-period-summary" class="text-sm text-slate-500 mb-4"></p>
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-baseline"><span class="font-medium">Presupuesto:</span><span id="summary-total" class="text-lg font-bold text-green-600"></span></div>
                                        <div class="flex justify-between items-baseline"><span class="font-medium">Gastado:</span><span id="summary-spent" class="text-lg font-bold text-red-600"></span></div>
                                        <hr class="my-3"><div class="flex justify-between items-baseline"><span class="font-bold text-lg">Disponible:</span><span id="summary-remaining" class="text-2xl font-bold accent-text-strong"></span></div>
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <div class="w-full bg-slate-200 rounded-full h-2.5"><div id="progress-bar" class="accent-progress h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                                    <p id="progress-text" class="text-center text-sm text-slate-500 mt-2"></p>
                                </div>
                            </div>
                        </div>
                        <div id="expenses-tab" class="hidden bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h2 class="text-lg font-bold mb-4">Historial de Gastos</h2>
                            <div class="max-h-[500px] overflow-y-auto pr-2">
                                <ul id="expense-list" class="space-y-3"></ul>
                                <p id="no-expenses-message" class="text-center text-slate-500 py-8">Aún no has registrado ningún gasto.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal para crear/editar presupuesto -->
    <div id="budget-modal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-2xl transform transition-all">
            <h2 class="text-2xl font-bold text-center mb-6" id="modal-title">Nuevo Presupuesto</h2>
            <form id="budget-form" class="space-y-4">
                <input type="hidden" id="budget-id">
                <input type="text" id="budget-name" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none accent-outline" placeholder="Nombre del Presupuesto" required>
                <input type="number" id="budget-amount" min="1" step="0.01" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none accent-outline" placeholder="Monto Total" required>
                <select id="budget-period" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none accent-outline bg-white">
                    <option value="Semanal">Semanal</option><option value="Quincenal">Quincenal</option><option value="Mensual" selected>Mensual</option><option value="Anual">Anual</option>
                </select>
                <div class="flex items-center justify-between">
                     <label for="budget-color" class="font-medium text-slate-700">Color de la etiqueta:</label>
                     <input type="color" id="budget-color" value="#3b82f6" class="w-16 h-10 p-1 border border-slate-300 rounded-lg cursor-pointer">
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="button" id="cancel-budget-btn" class="w-full bg-slate-200 text-slate-800 font-bold py-3 px-4 rounded-lg hover:bg-slate-300 transition-all">Cancelar</button>
                    <button type="submit" class="w-full primary-accent-button text-white font-bold py-3 px-4 rounded-lg transition-all">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de confirmación para eliminar -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white w-full max-w-sm p-8 rounded-2xl shadow-2xl transform transition-all text-center">
            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
            </div>
            <h3 class="text-lg leading-6 font-bold text-gray-900 mt-4" id="modal-title-notification">
                Eliminar Presupuesto
            </h3>
            <div class="mt-2">
                <p class="text-sm text-gray-500">
                    ¿Estás seguro de que quieres eliminar este presupuesto? Se borrarán todos los gastos asociados. Esta acción no se puede deshacer.
                </p>
            </div>
            <div class="mt-6 flex gap-4">
                <button type="button" id="cancel-delete-btn" class="w-full bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 transition-all">
                    Cancelar
                </button>
                <button type="button" id="confirm-delete-btn" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-all">
                    Sí, eliminar
                </button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ELEMENTOS DEL DOM ---
        const mainTitle = document.getElementById('main-title');
        const managerView = document.getElementById('manager-view');
        const dashboardView = document.getElementById('dashboard-view');
        const budgetsList = document.getElementById('budgets-list');
        const noBudgetsMessage = document.getElementById('no-budgets-message');
        const backToManagerBtn = document.getElementById('back-to-manager-btn');
        const budgetModal = document.getElementById('budget-modal');
        const budgetForm = document.getElementById('budget-form');
        const expenseForm = document.getElementById('expense-form');
        const tabsNav = document.getElementById('tabs-nav');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        
        // --- ESTADO DE LA APLICACIÓN ---
        let state = {
            budgets: [],
            activeBudgetId: null,
            currentView: 'manager',
            activeTab: 'dashboard',
            budgetIdToDelete: null,
        };

        // --- FUNCIONES DE LÓGICA Y ESTADO ---
        const saveState = () => localStorage.setItem('multiBudgetState', JSON.stringify(state));
        const loadState = () => {
            const savedState = localStorage.getItem('multiBudgetState');
            if (savedState) state = JSON.parse(savedState);
        };
        const getActiveBudget = () => state.budgets.find(b => b.id === state.activeBudgetId);
        const formatCurrency = amount => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(amount);

        // --- FUNCIONES DE RENDERIZADO ---
        const render = () => {
            if (state.currentView === 'manager') {
                mainTitle.textContent = "Mis Presupuestos | Calculadora";
                managerView.classList.remove('hidden');
                dashboardView.classList.add('hidden');
                backToManagerBtn.classList.add('hidden');
                renderManagerView();
            } else {
                dashboardView.classList.remove('hidden');
                managerView.classList.add('hidden');
                backToManagerBtn.classList.remove('hidden');
                renderDashboardView();
            }
            saveState();
        };

        const renderManagerView = () => {
            budgetsList.innerHTML = '';
            if (state.budgets.length === 0) {
                noBudgetsMessage.classList.remove('hidden');
                budgetsList.classList.add('hidden');
            } else {
                noBudgetsMessage.classList.add('hidden');
                budgetsList.classList.remove('hidden');
                state.budgets.forEach(budget => {
                    const spent = budget.expenses.reduce((sum, exp) => sum + exp.amount, 0);
                    const percentage = budget.amount > 0 ? (spent / budget.amount) * 100 : 0;
                    const periodBadgeClass = budget.period === 'Anual'
                        ? 'bg-purple-100 text-purple-700'
                        : 'accent-badge';

                    const card = document.createElement('div');
                    card.className = 'bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-between fade-in overflow-hidden';
                    card.style.borderTop = `5px solid ${budget.color || '#3b82f6'}`;

                    card.innerHTML = `
                        <div>
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-lg mb-1">${budget.name}</h3>
                                <span class="text-xs font-semibold ${periodBadgeClass} px-2 py-1 rounded-full">${budget.period}</span>
                            </div>
                            <p class="text-slate-500 mb-4">Total: ${formatCurrency(budget.amount)}</p>
                            <div class="w-full bg-slate-200 rounded-full h-2 my-2">
                                <div class="h-2 rounded-full" style="width: ${Math.min(percentage, 100)}%; background-color: ${budget.color || '#3b82f6'};"></div>
                            </div>
                            <div class="flex justify-between text-sm text-slate-600">
                                <span>Gastado: ${formatCurrency(spent)}</span>
                                <span>${percentage.toFixed(1)}%</span>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-6">
                            <button data-id="${budget.id}" class="view-budget-btn w-full text-center primary-accent-button text-white px-3 py-2 rounded-lg text-sm font-semibold transition-colors">Gestionar</button>
                            <button data-id="${budget.id}" class="delete-budget-btn bg-slate-200 text-slate-600 px-3 py-2 rounded-lg hover:bg-red-100 hover:text-red-600 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </div>
                    `;
                    budgetsList.appendChild(card);
                });
            }
        };

        const renderDashboardView = () => {
            const budget = getActiveBudget();
            if (!budget) {
                state.currentView = 'manager';
                render();
                return;
            }
            mainTitle.textContent = budget.name;
            renderSummary();
            renderExpensesList();
            renderTabs();
        };

        const renderSummary = () => {
            const budget = getActiveBudget();
            const spent = budget.expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const remaining = budget.amount - spent;
            const percentage = budget.amount > 0 ? (spent / budget.amount) * 100 : 0;

            document.getElementById('budget-title-summary').textContent = budget.name;
            document.getElementById('budget-period-summary').textContent = `Presupuesto ${budget.period}`;
            document.getElementById('summary-total').textContent = formatCurrency(budget.amount);
            document.getElementById('summary-spent').textContent = formatCurrency(spent);
            document.getElementById('summary-remaining').textContent = formatCurrency(remaining);
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = `${Math.min(percentage, 100)}%`;
            progressBar.style.backgroundColor = budget.color || '#3b82f6';
            
            document.getElementById('progress-text').textContent = `${percentage.toFixed(2)}% gastado`;
        };

        const renderExpensesList = () => {
            const budget = getActiveBudget();
            const expenseList = document.getElementById('expense-list');
            const noExpensesMsg = document.getElementById('no-expenses-message');
            expenseList.innerHTML = '';

            if (budget.expenses.length === 0) {
                noExpensesMsg.classList.remove('hidden');
            } else {
                noExpensesMsg.classList.add('hidden');
                [...budget.expenses].reverse().forEach(exp => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200';
                    li.innerHTML = `
                        <div>
                            <p class="font-medium">${exp.name}</p>
                            <p class="text-sm text-slate-500">${new Date(exp.id).toLocaleString('es-MX')}</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="font-semibold text-red-500">${formatCurrency(exp.amount)}</span>
                            <button data-id="${exp.id}" class="delete-expense-btn text-slate-400 hover:text-red-600 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </div>`;
                    expenseList.appendChild(li);
                });
            }
        };
        
        const renderTabs = () => {
            document.querySelectorAll('#tabs-nav button').forEach(btn => btn.classList.remove('tab-active'));
            document.querySelector(`#tabs-nav button[data-tab="${state.activeTab}"]`).classList.add('tab-active');
            
            document.querySelectorAll('#tabs-content > div').forEach(content => content.classList.add('hidden'));
            document.getElementById(`${state.activeTab}-tab`).classList.remove('hidden');
        };

        // --- MANEJADORES DE EVENTOS ---
        const openBudgetModal = () => {
            budgetForm.reset();
            const accentSolid = getComputedStyle(document.documentElement).getPropertyValue('--color-accent-solid').trim();
            document.getElementById('budget-color').value = accentSolid && accentSolid.startsWith('#') ? accentSolid : '#3b82f6';
            document.getElementById('budget-id').value = '';
            budgetModal.classList.remove('hidden');
            budgetModal.classList.add('flex');
        };
        const closeBudgetModal = () => budgetModal.classList.add('hidden');
        const openConfirmModal = (id) => {
            state.budgetIdToDelete = id;
            confirmModal.classList.remove('hidden');
        };
        const closeConfirmModal = () => {
            state.budgetIdToDelete = null;
            confirmModal.classList.add('hidden');
        };

        document.getElementById('add-new-budget-btn').addEventListener('click', openBudgetModal);
        document.getElementById('create-first-budget-btn').addEventListener('click', openBudgetModal);
        document.getElementById('cancel-budget-btn').addEventListener('click', closeBudgetModal);
        cancelDeleteBtn.addEventListener('click', closeConfirmModal);

        
        budgetForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newBudget = {
                id: Date.now(),
                name: document.getElementById('budget-name').value.trim(),
                amount: parseFloat(document.getElementById('budget-amount').value),
                period: document.getElementById('budget-period').value,
                expenses: [],
                color: document.getElementById('budget-color').value
            };
            state.budgets.push(newBudget);
            closeBudgetModal();
            render();
        });

        expenseForm.addEventListener('submit', e => {
            e.preventDefault();
            const budget = getActiveBudget();
            if (!budget) return;
            
            const newExpense = {
                id: Date.now(),
                name: document.getElementById('expense-name').value.trim(),
                amount: parseFloat(document.getElementById('expense-amount').value)
            };

            if (newExpense.name && newExpense.amount > 0) {
                budget.expenses.push(newExpense);
                renderDashboardView();
                saveState();
                expenseForm.reset();
            }
        });

        budgetsList.addEventListener('click', e => {
            const viewBtn = e.target.closest('.view-budget-btn');
            const deleteBtn = e.target.closest('.delete-budget-btn');

            if (viewBtn) {
                state.activeBudgetId = parseInt(viewBtn.dataset.id);
                state.currentView = 'dashboard';
                state.activeTab = 'dashboard';
                render();
            }
            if (deleteBtn) {
                const budgetId = parseInt(deleteBtn.dataset.id);
                openConfirmModal(budgetId);
            }
        });

        confirmDeleteBtn.addEventListener('click', () => {
            if (state.budgetIdToDelete !== null) {
                state.budgets = state.budgets.filter(b => b.id !== state.budgetIdToDelete);
                if(state.activeBudgetId === state.budgetIdToDelete) {
                    state.activeBudgetId = null;
                    state.currentView = 'manager';
                }
                closeConfirmModal();
                render();
            }
        });
        
        backToManagerBtn.addEventListener('click', () => {
            state.currentView = 'manager';
            state.activeBudgetId = null;
            render();
        });

        tabsNav.addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') {
                state.activeTab = e.target.dataset.tab;
                renderTabs();
            }
        });

        document.getElementById('expense-list').addEventListener('click', e => {
            const deleteBtn = e.target.closest('.delete-expense-btn');
            if(deleteBtn) {
                const budget = getActiveBudget();
                const expenseId = parseInt(deleteBtn.dataset.id);
                budget.expenses = budget.expenses.filter(exp => exp.id !== expenseId);
                renderDashboardView();
                saveState();
            }
        });

        // --- INICIALIZACIÓN ---
        loadState();
        render();
    });
    </script>

</body>
</html>

