<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="stylesheet" href="estilos.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backtesting - Registrar Trade</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="Logo_app_trading-removebg-preview.png">
    <link rel="icon" type="image/png" sizes="512x512" href="Logo_app_trading-removebg-preview.png">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Registrar Trade</h1>
            <div class="account-switcher">
                <label for="account-select">Cuenta:</label>
                <select id="account-select"></select>
                <button type="button" id="add-account-btn" class="nav-btn">Nueva cuenta</button>
                <span id="active-account-name" class="account-name"></span>
            </div>
            <div id="datetime" class="datetime"></div>
        </div>

        <form id="tradeForm">
            <div class="form-group">
                <label for="asset">Símbolo:</label>
                <select id="asset" required>
                    <optgroup label="Forex">
                        <option value="EURUSD" data-market="forex">EUR/USD</option>
                        <option value="GBPUSD" data-market="forex">GBP/USD</option>
                        <option value="USDJPY" data-market="forex">USD/JPY</option>
                        <option value="AUDUSD" data-market="forex">AUD/USD</option>
                        <option value="USDCAD" data-market="forex">USD/CAD</option>
                        <option value="NZDUSD" data-market="forex">NZD/USD</option>
                        <option value="USDCHF" data-market="forex">USD/CHF</option>
                        <option value="EURGBP" data-market="forex">EUR/GBP</option>
                        <option value="EURJPY" data-market="forex">EUR/JPY</option>
                        <option value="GBPJPY" data-market="forex">GBP/JPY</option>
                        <option value="USDMXN" data-market="forex">USD/MXN</option>
                        <option value="EURMXN" data-market="forex">EUR/MXN</option>
                        <option value="EURCHF" data-market="forex">EUR/CHF</option>
                        <option value="AUDJPY" data-market="forex">AUD/JPY</option>
                        <option value="AUDNZD" data-market="forex">AUD/NZD</option>
                        <option value="AUDCAD" data-market="forex">AUD/CAD</option>
                        <option value="AUDCHF" data-market="forex">AUD/CHF</option>
                        <option value="CADCHF" data-market="forex">CAD/CHF</option>
                        <option value="CADJPY" data-market="forex">CAD/JPY</option>
                        <option value="CHFJPY" data-market="forex">CHF/JPY</option>
                        <option value="EURAUD" data-market="forex">EUR/AUD</option>
                        <option value="EURCAD" data-market="forex">EUR/CAD</option>
                        <option value="EURNZD" data-market="forex">EUR/NZD</option>
                        <option value="GBPAUD" data-market="forex">GBP/AUD</option>
                        <option value="GBPCAD" data-market="forex">GBP/CAD</option>
                        <option value="GBPNZD" data-market="forex">GBP/NZD</option>
                        <option value="NZDCAD" data-market="forex">NZD/CAD</option>
                        <option value="NZDCHF" data-market="forex">NZD/CHF</option>
                        <option value="NZDJPY" data-market="forex">NZD/JPY</option>
                    </optgroup>
                    <optgroup label="Criptomonedas">
                        <option value="BTCUSDT" data-market="crypto">BTC/USDT</option>
                        <option value="ETHUSDT" data-market="crypto">ETH/USDT</option>
                        <option value="BNBUSDT" data-market="crypto">BNB/USDT</option>
                        <option value="SOLUSDT" data-market="crypto">SOL/USDT</option>
                        <option value="ADAUSDT" data-market="crypto">ADA/USDT</option>
                        <option value="XRPUSDT" data-market="crypto">XRP/USDT</option>
                        <option value="DOGEUSDT" data-market="crypto">DOGE/USDT</option>
                        <option value="DOTUSDT" data-market="crypto">DOT/USDT</option>
                        <option value="MATICUSDT" data-market="crypto">MATIC/USDT</option>
                        <option value="LTCUSDT" data-market="crypto">LTC/USDT</option>
                    </optgroup>
                </select>
            </div>

            <div class="form-group">
                <label for="openTime">Fecha de Apertura:</label>
                <input type="datetime-local" id="openTime" required>
            </div>

            <div class="form-group">
                <label for="closeTime">Fecha de Cierre:</label>
                <input type="datetime-local" id="closeTime" required>
            </div>

            <div class="form-group">
                <label for="direction">Dirección:</label>
                <select id="direction" required>
                    <option value="long">Compra</option>
                    <option value="short">Venta</option>
                </select>
            </div>

            <div class="form-group">
                <label for="openPrice">Precio de Entrada:</label>
                <input type="number" id="openPrice" step="0.000001" required>
            </div>

            <div class="form-group">
                <label for="closePrice">Precio de Salida:</label>
                <input type="number" id="closePrice" step="0.000001" required>
            </div>

            <div class="form-group">
                <label for="lots">Tamaño (Lotes):</label>
                <input type="number" id="lots" step="0.001" min="0.001" required>
            </div>

            <div class="form-group">
                <label for="resultMxn">Resultado (MXN):</label>
                <input type="number" id="resultMxn" step="0.01" required>
            </div>

            <div class="form-group" id="resultMetricGroup">
                <label for="pips" id="resultMetricLabel">Resultado (Pips):</label>
                <input type="number" id="pips" name="pips" step="0.001" min="-999.999" max="999.999" pattern="^-?\d{1,3}(\.\d{1,3})?$" required placeholder="Ej: 25.500 o -12.345">
                <input type="hidden" id="resultMetricType" value="pips">
            </div>

            <div class="form-group">
                <label for="strategy">Estrategia:</label>
                <select id="strategy" required data-strategy-select="true" data-strategy-placeholder="Selecciona una estrategia">
                </select>
            </div>

            <div class="form-group">
                <label for="notes">Notas:</label>
                <textarea id="notes" rows="4" maxlength="234"></textarea>
                <div id="notesCounter" style="text-align:right; font-size:0.9em; color:#666;">234 caracteres restantes</div>
            </div>

            <div class="navigation-buttons">
                <button type="submit" class="nav-btn">Guardar Trade</button>
                <button type="button" class="nav-btn" onclick="window.location.href='index.html'">Volver al Inicio</button>
            </div>
        </form>
    </div>

    <script src="javascript.js"></script>
    <script>
        // Función para obtener una cookie
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // Cargar tema guardado
        function loadTheme() {
            const theme = getCookie('theme') || 'light';
            document.body.className = theme;
        }

        // Actualizar fecha y hora
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('datetime').textContent = now.toLocaleDateString('es-ES', options);
        }

        function updateResultMetricUI() {
            const assetSelect = document.getElementById('asset');
            if (!assetSelect) return;
            const selectedOption = assetSelect.options[assetSelect.selectedIndex];
            const market = selectedOption ? selectedOption.dataset.market : 'forex';
            const label = document.getElementById('resultMetricLabel');
            const input = document.getElementById('pips');
            const typeInput = document.getElementById('resultMetricType');
            if (!label || !input || !typeInput) return;
            if (market === 'crypto') {
                label.textContent = 'Resultado (%)';
                input.placeholder = 'Ej: 2.50 o -1.25';
                input.step = '0.01';
                input.min = '-1000';
                input.max = '1000';
                input.pattern = '^-?\\d{1,4}(\\.\\d{1,2})?$';
                typeInput.value = 'percent';
            } else {
                label.textContent = 'Resultado (Pips):';
                input.placeholder = 'Ej: 25.500 o -12.345';
                input.step = '0.001';
                input.min = '-999.999';
                input.max = '999.999';
                input.pattern = '^-?\\d{1,3}(\\.\\d{1,3})?$';
                typeInput.value = 'pips';
            }
        }

        const assetSelect = document.getElementById('asset');
        if (assetSelect) {
            assetSelect.addEventListener('change', function() {
                updateResultMetricUI();
                const metricInput = document.getElementById('pips');
                if (metricInput) metricInput.value = '';
            });
            updateResultMetricUI();
        }

        // Event listener para el formulario
        document.getElementById('tradeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addTrade();
            // Limpiar todos los campos, incluyendo pips
            if (typeof clearForm === 'function') {
                clearForm();
            } else {
                document.getElementById('pips').value = '';
            }
        });

        // Cargar tema y actualizar fecha/hora al iniciar
        loadTheme();
        setInterval(updateDateTime, 1000);
        updateDateTime();

        // Contador de caracteres para notas
        const notes = document.getElementById('notes');
        const notesCounter = document.getElementById('notesCounter');
        const maxNotesLength = 234;
        notes.addEventListener('input', function() {
            const remaining = maxNotesLength - notes.value.length;
            notesCounter.textContent = `${remaining} caracteres restantes`;
        });
    </script>
</body>
</html>
