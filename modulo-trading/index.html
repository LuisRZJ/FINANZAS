<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diario Trading Forex - Inicio</title>
    
    <!-- Tailwind CSS CDN -->
    <script>
        (function () {
            const match = document.cookie.match(/(?:^|;\s*)theme=([^;]+)/);
            if (match && decodeURIComponent(match[1]) === 'dark') document.documentElement.classList.add('dark');
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' };
        if (typeof tailwind !== 'undefined' && typeof tailwind.refresh === 'function') tailwind.refresh();
    </script>
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Manifest and Icons -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="Logo_app_trading-removebg-preview.png">
    <link rel="icon" type="image/png" sizes="512x512" href="Logo_app_trading-removebg-preview.png">
    
    <!-- Cache Control -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <style>
        /* Estilos base y para el menú, integrados con la lógica JS existente */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Clases para controlar la visibilidad del menú lateral sin modificar el JS */
        .nav-menu.visible {
            transform: translateX(0);
        }
        .menu-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        body.menu-open {
            position: fixed;
            width: 100%;
            overflow: hidden;
        }
        
        /* Estilos para el collapsible de Ayuda ROI */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        /* Estilo para ocultar el botón del menú cuando el menú está abierto */
        .menu-toggle.opened {
            transform: translateX(-150%);
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
        }
    </style>
</head>

<body class="bg-orange-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- Botón del Menú Hamburguesa -->
    <button class="menu-toggle fixed z-50 top-4 left-4 w-12 h-12 bg-white dark:bg-gray-800 rounded-full shadow-lg flex items-center justify-center text-2xl text-gray-700 dark:text-gray-300 transition-all duration-300 ease-in-out" onclick="toggleMenu()">
        ☰
    </button>
    
    <!-- Overlay del Menú -->
    <div class="menu-overlay fixed inset-0 bg-black bg-opacity-50 z-30 opacity-0 pointer-events-none transition-opacity duration-300"></div>

    <!-- Menú de Navegación Lateral -->
    <nav class="nav-menu fixed top-0 left-0 h-full w-72 bg-white/80 dark:bg-gray-800/80 backdrop-blur-md shadow-xl z-40 transform -translate-x-full transition-transform duration-300 ease-in-out">
        <div class="p-4">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Menú</h2>
                <!-- Botón de Cierre (dentro del menú) -->
                <button class="w-10 h-10 flex items-center justify-center text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition-colors" onclick="toggleMenu()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="menu-items space-y-2">
                <a href="index.html" class="flex items-center gap-3 py-2.5 px-4 rounded-lg font-medium transition duration-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    <span>Inicio</span>
                </a>
                <a href="/index.html" class="flex items-center gap-3 py-2.5 px-4 rounded-lg font-medium transition duration-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>
                    <span>Volver al panel de control</span>
                </a>
                <a href="registrar-trade.html" class="flex items-center gap-3 py-2.5 px-4 rounded-lg font-medium transition duration-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>
                    <span>Registrar Trade</span>
                </a>
                <a href="diario.html" class="flex items-center gap-3 py-2.5 px-4 rounded-lg font-medium transition duration-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                    <span>Diario</span>
                </a>
                <a href="estadisticas.html" class="flex items-center gap-3 py-2.5 px-4 rounded-lg font-medium transition duration-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>
                    <span>Estadísticas</span>
                </a>
                <a href="plan-trading.html" class="flex items-center gap-3 py-2.5 px-4 rounded-lg font-medium transition duration-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                    <span>Plan de Trading</span>
                </a>
                <a href="almacenamiento.html" class="flex items-center gap-3 py-2.5 px-4 rounded-lg font-medium transition duration-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>
                    <span>Almacenamiento</span>
                </a>
                <a href="ajustes.html" class="flex items-center gap-3 py-2.5 px-4 rounded-lg font-medium transition duration-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                    <span>Ajustes</span>
                </a>
                <a href="deposito-retiro.html" class="flex items-center gap-3 py-2.5 px-4 rounded-lg font-medium transition duration-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3 4 7l4 4"/><path d="M4 7h16"/><path d="m16 21 4-4-4-4"/><path d="M20 17H4"/></svg>
                    <span>Deposito/Retiro</span>
                </a>
                <a href="gestor-cuentas.html" class="flex items-center gap-3 py-2.5 px-4 rounded-lg font-medium transition duration-200 hover:bg-gray-100 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    <span>Gestor de Cuentas</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 pt-24">
        <!-- Encabezado -->
        <header class="mb-8">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <h1 class="text-4xl font-bold text-gray-900 dark:text-white">Diario Trading</h1>
                <div id="datetime" class="text-sm text-gray-500 dark:text-gray-400"></div>
            </div>
             <div class="account-switcher mt-4 flex flex-wrap items-center gap-2">
                <label for="account-select" class="text-sm font-medium">Cuenta:</label>
                <select id="account-select" class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500"></select>
                <label for="view-mode-select" class="text-sm font-medium">Vista:</label>
                <select id="view-mode-select" class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                    <option value="active">Cuenta activa</option>
                    <option value="all">Todas las cuentas</option>
                </select>
                <button type="button" id="add-account-btn" class="nav-btn px-4 py-2 bg-orange-600 text-white rounded-lg text-sm font-semibold hover:bg-orange-700 transition">Nueva cuenta</button>
                <button type="button" class="nav-btn secondary px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg text-sm font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition" onclick="window.location.href='gestor-cuentas.html'">Gestionar</button>
                <span id="active-account-name" class="account-name ml-2 font-semibold"></span>
            </div>
        </header>

        <!-- Contenedor Principal de Tarjetas y Resúmenes -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Columna Izquierda -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Tarjeta de Saldo Actual -->
                <div class="main-balance-card bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md">
                    <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-300 mb-2">Saldo Actual de la Cuenta</h3>
                    <div class="final-balance">
                        <span id="final-account-balance" class="text-5xl font-bold text-gray-900 dark:text-white">$0.00</span>
                    </div>
                </div>

                <!-- Tarjeta de Evolución de Capital -->
                <div class="capital-evolution-card modern-card bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md">
                    <div class="capital-header mb-4">
                        <h2 id="welcome-message" class="text-2xl font-bold text-gray-900 dark:text-white">Hola, Usuario</h2>
                        <div class="text-3xl font-bold text-gray-800 dark:text-gray-100 mt-1" id="capital-balance">$0.00</div>
                        <span id="capital-roi" class="text-sm font-medium text-green-500"></span>
                    </div>
                    <div class="period-filters integrated flex space-x-2 border-b border-gray-200 dark:border-gray-700 mb-4">
                        <button class="period-filter py-2 px-3 text-sm font-medium text-gray-500 dark:text-gray-400 border-b-2 border-transparent hover:text-orange-600 dark:hover:text-orange-400 hover:border-orange-600" data-period="weekly">Semanal</button>
                        <button class="period-filter py-2 px-3 text-sm font-medium text-gray-500 dark:text-gray-400 border-b-2 border-transparent hover:text-orange-600 dark:hover:text-orange-400 hover:border-orange-600" data-period="monthly">Mensual</button>
                        <button class="period-filter py-2 px-3 text-sm font-medium text-gray-500 dark:text-gray-400 border-b-2 border-transparent hover:text-orange-600 dark:hover:text-orange-400 hover:border-orange-600" data-period="yearly">Anual</button>
                    </div>
                    <!-- Ayuda para ROI -->
                    <div class="roi-calculation-hint text-sm">
                        <button class="collapsible-header w-full text-left font-semibold text-gray-700 dark:text-gray-300 flex justify-between items-center py-2">
                            <span>Análisis de Rendimiento y Balance</span>
                            <span class="icon transform transition-transform duration-300">▼</span>
                        </button>
                        <div class="collapsible-content">
                            <div class="mt-2 text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 p-4 rounded-lg space-y-4">
                                <section>
                                    <h4 class="font-bold text-gray-800 dark:text-gray-200 mb-1">Seguimiento Avanzado</h4>
                                    <p>
                                        Para un análisis profesional del rendimiento, te recomendamos el gráfico de evolución en la página de <a href="estadisticas.html" class="text-orange-500 hover:underline font-semibold">Estadísticas</a>. Este gráfico rastrea tu <strong>Equity real</strong> (Balance + Trades + Movimientos) y calcula automáticamente el ROI exacto para cualquier periodo filtrado.
                                    </p>
                                </section>

                                <hr class="border-gray-200 dark:border-gray-600">

                                <section>
                                    <h4 class="font-bold text-gray-800 dark:text-gray-200 mb-1">Cálculo de ROI Manual</h4>
                                    <p>
                                        Si deseas usar la <a href="calculadora-roi.html" class="roi-calculator-link text-orange-500 hover:underline font-semibold">Calculadora de ROI</a>, obtén los valores de este panel:
                                        <br><br>
                                        <strong>Cantidad A (Saldo Inicial):</strong> Resta el 'PNL del periodo' al saldo actual mostrado arriba.
                                        <br>
                                        <strong>Cantidad B (Saldo Final):</strong> Es el saldo actual que visualizas en pantalla.
                                    </p>
                                </section>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha -->
            <div class="lg:col-span-1">
                 <div class="cards-container bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-md">
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-300">Meta <span id="goal-period-text">Mensual</span></h3>
                        <div class="goal-progress mt-3">
                            <div class="flex items-baseline justify-between">
                                 <span class="current-amount text-3xl font-bold text-gray-900 dark:text-white" id="current-amount">$0.00</span>
                                 <div class="text-right">
                                     <span class="separator text-gray-400 dark:text-gray-500">/</span>
                                     <span class="goal-amount text-lg text-gray-500 dark:text-gray-400" id="goal-amount">$0.00</span>
                                 </div>
                            </div>
                            <div class="mt-2 text-right font-bold text-xl text-orange-500" id="progress-percentage">0%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenedor de Resúmenes -->
        <div class="summaries-container mt-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6">
                <!-- Resumen Diario -->
                <div class="daily-summary bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-md">
                    <h2 class="text-lg font-bold mb-3 text-gray-900 dark:text-white">Resumen Diario</h2>
                    <div class="summary-stats space-y-2 text-sm">
                        <div class="stat-item flex justify-between"><span class="stat-label text-gray-500 dark:text-gray-400">Ganadas:</span><span id="winning-trades" class="stat-value font-semibold">0</span></div>
                        <div class="stat-item flex justify-between"><span class="stat-label text-gray-500 dark:text-gray-400">Perdidas:</span><span id="losing-trades" class="stat-value font-semibold">0</span></div>
                        <div class="stat-item flex justify-between"><span class="stat-label text-gray-500 dark:text-gray-400">Empates:</span><span id="breakeven-trades" class="stat-value font-semibold">0</span></div>
                        <div class="stat-item flex justify-between pt-2 border-t border-gray-200 dark:border-gray-700"><span class="stat-label font-bold">PNL:</span><span id="daily-pnl" class="stat-value font-bold">$0.00</span></div>
                    </div>
                </div>

                <!-- Resumen Semanal -->
                <div class="daily-summary weekly-summary bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-md">
                    <h2 class="text-lg font-bold mb-3 text-gray-900 dark:text-white">Resumen Semanal</h2>
                    <div class="summary-stats space-y-2 text-sm">
                        <div class="stat-item flex justify-between"><span class="stat-label text-gray-500 dark:text-gray-400">Ganadas:</span><span id="weekly-winning-trades" class="stat-value font-semibold">0</span></div>
                        <div class="stat-item flex justify-between"><span class="stat-label text-gray-500 dark:text-gray-400">Perdidas:</span><span id="weekly-losing-trades" class="stat-value font-semibold">0</span></div>
                        <div class="stat-item flex justify-between"><span class="stat-label text-gray-500 dark:text-gray-400">Empates:</span><span id="weekly-breakeven-trades" class="stat-value font-semibold">0</span></div>
                        <div class="stat-item flex justify-between pt-2 border-t border-gray-200 dark:border-gray-700"><span class="stat-label font-bold">PNL:</span><span id="weekly-pnl" class="stat-value font-bold">$0.00</span></div>
                    </div>
                </div>

                <!-- Resumen Mensual -->
                <div class="daily-summary monthly-summary bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-md">
                    <h2 class="text-lg font-bold mb-3 text-gray-900 dark:text-white">Resumen Mensual</h2>
                    <div class="summary-stats space-y-2 text-sm">
                        <div class="stat-item flex justify-between"><span class="stat-label text-gray-500 dark:text-gray-400">Ganadas:</span><span id="monthly-winning-trades" class="stat-value font-semibold">0</span></div>
                        <div class="stat-item flex justify-between"><span class="stat-label text-gray-500 dark:text-gray-400">Perdidas:</span><span id="monthly-losing-trades" class="stat-value font-semibold">0</span></div>
                        <div class="stat-item flex justify-between"><span class="stat-label text-gray-500 dark:text-gray-400">Empates:</span><span id="monthly-breakeven-trades" class="stat-value font-semibold">0</span></div>
                        <div class="stat-item flex justify-between pt-2 border-t border-gray-200 dark:border-gray-700"><span class="stat-label font-bold">PNL:</span><span id="monthly-pnl" class="stat-value font-bold">$0.00</span></div>
                    </div>
                </div>

                <!-- Resumen Anual -->
                <div class="daily-summary annual-summary bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-md">
                    <h2 class="text-lg font-bold mb-3 text-gray-900 dark:text-white">Resumen Anual</h2>
                    <div class="summary-stats space-y-2 text-sm">
                        <div class="stat-item flex justify-between"><span class="stat-label text-gray-500 dark:text-gray-400">Ganadas:</span><span id="annual-winning-trades" class="stat-value font-semibold">0</span></div>
                        <div class="stat-item flex justify-between"><span class="stat-label text-gray-500 dark:text-gray-400">Perdidas:</span><span id="annual-losing-trades" class="stat-value font-semibold">0</span></div>
                        <div class="stat-item flex justify-between"><span class="stat-label text-gray-500 dark:text-gray-400">Empates:</span><span id="annual-breakeven-trades" class="stat-value font-semibold">0</span></div>
                        <div class="stat-item flex justify-between pt-2 border-t border-gray-200 dark:border-gray-700"><span class="stat-label font-bold">PNL:</span><span id="annual-pnl" class="stat-value font-bold">$0.00</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="javascript.js"></script>
    <script>
        // --- TODO TU BLOQUE JAVASCRIPT ORIGINAL VA AQUÍ ---
        // Lo he mantenido intacto, solo he añadido una pequeña mejora para
        // el collapsible de "Ayuda ROI" al final.

        // Función para obtener una cookie
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // Actualizar fecha y hora
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('datetime').textContent = now.toLocaleDateString('es-ES', options);
        }
        
        // Actualizar cada segundo
        setInterval(updateDateTime, 1000);
        updateDateTime();

        function safeParseArray(raw) {
            if (!raw) return [];
            try {
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (error) {
                return [];
            }
        }

        function getViewMode() {
            const select = document.getElementById('view-mode-select');
            return select && select.value === 'all' ? 'all' : 'active';
        }

        function getTradingViewData() {
            if (getViewMode() !== 'all') {
                return {
                    trades: safeParseArray(localStorage.getItem('trades')),
                    movements: safeParseArray(localStorage.getItem('capitalMovements')),
                    initialCapital: parseFloat(localStorage.getItem('initialCapital')) || 0
                };
            }

            const accounts = typeof getAccountsMeta === 'function' ? getAccountsMeta() : [];
            const trades = [];
            const movements = [];
            let initialCapital = 0;

            accounts.forEach(account => {
                if (!account || !account.id) return;
                if (typeof readAccountData !== 'function') return;
                const data = readAccountData(account.id);
                if (data && Array.isArray(data.trades)) trades.push(...data.trades);
                if (data && Array.isArray(data.capitalMovements)) movements.push(...data.capitalMovements);
                const cap = data && data.initialCapital !== null && data.initialCapital !== undefined ? parseFloat(data.initialCapital) : 0;
                if (Number.isFinite(cap)) initialCapital += cap;
            });

            return { trades, movements, initialCapital };
        }

        function syncViewModeUI() {
            const mode = getViewMode();
            const accountSelect = document.getElementById('account-select');
            if (accountSelect) {
                accountSelect.disabled = mode === 'all';
                accountSelect.classList.toggle('opacity-60', mode === 'all');
                accountSelect.classList.toggle('cursor-not-allowed', mode === 'all');
            }

            const label = document.getElementById('active-account-name');
            if (label) {
                if (mode === 'all') {
                    label.textContent = 'Todas las cuentas';
                } else if (typeof updateActiveAccountNameDisplay === 'function') {
                    updateActiveAccountNameDisplay();
                }
            }

            const periodButton = document.querySelector('.period-filter.active') || document.querySelector('.period-filter[data-period="monthly"]') || document.querySelector('.period-filter');
            if (periodButton && typeof updateCapitalHeader === 'function') {
                updateCapitalHeader(periodButton.dataset.period);
            }
        }

        // Cargar datos de las tarjetas
        function loadCardData() {
            const viewData = getTradingViewData();
            const trades = viewData.trades;
            const movements = viewData.movements;
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Establecer inicio del día
            
            // Filtrar trades del día actual
            const tradesHoy = trades.filter(trade => {
                const tradeDate = new Date(trade.openTime);
                tradeDate.setHours(0, 0, 0, 0);
                return tradeDate.getTime() === today.getTime();
            });
            
            // Calcular estadísticas del resumen diario
            const winningTrades = tradesHoy.filter(trade => parseFloat(trade.resultMxn) > 0).length;
            const losingTrades = tradesHoy.filter(trade => parseFloat(trade.resultMxn) < 0).length;
            const breakevenTrades = tradesHoy.filter(trade => parseFloat(trade.resultMxn) === 0).length;
            const dailyPnl = tradesHoy.reduce((sum, trade) => sum + parseFloat(trade.resultMxn), 0);

            // Actualizar el resumen diario
            document.getElementById('winning-trades').textContent = winningTrades;
            document.getElementById('losing-trades').textContent = losingTrades;
            document.getElementById('breakeven-trades').textContent = breakevenTrades;
            
            const dailyPnlElement = document.getElementById('daily-pnl');
            dailyPnlElement.textContent = `$${dailyPnl.toFixed(2)}`;
            dailyPnlElement.style.color = dailyPnl >= 0 ? '#2ecc71' : '#e74c3c';

            // Calcular estadísticas semanales
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay()); // Inicio de la semana (domingo)
            startOfWeek.setHours(0, 0, 0, 0);

            const tradesSemana = trades.filter(trade => {
                const tradeDate = new Date(trade.openTime);
                tradeDate.setHours(0, 0, 0, 0);
                return tradeDate >= startOfWeek && tradeDate <= today;
            });

            // Calcular estadísticas del resumen semanal
            const weeklyWinningTrades = tradesSemana.filter(trade => parseFloat(trade.resultMxn) > 0).length;
            const weeklyLosingTrades = tradesSemana.filter(trade => parseFloat(trade.resultMxn) < 0).length;
            const weeklyBreakevenTrades = tradesSemana.filter(trade => parseFloat(trade.resultMxn) === 0).length;
            const weeklyPnl = tradesSemana.reduce((sum, trade) => sum + parseFloat(trade.resultMxn), 0);

            // Actualizar el resumen semanal
            document.getElementById('weekly-winning-trades').textContent = weeklyWinningTrades;
            document.getElementById('weekly-losing-trades').textContent = weeklyLosingTrades;
            document.getElementById('weekly-breakeven-trades').textContent = weeklyBreakevenTrades;
            
            const weeklyPnlElement = document.getElementById('weekly-pnl');
            weeklyPnlElement.textContent = `$${weeklyPnl.toFixed(2)}`;
            weeklyPnlElement.style.color = weeklyPnl >= 0 ? '#2ecc71' : '#e74c3c';

            // Calcular estadísticas mensuales
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            startOfMonth.setHours(0, 0, 0, 0);

            const tradesMes = trades.filter(trade => {
                const tradeDate = new Date(trade.openTime);
                tradeDate.setHours(0, 0, 0, 0);
                return tradeDate >= startOfMonth && tradeDate <= today;
            });

            // Calcular estadísticas del resumen mensual
            const monthlyWinningTrades = tradesMes.filter(trade => parseFloat(trade.resultMxn) > 0).length;
            const monthlyLosingTrades = tradesMes.filter(trade => parseFloat(trade.resultMxn) < 0).length;
            const monthlyBreakevenTrades = tradesMes.filter(trade => parseFloat(trade.resultMxn) === 0).length;
            const monthlyPnl = tradesMes.reduce((sum, trade) => sum + parseFloat(trade.resultMxn), 0);

            // Actualizar el resumen mensual
            document.getElementById('monthly-winning-trades').textContent = monthlyWinningTrades;
            document.getElementById('monthly-losing-trades').textContent = monthlyLosingTrades;
            document.getElementById('monthly-breakeven-trades').textContent = monthlyBreakevenTrades;
            
            const monthlyPnlElement = document.getElementById('monthly-pnl');
            monthlyPnlElement.textContent = `$${monthlyPnl.toFixed(2)}`;
            monthlyPnlElement.style.color = monthlyPnl >= 0 ? '#2ecc71' : '#e74c3c';

            // Calcular estadísticas anuales
            const startOfYear = new Date(today.getFullYear(), 0, 1);
            startOfYear.setHours(0, 0, 0, 0);

            const tradesAnio = trades.filter(trade => {
                const tradeDate = new Date(trade.openTime);
                tradeDate.setHours(0, 0, 0, 0);
                return tradeDate >= startOfYear && tradeDate <= today;
            });

            // Calcular estadísticas del resumen anual
            const annualWinningTrades = tradesAnio.filter(trade => parseFloat(trade.resultMxn) > 0).length;
            const annualLosingTrades = tradesAnio.filter(trade => parseFloat(trade.resultMxn) < 0).length;
            const annualBreakevenTrades = tradesAnio.filter(trade => parseFloat(trade.resultMxn) === 0).length;
            const annualPnl = tradesAnio.reduce((sum, trade) => sum + parseFloat(trade.resultMxn), 0);

            // Actualizar el resumen anual
            document.getElementById('annual-winning-trades').textContent = annualWinningTrades;
            document.getElementById('annual-losing-trades').textContent = annualLosingTrades;
            document.getElementById('annual-breakeven-trades').textContent = annualBreakevenTrades;
            const annualPnlElement = document.getElementById('annual-pnl');
            annualPnlElement.textContent = `$${annualPnl.toFixed(2)}`;
            annualPnlElement.style.color = annualPnl >= 0 ? '#2e7d32' : '#e74c3c';

            // Cargar meta y período desde cookies
            const monthlyGoal = getCookie('monthlyGoal') || '10000';
            const goalPeriod = getCookie('goalPeriod') || 'monthly';
            
            // Actualizar el texto del período
            const periodTexts = {
                'daily': 'Diaria',
                'weekly': 'Semanal',
                'monthly': 'Mensual',
                'yearly': 'Anual'
            };
            document.getElementById('goal-period-text').textContent = periodTexts[goalPeriod] || 'Mensual';
            
            // Calcular el PNL para el período seleccionado
            let periodStart;
            switch(goalPeriod) {
                case 'daily':
                    periodStart = new Date(new Date().setHours(0, 0, 0, 0));
                    break;
                case 'weekly':
                    const firstDayOfWeek = new Date();
                    firstDayOfWeek.setDate(today.getDate() - today.getDay());
                    periodStart = new Date(firstDayOfWeek.setHours(0,0,0,0));
                    break;
                case 'monthly':
                    periodStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
                case 'yearly':
                    periodStart = new Date(today.getFullYear(), 0, 1);
                    break;
                default:
                    periodStart = new Date(today.getFullYear(), today.getMonth(), 1);
            }

            const periodPNL = trades
                .filter(trade => new Date(trade.openTime) >= periodStart)
                .reduce((sum, trade) => sum + parseFloat(trade.resultMxn), 0);

            // Actualizar la visualización del progreso
            const goalAmount = parseFloat(monthlyGoal);
            const progressPercentage = goalAmount > 0 ? (periodPNL / goalAmount) * 100 : 0;
            
            // Actualizar elementos con los valores calculados
            const currentAmountElement = document.getElementById('current-amount');
            const goalAmountElement = document.getElementById('goal-amount');
            const progressElement = document.getElementById('progress-percentage');

            currentAmountElement.textContent = `$${periodPNL.toFixed(2)}`;
            goalAmountElement.textContent = `$${goalAmount.toFixed(2)}`;
            progressElement.textContent = `${progressPercentage.toFixed(1)}%`;

            // Aplicar colores según el progreso
            currentAmountElement.style.color = periodPNL >= goalAmount ? '#2e7d32' : '#f57c00';
            currentAmountElement.style.fontWeight = 'bold';
            goalAmountElement.style.color = '#2e7d32';
            progressElement.style.color = '#FF6B00';

            // --- Calcular y mostrar Saldo Final --- //
            const initialCapital = viewData.initialCapital;
            const totalMovementsPnl = movements.reduce((sum, movement) => {
                if (movement.type === 'deposito') {
                    return sum + parseFloat(movement.amount);
                } else if (movement.type === 'retiro') {
                    return sum - parseFloat(movement.amount);
                }
                return sum;
            }, 0);
            const totalTradesPnl = trades.reduce((sum, trade) => sum + parseFloat(trade.resultMxn), 0);
            const finalBalance = initialCapital + totalMovementsPnl + totalTradesPnl;

            const finalBalanceElement = document.getElementById('final-account-balance');
            if (finalBalanceElement) {
                finalBalanceElement.textContent = `$${finalBalance.toFixed(2)}`;
                finalBalanceElement.style.color = finalBalance >= initialCapital ? '#2e7d32' : '#e74c3c';
            }
        }

        // Cargar tema guardado
        function loadTheme() {
            const theme = getCookie('theme') || 'light';
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        // Funciones para el menú de navegación
        const navMenu = document.querySelector('.nav-menu');
        const menuToggle = document.querySelector('.menu-toggle');
        const menuOverlay = document.querySelector('.menu-overlay');
        let scrollPosition = 0;

        function toggleMenu() {
            const isVisible = navMenu.classList.contains('visible');
            
            if (!isVisible) {
                scrollPosition = window.pageYOffset;
                document.body.classList.add('menu-open');
                document.body.style.top = `-${scrollPosition}px`;
                menuOverlay.classList.add('visible');
            } else {
                document.body.classList.remove('menu-open');
                document.body.style.top = '';
                window.scrollTo(0, scrollPosition);
                menuOverlay.classList.remove('visible');
            }
            
            navMenu.classList.toggle('visible');
            menuToggle.classList.toggle('opened'); // Oculta/muestra el botón
        }
        
        // Cerrar menú al hacer clic en el overlay
        menuOverlay.addEventListener('click', toggleMenu);


        // Marcar enlace activo según la página actual
        function setActiveLink() {
            const rawPage = window.location.pathname.split('/').pop() || 'index.html';
            const routeAliases = {
                'calculadora-roi.html': 'estadisticas.html',
                'tabla-trades.html': 'diario.html'
            };
            const currentPage = routeAliases[rawPage] || rawPage;
            const links = document.querySelectorAll('.menu-items a');
            
            links.forEach(link => {
                link.classList.remove('active', 'bg-orange-600', 'dark:bg-orange-700', 'text-white');
                link.removeAttribute('aria-current');
                if (link.getAttribute('href') === currentPage) {
                    link.classList.add('active', 'bg-orange-600', 'dark:bg-orange-700', 'text-white');
                    link.setAttribute('aria-current', 'page');
                }
            });
        }
        
        // --- NUEVO CÓDIGO AÑADIDO PARA MEJORAR LA INTERACCIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
             // Lógica para el collapsible de Ayuda ROI
            const collapsibleHeader = document.querySelector('.collapsible-header');
            const collapsibleContent = document.querySelector('.collapsible-content');
            const collapsibleIcon = collapsibleHeader.querySelector('.icon');

            collapsibleHeader.addEventListener('click', () => {
                const isOpen = collapsibleContent.style.maxHeight;
                if (isOpen && isOpen !== "0px") {
                    collapsibleContent.style.maxHeight = "0px";
                    collapsibleIcon.style.transform = "rotate(0deg)";
                } else {
                    collapsibleContent.style.maxHeight = collapsibleContent.scrollHeight + "px";
                    collapsibleIcon.style.transform = "rotate(180deg)";
                }
            });
            
            // Cargar datos al iniciar
            loadTheme();
            loadCardData();
            setActiveLink();

            const viewSelect = document.getElementById('view-mode-select');
            if (viewSelect) {
                viewSelect.value = 'active';
                viewSelect.addEventListener('change', function () {
                    syncViewModeUI();
                    loadCardData();
                });
                syncViewModeUI();
            }
        });
    </script>
</body>
</html>


