<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="stylesheet" href="estilos.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backtesting - Almacenamiento</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="Logo_app_trading-removebg-preview.png">
    <link rel="icon" type="image/png" sizes="512x512" href="Logo_app_trading-removebg-preview.png">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Almacenamiento</h1>
            <div class="account-switcher">
                <label for="account-select">Cuenta:</label>
                <select id="account-select"></select>
                <button type="button" id="add-account-btn" class="nav-btn">Nueva cuenta</button>
                <span id="active-account-name" class="account-name"></span>
            </div>
            <div id="datetime" class="datetime"></div>
        </div>

        <div id="storageContainer" class="stats">
            <!-- El contenido se cargará dinámicamente -->
        </div>

        <div class="form-group">
            <button class="nav-btn" onclick="saveData()">Guardar Datos en Almacenamiento Local</button>
        </div>

        <div class="form-group">
            <button class="nav-btn clear" onclick="clearData()">Eliminar Datos del Almacenamiento Local</button>
        </div>

        <div class="form-group">
            <button class="nav-btn export" onclick="exportTrades()">Exportar Trades</button>
        </div>

        <div class="form-group">
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importTrades(event)">
            <button class="nav-btn import" onclick="document.getElementById('importFile').click()">Importar Trades</button>
        </div>

        <div class="navigation-buttons">
            <button class="nav-btn" onclick="window.location.href='index.html'">Volver al Inicio</button>
        </div>
    </div>

    <script src="javascript.js"></script>
    <script>
        // Función para obtener una cookie (restaurada)
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // Cargar tema guardado (restaurada)
        function loadTheme() {
            const theme = getCookie('theme') || 'light';
            document.body.className = theme;
        }

        // Actualizar fecha y hora (restaurada)
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('datetime').textContent = now.toLocaleDateString('es-ES', options);
        }

        // Funciones de Importar y Exportar Trades (restauradas)
        function importTrades(event) {
            const file = event.target.files[0];
            if (!file) return;

            const maxSize = 4.5 * 1024 * 1024; // 4.5MB para dejar margen
            if (file.size > maxSize) {
                alert('El archivo es demasiado grande. El tamaño máximo permitido es 4.5MB para asegurar compatibilidad con LocalStorage.');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data || typeof data !== 'object') {
                        alert('El archivo no contiene un JSON válido.');
                        event.target.value = '';
                        return;
                    }

                    const payload = {};

                    if (Array.isArray(data.trades)) {
                        const jsonString = JSON.stringify(data.trades);
                        const storageSize = jsonString.length * 2;
                        const storageSizeMB = storageSize / (1024 * 1024);
                        if (storageSizeMB > 4.5) {
                            alert(`Advertencia: El archivo contiene demasiados trades (${data.trades.length}). El tamaño estimado de los trades (${storageSizeMB.toFixed(2)}MB) excede el límite seguro de LocalStorage (4.5MB). Se intentará importar el resto de los datos.`);
                        }
                        payload.trades = data.trades;
                    } else {
                        alert('El archivo no contiene un formato válido de trades o están ausentes. Se limpiarán los trades actuales.');
                        payload.trades = [];
                    }

                    if (data.hasOwnProperty('initialCapital')) {
                        payload.initialCapital = data.initialCapital;
                    } else {
                        payload.initialCapital = null;
                    }

                    if (data.hasOwnProperty('username')) {
                        payload.username = data.username;
                    } else {
                        payload.username = null;
                    }

                    if (Array.isArray(data.capitalMovements)) {
                        payload.capitalMovements = data.capitalMovements;
                    } else {
                        payload.capitalMovements = [];
                    }

                    if (data.hasOwnProperty('capitalStartDate')) {
                        payload.capitalStartDate = data.capitalStartDate;
                    } else {
                        payload.capitalStartDate = null;
                    }

                    if (Array.isArray(data.strategies)) {
                        payload.strategies = data.strategies;
                    }

                    if (confirm('¿Estás seguro de que deseas importar estos datos? Esto reemplazará los datos de la cuenta activa.')) {
                        importDataToActiveAccount(payload);
                        alert('Datos importados exitosamente');
                        renderStorageInfo();
                    } else {
                        alert('Importación cancelada.');
                    }

                } catch (error) {
                    if (error instanceof SyntaxError) {
                        alert('Error: El archivo no es un JSON válido. Por favor, asegúrate de que el archivo fue exportado correctamente desde esta aplicación.');
                    } else {
                        alert('Error al importar los datos: ' + error.message);
                    }
                     // Limpiar el input de archivo en caso de error
                    event.target.value = '';
                }
            };

            reader.onerror = function() {
                alert('Error al leer el archivo. Por favor, intenta nuevamente.');
                event.target.value = '';
            };

            reader.readAsText(file);
        }

        function exportTrades() {
            const exportData = exportActiveAccountData();
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const accountName = exportData.account?.nombre ? exportData.account.nombre.replace(/\s+/g, '_').toLowerCase() : 'cuenta';
            const exportFileDefaultName = `backtest_data_${accountName}_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Función para eliminar todos los datos (restaurada)
        function clearData() {
            if (confirm('¿Estás seguro de que deseas eliminar todos los datos? Esta acción no se puede deshacer.')) {
                clearActiveAccountData();
                alert('Se eliminaron los datos de la cuenta activa');
                renderStorageInfo(); 
            }
        }

        // Función para renderizar la información de almacenamiento (restaurada y modificada)
        function renderStorageInfo() {
            const storageContainer = document.getElementById('storageContainer');
            if (!storageContainer) return;

            const snapshot = getActiveAccountSnapshot();
            const trades = Array.isArray(snapshot.trades) ? snapshot.trades : [];
            const movements = Array.isArray(snapshot.capitalMovements) ? snapshot.capitalMovements : [];
            const strategies = Array.isArray(snapshot.strategies) ? snapshot.strategies : [];
            const customStrategies = strategies.filter(item => !item.builtIn);
            const totalTrades = trades.length;

            const tradesJson = JSON.stringify(trades);
            const tradesStorageBytes = tradesJson.length * 2;
            const tradesStorageKB = (tradesStorageBytes / 1024).toFixed(2);
            const tradesStorageMB = (tradesStorageBytes / (1024 * 1024)).toFixed(4);

            const movementsJson = JSON.stringify(movements);
            const movementsStorageBytes = movementsJson.length * 2;
            const movementsStorageKB = (movementsStorageBytes / 1024).toFixed(2);

            const strategiesJson = JSON.stringify(strategies);
            const strategiesStorageBytes = strategiesJson.length * 2;
            const strategiesStorageKB = (strategiesStorageBytes / 1024).toFixed(2);
            const customStrategiesJson = JSON.stringify(customStrategies);
            const customStrategiesStorageBytes = customStrategiesJson.length * 2;
            const customStrategiesStorageKB = (customStrategiesStorageBytes / 1024).toFixed(2);

            const initialCapital = snapshot.initialCapital !== null && snapshot.initialCapital !== undefined ? String(snapshot.initialCapital) : null;
            const capitalStorageBytes = initialCapital ? initialCapital.length * 2 : 0;
            const capitalStorageKB = (capitalStorageBytes / 1024).toFixed(2);

            const username = snapshot.username !== null && snapshot.username !== undefined ? String(snapshot.username) : null;
            const usernameStorageBytes = username ? username.length * 2 : 0;
            const usernameStorageKB = (usernameStorageBytes / 1024).toFixed(2);

            const totalStorageBytes = tradesStorageBytes + movementsStorageBytes + strategiesStorageBytes + capitalStorageBytes + usernameStorageBytes;
            const totalStorageKB = (totalStorageBytes / 1024).toFixed(2);
            const totalStorageMB = (totalStorageBytes / (1024 * 1024)).toFixed(4);

            const avgSizePerTrade = totalTrades > 0 ? tradesStorageBytes / totalTrades : 0;
            const remainingSpace5MB = 5 * 1024 * 1024 - totalStorageBytes;
            const remainingSpace10MB = 10 * 1024 * 1024 - totalStorageBytes;
            const remainingTrades5MB = avgSizePerTrade > 0 ? Math.max(Math.floor(remainingSpace5MB / avgSizePerTrade), 0) : 0;
            const remainingTrades10MB = avgSizePerTrade > 0 ? Math.max(Math.floor(remainingSpace10MB / avgSizePerTrade), 0) : 0;

            const tradesPerYear = 600;
            const yearsEstimate5MB = remainingTrades5MB > 0 ? Math.floor(remainingTrades5MB / tradesPerYear) : 0;
            const yearsEstimate10MB = remainingTrades10MB > 0 ? Math.floor(remainingTrades10MB / tradesPerYear) : 0;

            storageContainer.innerHTML = `
                <div class="storage-info">
                    <h3>Uso de Almacenamiento</h3>
                    <div class="storage-details">
                        <p>Has registrado un total de ${totalTrades} trades, lo que supone un uso de memoria de ${tradesStorageKB} KB</p>
                        ${initialCapital ? `<p>El capital inicial ocupa ${capitalStorageKB} KB de almacenamiento</p>` : ''}
                        ${username ? `<p>El nombre de usuario ocupa ${usernameStorageKB} KB de almacenamiento</p>` : ''}
                        <p>Tu historial de movimientos ocupa ${movementsStorageKB} KB de almacenamiento</p>
                        <p>Las estrategias guardadas ocupan ${strategiesStorageKB} KB de almacenamiento total</p>
                        <p>Tus estrategias personalizadas (${customStrategies.length}) ocupan ${customStrategiesStorageKB} KB</p>
                        <p class="storage-limit-info">Uso total estimado: ${totalStorageKB} KB (${totalStorageMB} MB)</p>
                        <p class="storage-limit-info">El límite de LocalStorage es aproximadamente 5-10 MB</p>
                    </div>
                    ${totalTrades > 0 && avgSizePerTrade > 0 ? `
                        <div class="storage-limit-info">
                            En base a un límite de 5MB y el tamaño promedio del registro (${(avgSizePerTrade / 1024).toFixed(2)} KB por trade), 
                            se estima que esa capacidad te permita registrar un restante de ${remainingTrades5MB.toLocaleString()} trades.
                        </div>
                        <div class="storage-limit-info">
                            Si el límite fuera de 10MB, podrías registrar aproximadamente ${remainingTrades10MB.toLocaleString()} trades adicionales.
                        </div>
                        <div class="storage-capacity-info">
                            <strong>Capacidad a largo plazo:</strong>
                            <ul>
                                <li>Con el límite de 5MB: Podrías registrar aproximadamente ${yearsEstimate5MB} años más de operaciones (asumiendo 600 trades por año)</li>
                                <li>Con el límite de 10MB: Podrías registrar aproximadamente ${yearsEstimate10MB} años más de operaciones</li>
                            </ul>
                        </div>
                    ` : `<div class="storage-capacity-info"><strong>No hay suficientes datos de trades para estimar la capacidad futura.</strong></div>`}
                </div>
            `;
        }

        // Cargar tema y actualizar fecha/hora al iniciar
        loadTheme();
        setInterval(updateDateTime, 1000);
        updateDateTime();

        // Renderizar la información al cargar la página
        renderStorageInfo();

    </script>
</body>
</html>
