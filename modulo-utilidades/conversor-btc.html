<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Conversor BTC ↔ MXN</title>
  <meta name="theme-color" content="#2563eb">
  <link rel="icon" href="../pwa/logo-app.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #fef5e7 0%, #fde3c4 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    
    .converter-card {
      box-shadow: 0 10px 30px rgba(247, 147, 26, 0.15);
      border-radius: 16px;
      overflow: hidden;
      transition: transform 0.3s ease;
      background: white;
    }
    
    .converter-card:hover {
      transform: translateY(-5px);
    }
    
    .price-display {
      background: linear-gradient(135deg, #f7931a 0%, #ffab2d 100%);
      color: white;
      border-radius: 12px;
    }
    
    input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(247, 147, 26, 0.3);
      border-color: #f7931a;
    }
    
    .btn-convert {
      transition: all 0.3s ease;
    }
    
    .btn-convert:enabled {
      background: linear-gradient(135deg, #f7931a 0%, #ffab2d 100%);
    }
    
    .btn-convert:enabled:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(247, 147, 26, 0.4);
    }
    
    .result-box {
      transition: all 0.3s ease;
      min-height: 64px;
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .input-group {
      position: relative;
    }
    
    .input-icon {
      position: absolute;
      left: 12px;
      top: 38px;
      color: #f7931a;
    }
    
    .mxn-result {
      color: #10b981;
      font-weight: 600;
    }
    
    .bitcoin-icon {
      color: #f7931a;
      margin-right: 8px;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center">

  <div class="w-full max-w-lg p-6 converter-card">
    <header class="mb-6 text-center">
      <h1 class="text-2xl font-bold text-gray-800"><i class="fab fa-btc bitcoin-icon"></i>BTC ↔ MXN — Conversor</h1>
      <p class="text-sm text-gray-600">Interfaz minimalista · actualización automática del precio</p>
      <a href="/utilidades.html" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-orange-500 hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
        <i class="fas fa-arrow-left mr-2"></i> Volver a Utilidades
      </a>
    </header>

    <main class="space-y-5">
      <!-- Precio actual -->
      <div class="text-center py-4 px-3 price-display">
        <div class="text-sm opacity-90">Precio actual BTC</div>
        <div id="btc-price" class="mt-1 text-2xl font-mono font-bold">Cargando...</div>
        <div id="price-update" class="mt-1 text-xs opacity-80">Última actualización: —</div>
      </div>

      <!-- Conversor -->
      <section class="grid gap-4">
        <div class="input-group">
          <i class="fas fa-peso-sign input-icon"></i>
          <label for="mxnInput" class="block text-sm mb-1 ml-1 text-gray-700">MXN</label>
          <input id="mxnInput" inputmode="decimal" type="text" placeholder="Ej. 1,234.56 o 1234,56"
                 class="w-full pl-10 pr-3 py-2 rounded-md bg-white border border-gray-300 focus:border-orange-500">
        </div>

        <div class="input-group">
          <i class="fab fa-btc input-icon"></i>
          <label for="btcInput" class="block text-sm mb-1 ml-1 text-gray-700">BTC</label>
          <input id="btcInput" inputmode="decimal" type="text" placeholder="Ej. 0.001"
                 class="w-full pl-10 pr-3 py-2 rounded-md bg-white border border-gray-300 focus:border-orange-500">
        </div>

        <div class="input-group">
          <i class="fas fa-satellite input-icon"></i>
          <label for="satInput" class="block text-sm mb-1 ml-1 text-gray-700">SATs (satoshis)</label>
          <input id="satInput" inputmode="numeric" type="text" placeholder="Ej. 250000"
                 class="w-full pl-10 pr-3 py-2 rounded-md bg-white border border-gray-300 focus:border-orange-500">
        </div>

        <div class="flex items-center justify-between gap-3">
          <div id="helperMsg" class="text-sm text-gray-600 min-h-[20px]">Ingresa un valor en uno de los campos para habilitar Convertir.</div>
          <button id="convertBtn" disabled class="ml-auto px-4 py-2 rounded-md btn-convert bg-gray-300 text-gray-600 cursor-not-allowed">
            Convertir
          </button>
        </div>

        <div id="resultado" class="min-h-[64px] p-3 rounded-md bg-gray-50 border border-gray-200 font-mono text-sm"></div>
      </section>

      <footer class="text-xs text-center text-gray-500">
        Nota: los resultados usan el precio proporcionado por CoinGecko y se actualizan cada 10 segundos.
      </footer>
    </main>
  </div>

  <script>
    // Estado
    let precioMXN = 0;
    const BTC_TO_SATS = 100000000;

    // Elementos
    const btcPriceEl = document.getElementById('btc-price');
    const priceUpdateEl = document.getElementById('price-update');
    const mxnInput = document.getElementById('mxnInput');
    const btcInput = document.getElementById('btcInput');
    const satInput = document.getElementById('satInput');
    const convertBtn = document.getElementById('convertBtn');
    const resultadoEl = document.getElementById('resultado');
    const helperMsg = document.getElementById('helperMsg');

    // Parseo robusto para entradas con comas/puntos/miles
    function parseNumberSafe(str) {
      if (str === null || str === undefined) return NaN;
      let s = String(str).trim();
      s = s.replace(/\s+/g, '');
      s = s.replace(/[$€£¥]/g, '');
      if (s === '') return NaN;

      const lastDot = s.lastIndexOf('.');
      const lastComma = s.lastIndexOf(',');

      if (lastDot !== -1 && lastComma !== -1) {
        if (lastDot > lastComma) {
          s = s.replace(/,/g, '');
        } else {
          s = s.replace(/\./g, '').replace(/,/g, '.');
        }
      } else if (lastComma !== -1) {
        s = s.replace(/\./g, '').replace(/,/g, '.');
      } else {
        const parts = s.split('.');
        if (parts.length > 2) {
          const dec = parts.pop();
          s = parts.join('') + '.' + dec;
        }
      }

      s = s.replace(/[^\d.-]/g, '');
      const n = parseFloat(s);
      return Number.isFinite(n) ? n : NaN;
    }

    // Formateadores
    function formatMXN(v) {
      return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(v);
    }
    function formatBTC(v) {
      return Number(v).toFixed(8).replace(/\.?0+$/, '');
    }
    function formatSats(v) {
      return Math.round(v).toLocaleString('es-MX');
    }

    // Actualizar estado del botón según cantidad de campos con texto
    function updateButtonState() {
      const vals = [mxnInput.value, btcInput.value, satInput.value];
      const nonEmptyCount = vals.reduce((acc, cur) => acc + (String(cur || '').trim() !== '' ? 1 : 0), 0);

      if (nonEmptyCount === 1) {
        convertBtn.disabled = false;
        convertBtn.classList.remove('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');
        convertBtn.classList.add('text-white');
        helperMsg.textContent = '';
      } else {
        convertBtn.disabled = true;
        convertBtn.classList.remove('text-white');
        convertBtn.classList.add('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');

        if (nonEmptyCount === 0) {
          helperMsg.textContent = 'Ingresa un valor en uno de los campos para habilitar Convertir.';
          helperMsg.classList.remove('text-red-600');
          helperMsg.classList.add('text-gray-600');
        } else {
          helperMsg.textContent = 'Solo se permite usar un campo a la vez. Borra los demás antes de convertir.';
          helperMsg.classList.remove('text-gray-600');
          helperMsg.classList.add('text-red-600');
        }
      }
    }

    // Determinar cuál campo tiene texto (exactamente uno) y convertir mostrando todo directamente
    function convertir() {
      resultadoEl.textContent = '';
      helperMsg.textContent = '';
      helperMsg.classList.remove('text-red-600');
      helperMsg.classList.add('text-gray-600');

      // Verificar precio
      if (!precioMXN || precioMXN <= 0) {
        helperMsg.textContent = 'Esperando precio actualizado. Intenta de nuevo en unos segundos.';
        helperMsg.classList.remove('text-gray-600');
        helperMsg.classList.add('text-red-600');
        return;
      }

      const rawMxn = mxnInput.value.trim();
      const rawBtc = btcInput.value.trim();
      const rawSats = satInput.value.trim();

      const filled = [
        { key: 'mxn', value: rawMxn },
        { key: 'btc', value: rawBtc },
        { key: 'sats', value: rawSats }
      ].filter(x => x.value !== '');

      if (filled.length !== 1) {
        helperMsg.textContent = 'Error: debe haber exactamente un campo con valor.';
        helperMsg.classList.remove('text-gray-600');
        helperMsg.classList.add('text-red-600');
        updateButtonState();
        return;
      }

      const origen = filled[0].key;
      let outputLines = [];

      if (origen === 'mxn') {
        const vMxn = parseNumberSafe(rawMxn);
        if (Number.isNaN(vMxn) || vMxn === 0) {
          helperMsg.textContent = 'Valor MXN inválido. Revisa el formato y vuelve a intentar.';
          helperMsg.classList.remove('text-gray-600');
          helperMsg.classList.add('text-red-600');
          return;
        }
        const btc = vMxn / precioMXN;
        const sats = btc * BTC_TO_SATS;

        outputLines.push(`${formatMXN(vMxn)} ≈ ${formatBTC(btc)} BTC`);
        outputLines.push(`${formatSats(sats)} SATs`);
      } else if (origen === 'btc') {
        const vBtc = parseNumberSafe(rawBtc);
        if (Number.isNaN(vBtc) || vBtc === 0) {
          helperMsg.textContent = 'Valor BTC inválido. Revisa el formato y vuelve a intentar.';
          helperMsg.classList.remove('text-gray-600');
          helperMsg.classList.add('text-red-600');
          return;
        }
        const sats = vBtc * BTC_TO_SATS;
        const mxn = vBtc * precioMXN;

        outputLines.push(`${formatBTC(vBtc)} BTC`);
        outputLines.push(`${formatSats(sats)} SATs`);
        outputLines.push(`<span class="mxn-result">${formatMXN(mxn)} MXN</span>`);
      } else if (origen === 'sats') {
        const vSats = parseNumberSafe(rawSats);
        if (Number.isNaN(vSats) || vSats === 0) {
          helperMsg.textContent = 'Valor SATs inválido. Revisa el formato y vuelve a intentar.';
          helperMsg.classList.remove('text-gray-600');
          helperMsg.classList.add('text-red-600');
          return;
        }
        const btc = vSats / BTC_TO_SATS;
        const mxn = btc * precioMXN;

        outputLines.push(`${formatSats(vSats)} SATs`);
        outputLines.push(`${formatBTC(btc)} BTC`);
        outputLines.push(`<span class="mxn-result">${formatMXN(mxn)} MXN</span>`);
      }

      resultadoEl.innerHTML = outputLines.map(l => `<div class="fade-in">${l}</div>`).join('');

      // Limpiar campos, deshabilitar botón
      mxnInput.value = '';
      btcInput.value = '';
      satInput.value = '';
      updateButtonState();
    }

    // Eventos para actualizar estado del botón en cada input
    [mxnInput, btcInput, satInput].forEach(el => {
      el.addEventListener('input', updateButtonState);
      el.addEventListener('change', updateButtonState);
    });

    convertBtn.addEventListener('click', convertir);

    // Cargar precio desde CoinGecko
    async function getBTCPrice() {
      try {
        const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=mxn');
        const data = await res.json();
        if (data && data.bitcoin && data.bitcoin.mxn) {
          precioMXN = Number(data.bitcoin.mxn);
          btcPriceEl.textContent = formatMXN(precioMXN);
          priceUpdateEl.textContent = `Última actualización: ${new Date().toLocaleTimeString()}`;
        } else {
          btcPriceEl.textContent = 'Error al obtener precio';
        }
      } catch (e) {
        btcPriceEl.textContent = 'Error de red';
      }
    }

    // Inicializar
    updateButtonState();
    getBTCPrice();
    setInterval(getBTCPrice, 10000);
  </script>
</body>
</html>