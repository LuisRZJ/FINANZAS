<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador mercado | FTI</title>
    <meta name="theme-color" content="#2563eb">
    <link rel="icon" href="/pwa/logo-app.png">

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <script>
            // Script inline para prevenir flash de tema incorrecto
            (function () {
                try {
                    const storedTheme = localStorage.getItem('fti_theme_preference');
                    const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

                    if (storedTheme === 'dark' || ((!storedTheme || storedTheme === 'system') && systemDark)) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                } catch (e) {
                    console.warn('Error accediendo a localStorage para tema:', e);
                }
            })();
    </script>

    <!-- Fuentes para Trading (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Scrollbar styles - Light Mode default */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Scrollbar styles - Dark Mode */
        .dark ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .tooltip:hover::after {
            content: attr(data-tip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #ffffff;
            color: #1e293b;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            border: 1px solid #e2e8f0;
            z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            font-weight: 500;
        }

        .dark .tooltip:hover::after {
            background: #1e293b;
            color: #94a3b8;
            border: 1px solid #334155;
        }

        input::-webkit-calendar-picker-indicator {
            opacity: 0.5;
            cursor: pointer;
        }

        .dark input::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        /* Ocultar flechas del input number para un look más limpio */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Animación para el indicador de vela viva */
        @keyframes pulse-dot {
            0% {
                transform: scale(0.95);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.4;
            }

            100% {
                transform: scale(0.95);
                opacity: 0.8;
            }
        }

        .live-dot {
            animation: pulse-dot 1.5s infinite ease-in-out;
        }
    </style>
</head>

<body class="bg-gray-100 text-slate-800 transition-colors duration-300 dark:bg-gray-900 dark:text-gray-100">
    <div id="root"></div>

    <!-- Scripts del tema -->
    <script src="../theme.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ICONOS SVG ---
        const Search = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></svg>;
        const Calendar = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></svg>;
        const Clock = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></svg>;
        const ChevronLeft = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m15 18-6-6 6-6" /></svg>;
        const ChevronRight = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m9 18 6-6-6-6" /></svg>;
        const AlertTriangle = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><line x1="12" x2="12" y1="9" y2="13" /><line x1="12" x2="12.01" y1="17" y2="17" /></svg>;
        const Database = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><ellipse cx="12" cy="5" rx="9" ry="3" /><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" /><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" /></svg>;
        const CheckCircle2 = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10" /><path d="m9 12 2 2 4-4" /></svg>;
        const BarChart3 = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 3v18h18" /><path d="M18 17V9" /><path d="M13 17V5" /><path d="M8 17v-3" /></svg>;
        const Scale = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" /><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z" /><path d="M7 21h10" /><path d="M12 3v18" /><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2" /></svg>;
        const Timer = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="10" x2="14" y1="2" y2="2" /><line x1="12" x2="15" y1="14" y2="11" /><circle cx="12" cy="14" r="8" /></svg>;
        const Download = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></svg>;

        const POPULAR_PAIRS = [
            "BTCUSDT", "ETHUSDT", "BNBUSDT", "SOLUSDT", "XRPUSDT",
            "ADAUSDT", "DOGEUSDT", "AVAXUSDT", "TRXUSDT", "DOTUSDT",
            "MATICUSDT", "LTCUSDT", "LINKUSDT", "BCHUSDT", "XLMUSDT",
            "NEARUSDT", "ATOMUSDT", "UNIUSDT", "FILUSDT", "HBARUSDT",
            "PEPEUSDT", "SHIBUSDT", "SUIUSDT", "APTUSDT", "ARBUSDT"
        ];

        const FOREX_PAIRS = [
            "XAU/USD", "EUR/USD", "USD/JPY", "GBP/USD", "AUD/USD", "USD/CAD", "USD/CHF", "NZD/USD",
            "EUR/JPY", "EUR/GBP", "GBP/JPY", "AUD/JPY", "CAD/JPY", "CHF/JPY"
        ];

        const BINANCE_WEIGHT_LIMIT_PER_MINUTE = 1200;
        const WEIGHT_PER_REQUEST = 1;
        const SAFE_REQUEST_DELAY_MS = 150;
        const AVG_LATENCY_PER_REQ_MS = 300;

        const ALLOWED_INTERVALS = ["1m", "5m", "15m", "1h", "4h", "1d", "1w"];

        const MarketInspector = () => {
            const [symbol, setSymbol] = useState("BTCUSDT");
            const [interval, setInterval] = useState("1h");
            const [startDate, setStartDate] = useState("");
            const [endDate, setEndDate] = useState("");
            const [mode, setMode] = useState("crypto");
            const [twelveApiKeyInput, setTwelveApiKeyInput] = useState("");
            const [hasSavedApiKey, setHasSavedApiKey] = useState(false);

            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [progress, setProgress] = useState("");
            const [error, setError] = useState(null);

            const [currentPage, setCurrentPage] = useState(1);
            const [inputPage, setInputPage] = useState(1);
            const itemsPerPage = 15;
            const TWELVE_LIMIT_PER_MIN = 8;
            const twelveRate = React.useRef({ windowStart: 0, count: 0, queue: [] });
            const [twelveCallsThisMinute, setTwelveCallsThisMinute] = useState(0);

            useEffect(() => {
                const end = new Date();
                const start = new Date();
                start.setDate(end.getDate() - 3);

                const toLocalISOString = (date) => {
                    const pad = (num) => (num < 10 ? '0' + num : num);
                    return date.getFullYear() +
                        '-' + pad(date.getMonth() + 1) +
                        '-' + pad(date.getDate()) +
                        'T' + pad(date.getHours()) +
                        ':' + pad(date.getMinutes());
                };

                setEndDate(toLocalISOString(end));
                setStartDate(toLocalISOString(start));
            }, []);

            useEffect(() => {
                setInputPage(currentPage);
            }, [currentPage]);

            useEffect(() => {
                const stored = localStorage.getItem('fti_twelve_api_key');
                setHasSavedApiKey(!!stored);
            }, []);

            const estimates = useMemo(() => {
                if (!startDate || !endDate) return { candles: 0, weight: 0, timeMs: 0, timeStr: "0s" };
                const start = new Date(startDate).getTime();
                const end = new Date(endDate).getTime();
                if (start >= end) return { candles: 0, weight: 0, timeMs: 0, timeStr: "0s" };
                const unit = interval.slice(-1);
                const value = parseInt(interval.slice(0, -1));
                let multiplier = 60 * 1000;
                if (unit === 'm') multiplier = 60 * 1000;
                else if (unit === 'h') multiplier = 60 * 60 * 1000;
                else if (unit === 'd') multiplier = 24 * 60 * 60 * 1000;
                else if (unit === 'w') multiplier = 7 * 24 * 60 * 60 * 1000;
                else if (unit === 'M') multiplier = 30 * 24 * 60 * 60 * 1000;
                const msPerCandle = value * multiplier;
                const diffMs = end - start;
                const totalCandles = Math.ceil(diffMs / msPerCandle);
                if (mode === 'crypto') {
                    const totalRequests = Math.ceil(totalCandles / 1000);
                    const totalWeight = totalRequests * WEIGHT_PER_REQUEST;
                    const msPerRequestTotal = SAFE_REQUEST_DELAY_MS + AVG_LATENCY_PER_REQ_MS;
                    const totalTimeMs = totalRequests * msPerRequestTotal;
                    let timeStr = "";
                    if (totalTimeMs < 1000) timeStr = "< 1s"; else if (totalTimeMs < 60000) timeStr = `~${Math.ceil(totalTimeMs / 1000)}s`; else { const minutes = Math.floor(totalTimeMs / 60000); const seconds = Math.ceil((totalTimeMs % 60000) / 1000); timeStr = `~${minutes}m ${seconds}s`; }
                    return { candles: totalCandles, weight: totalWeight, timeMs: totalTimeMs, timeStr };
                } else {
                    const estimatedRequests = 1;
                    const totalTimeMs = AVG_LATENCY_PER_REQ_MS * estimatedRequests;
                    let timeStr = "";
                    if (totalTimeMs < 1000) timeStr = "< 1s"; else if (totalTimeMs < 60000) timeStr = `~${Math.ceil(totalTimeMs / 1000)}s`; else { const minutes = Math.floor(totalTimeMs / 60000); const seconds = Math.ceil((totalTimeMs % 60000) / 1000); timeStr = `~${minutes}m ${seconds}s`; }
                    return { candles: totalCandles, weight: 0, timeMs: totalTimeMs, timeStr };
                }
            }, [startDate, endDate, interval, mode]);

            const downloadCSV = () => {
                if (!data || data.length === 0) return;

                const headers = [
                    "Date", "Open", "High", "Low", "Close",
                    "Volume", "Trades", "Taker Buy Vol", "Taker Sell Vol",
                    "Delta", "Buy Pressure %", "Status"
                ];

                const csvRows = [headers.join(',')];
                const now = Date.now();

                data.forEach(row => {
                    const date = new Date(row.time);
                    const dateStr = date.getFullYear() + "-" +
                        ("0" + (date.getMonth() + 1)).slice(-2) + "-" +
                        ("0" + date.getDate()).slice(-2) + " " +
                        ("0" + date.getHours()).slice(-2) +
                        ("0" + date.getMinutes()).slice(-2) +
                        ("0" + date.getSeconds()).slice(-2);

                    const v = (x) => (x === null || x === undefined ? 'N/A' : x);
                    const bp = row.buyPressure === null || row.buyPressure === undefined ? 'N/A' : Number(row.buyPressure).toFixed(2);
                    const values = [
                        dateStr, v(row.open), v(row.high), v(row.low), v(row.close),
                        v(row.volume), v(row.trades), v(row.takerBuyVol), v(row.takerSellVol),
                        v(row.delta), bp,
                        row.isLive ? "Live" : "Closed"
                    ];
                    csvRows.push(values.join(','));
                });

                const csvContent = csvRows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const filename = `${symbol}_${interval}_${new Date().toISOString().slice(0, 10)}.csv`;

                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const downloadCompressed = async () => {
                if (!data || data.length === 0) return;
                if (typeof CompressionStream === 'undefined') {
                    setError("Tu navegador no soporta compresión binaria (CompressionStream).");
                    return;
                }

                const payload = {
                    format: "market-inspector",
                    version: 1,
                    exportedAt: new Date().toISOString(),
                    symbol,
                    interval,
                    mode,
                    data
                };

                const json = JSON.stringify(payload);
                const stream = new Blob([json]).stream().pipeThrough(new CompressionStream('gzip'));
                const compressedBlob = await new Response(stream).blob();
                const url = URL.createObjectURL(compressedBlob);
                const link = document.createElement('a');
                const filename = `${symbol}_${interval}_${new Date().toISOString().slice(0, 10)}.mkt.gz`;

                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            const forexIntervalMap = {
                '1m': '1min',
                '5m': '5min',
                '15m': '15min',
                '1h': '1h',
                '4h': '4h',
                '1d': '1day',
                '1w': '1week'
            };

            const scheduleTwelveTask = (fn) => {
                const now = Date.now();
                const bucket = twelveRate.current;
                if (bucket.windowStart === 0 || now - bucket.windowStart >= 60000) {
                    bucket.windowStart = now;
                    bucket.count = 0;
                    setTwelveCallsThisMinute(0);
                }
                bucket.queue.push(fn);
                const tryRun = () => {
                    const n = Date.now();
                    if (bucket.windowStart === 0 || n - bucket.windowStart >= 60000) {
                        bucket.windowStart = n;
                        bucket.count = 0;
                        setTwelveCallsThisMinute(0);
                    }
                    if (bucket.count < TWELVE_LIMIT_PER_MIN && bucket.queue.length > 0) {
                        const task = bucket.queue.shift();
                        bucket.count += 1;
                        setTwelveCallsThisMinute(bucket.count);
                        task();
                    } else if (bucket.queue.length > 0) {
                        const waitMs = 60000 - (n - bucket.windowStart);
                        setProgress(`Límite TwelveData alcanzado. Esperando ~${Math.ceil(waitMs / 1000)}s...`);
                        setTimeout(tryRun, Math.max(waitMs, 0));
                    }
                };
                tryRun();
            };

            const fetchForexData = async () => {
                setLoading(true);
                setError(null);
                setData([]);
                setCurrentPage(1);
                try {
                    let startTs = new Date(startDate).getTime();
                    const endTs = new Date(endDate).getTime();
                    if (startTs >= endTs) throw new Error("La fecha de inicio debe ser anterior a la final.");
                    if (!symbol) throw new Error("Escribe un par (ej. EUR/USD).");
                    const apiKey = localStorage.getItem('fti_twelve_api_key');
                    if (!apiKey) throw new Error("Ingresa y guarda tu API Key de TwelveData.");
                    // Usamos formato compatible SQL (YYYY-MM-DD HH:mm:ss) para evitar problemas con TwelveData
                    // Eliminamos la 'T' y la 'Z' del ISOString
                    const fmt = (ts) => {
                        const d = new Date(ts);
                        return d.toISOString().replace('T', ' ').split('.')[0];
                    };

                    if (!ALLOWED_INTERVALS.includes(interval)) {
                        throw new Error("Temporalidad no permitida. Máximo: 1W.");
                    }

                    const mapped = forexIntervalMap[interval] || '1h';

                    let allRawValues = [];
                    let keepFetching = true;
                    let requestCount = 0;

                    // Estrategia: Paginación Inversa (Backwards Pagination)
                    // Empezamos desde el final (endTs) y pedimos hacia atrás hasta llegar a startTs.
                    // Esto es mucho más estable en TwelveData.

                    let currentAnchorTs = endTs;

                    // Estimación para barra de progreso
                    const totalEstimatedCandles = estimates.candles;
                    const estimatedRequests = Math.ceil(totalEstimatedCandles / 5000) || 1;

                    while (keepFetching) {
                        requestCount++;
                        // Evitamos división por cero o números raros
                        const progressPct = estimatedRequests > 0 ? Math.min(Math.round((requestCount / estimatedRequests) * 100), 99) : 50;
                        setProgress(`Petición ${requestCount} (Retrocediendo desde ${new Date(currentAnchorTs).toLocaleDateString()})...`);

                        // Usamos currentAnchorTs como end_date
                        const currentEndStr = fmt(currentAnchorTs);

                        // NO enviamos start_date en la URL del bucle.
                        // Solo enviamos end_date y dejamos que la API nos de las 5000 velas ANTERIORES a esa fecha.
                        // La API por defecto ordena DESC (lo más reciente primero), que es lo que queremos para ir hacia atrás.
                        const url = `https://api.twelvedata.com/time_series?symbol=${encodeURIComponent(symbol)}&interval=${mapped}&end_date=${encodeURIComponent(currentEndStr)}&outputsize=5000&timezone=UTC&format=JSON&apikey=${apiKey}`;

                        const batchValues = await new Promise((resolve, reject) => scheduleTwelveTask(async () => {
                            try {
                                const response = await fetch(url);
                                if (!response.ok) {
                                    const errData = await response.json().catch(() => ({}));
                                    if (response.status === 400 && (errData.message || "").includes("No data")) {
                                        resolve([]);
                                        return;
                                    }
                                    reject(new Error(errData.message || `Error ${response.status}: Verifica el par y tu API Key.`));
                                    return;
                                }
                                const json = await response.json();
                                if (json.status && json.status !== 'ok') {
                                    if ((json.message || "").includes("No data")) {
                                        resolve([]);
                                        return;
                                    }
                                    reject(new Error(json.message || 'Respuesta inválida de TwelveData.'));
                                    return;
                                }
                                resolve(json.values || []);
                            } catch (e) {
                                reject(e);
                            }
                        }));

                        if (!batchValues || batchValues.length === 0) {
                            keepFetching = false;
                            break;
                        }

                        // batchValues viene ordenado DESC (el índice 0 es el más reciente, el último es el más antiguo)
                        // Filtramos lo que sea anterior a nuestra fecha de inicio global (startTs)
                        const validBatch = [];
                        let reachedStart = false;

                        for (const item of batchValues) {
                            const itemTs = Date.parse(item.datetime.replace(' ', 'T') + 'Z');

                            // Si el dato es posterior a nuestro fin global (raro, pero posible), lo ignoramos
                            if (itemTs > endTs) continue;

                            // Si el dato es anterior a nuestro inicio global, hemos llegado al principio
                            if (itemTs < startTs) {
                                reachedStart = true;
                                // No hacemos break inmediato porque queremos procesar este bloque, 
                                // pero marcamos para detener el bucle externo
                            } else {
                                validBatch.push(item);
                            }
                        }

                        // Acumulamos. Como vamos hacia atrás, estos datos son "anteriores" a los que ya tenemos.
                        allRawValues = [...allRawValues, ...validBatch];

                        if (reachedStart || batchValues.length < 5000) {
                            keepFetching = false;
                        } else {
                            // Preparamos siguiente ancla
                            // El último elemento del batch es el más antiguo recibido.
                            const oldestItem = batchValues[batchValues.length - 1];
                            const oldestItemTs = Date.parse(oldestItem.datetime.replace(' ', 'T') + 'Z');

                            // Si la API se estanca y nos devuelve lo mismo, cortamos
                            if (oldestItemTs >= currentAnchorTs) {
                                keepFetching = false;
                            } else {
                                // Retrocedemos 1ms/1s desde el dato más antiguo para pedir el siguiente bloque hacia atrás
                                currentAnchorTs = oldestItemTs - 1000;

                                // Seguridad: si ya nos pasamos del inicio, paramos
                                if (currentAnchorTs < startTs) keepFetching = false;
                            }
                        }
                    }

                    if (allRawValues.length === 0) {
                        setError("No se encontraron datos en este rango de fechas.");
                        setLoading(false);
                        setProgress("");
                        return;
                    }

                    const formatted = allRawValues.map(v => {
                        // Parseo consistente UTC
                        const ts = Date.parse(v.datetime.replace(' ', 'T') + 'Z');
                        const vol = v.volume !== undefined ? parseFloat(v.volume) : null;
                        return {
                            time: ts,
                            open: parseFloat(v.open),
                            high: parseFloat(v.high),
                            low: parseFloat(v.low),
                            close: parseFloat(v.close),
                            volume: isNaN(vol) ? null : vol,
                            trades: null,
                            takerBuyVol: null,
                            takerSellVol: null,
                            delta: null,
                            buyPressure: null,
                            isLive: false
                        };
                    });

                    // Filtrar duplicados y asegurar orden CRONOLÓGICO (ASC) final
                    const uniqueData = Array.from(new Map(formatted.map(item => [item.time, item])).values());
                    uniqueData.sort((a, b) => a.time - b.time);

                    setData(uniqueData);
                    setProgress("Completado ✅");
                    setLoading(false);
                    setTimeout(() => { setProgress(""); }, 3000);
                } catch (err) {
                    setError(err.message);
                    setLoading(false);
                    setTimeout(() => { if (!error) setProgress(""); }, 3000);
                } finally {
                    setTwelveApiKeyInput("");
                }
            };

            const fetchData = async () => {
                setLoading(true);
                setError(null);
                setData([]);
                setCurrentPage(1);

                try {
                    if (mode === 'forex') {
                        await fetchForexData();
                        return;
                    }

                    if (!ALLOWED_INTERVALS.includes(interval)) {
                        throw new Error("Temporalidad no permitida. Máximo: 1W.");
                    }

                    const startTs = new Date(startDate).getTime();
                    let endTs = new Date(endDate).getTime() + 59999;

                    if (startTs >= endTs) throw new Error("La fecha de inicio debe ser anterior a la final.");
                    if (!symbol) throw new Error("Escribe un símbolo (ej. BTCUSDT).");

                    let allCandles = [];
                    let currentStart = startTs;
                    let keepFetching = true;
                    let requestCount = 0;

                    const totalExpectedRequests = Math.ceil(estimates.candles / 1000);

                    while (keepFetching) {
                        requestCount++;
                        const progressPct = Math.min(Math.round((requestCount / totalExpectedRequests) * 100), 99);

                        setProgress(`Petición ${requestCount}/${totalExpectedRequests} (${progressPct}%) | Fecha: ${new Date(currentStart).toLocaleDateString()}`);

                        const url = `https://api.binance.com/api/v3/klines?symbol=${symbol.toUpperCase()}&interval=${interval}&startTime=${currentStart}&endTime=${endTs}&limit=1000`;

                        const response = await fetch(url);

                        if (!response.ok) {
                            const errData = await response.json().catch(() => ({}));
                            if (response.status === 429) throw new Error("⛔ Binance API Rate Limit Exceeded. Esperando cooldown.");
                            throw new Error(errData.msg || `Error ${response.status}: Verifica el símbolo y tu conexión.`);
                        }

                        const klines = await response.json();

                        if (!klines || klines.length === 0) {
                            keepFetching = false;
                            break;
                        }

                        const now = Date.now();

                        const formattedChunk = klines.map(k => {
                            const totalVol = parseFloat(k[5]);
                            const takerBuyVol = parseFloat(k[9]);
                            const takerSellVol = totalVol - takerBuyVol;
                            const delta = takerBuyVol - takerSellVol;
                            const buyPressure = totalVol > 0 ? (takerBuyVol / totalVol) * 100 : 0;
                            const closeTime = k[6];

                            return {
                                time: k[0],
                                open: parseFloat(k[1]),
                                high: parseFloat(k[2]),
                                low: parseFloat(k[3]),
                                close: parseFloat(k[4]),
                                volume: totalVol,
                                trades: parseInt(k[8]),
                                takerBuyVol: takerBuyVol,
                                takerSellVol: takerSellVol,
                                delta: delta,
                                buyPressure: buyPressure,
                                isLive: closeTime > now
                            };
                        });

                        allCandles = [...allCandles, ...formattedChunk];

                        const lastTime = klines[klines.length - 1][0];
                        currentStart = lastTime + 1;

                        if (currentStart >= endTs) {
                            keepFetching = false;
                        } else {
                            await new Promise(resolve => setTimeout(resolve, SAFE_REQUEST_DELAY_MS));
                        }
                    }

                    if (allCandles.length === 0) {
                        setError("No se encontraron datos en este rango de fechas.");
                    } else {
                        setData(allCandles);
                        setProgress("Completado ✅");
                    }

                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                    setTimeout(() => { if (!error) setProgress(""); }, 3000);
                }
            };

            const totalPages = Math.ceil(data.length / itemsPerPage);
            const indexOfLastItem = currentPage * itemsPerPage;
            const indexOfFirstItem = indexOfLastItem - itemsPerPage;
            const currentItems = data.slice(indexOfFirstItem, indexOfLastItem);

            const formatMoney = (val) => val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 8, useGrouping: false });
            const formatVol = (val) => val.toLocaleString('en-US', { maximumFractionDigits: 2, useGrouping: false });
            const formatDateTime = (ts) => {
                const date = new Date(ts);
                return date.toLocaleDateString('es-ES') + ' ' + date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            };

            const weightPercent = (estimates.weight / BINANCE_WEIGHT_LIMIT_PER_MINUTE) * 100;
            let weightColor = "text-emerald-500";
            if (weightPercent > 50) weightColor = "text-yellow-500";
            if (weightPercent > 100) weightColor = "text-rose-500";
            const twelveLimitColor = twelveCallsThisMinute >= 8 ? "text-rose-600 dark:text-rose-400" : (twelveCallsThisMinute >= 6 ? "text-yellow-600 dark:text-yellow-400" : "text-emerald-600 dark:text-emerald-400");

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-[95%] mx-auto">

                    <div className="mb-6">
                        <a href="../utilidades.html" className="inline-flex items-center gap-2 text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors group">
                            <div className="p-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 group-hover:border-slate-300 dark:group-hover:border-slate-600 transition-all shadow-sm">
                                <ChevronLeft className="w-5 h-5" />
                            </div>
                            <span className="font-medium text-sm">Volver a Utilidades</span>
                        </a>
                    </div>

                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 border-b border-slate-200 dark:border-slate-700 pb-6">
                        <div className="flex items-center gap-3">
                            <div className="bg-yellow-500/10 p-3 rounded-xl border border-yellow-500/20">
                                <Database className="text-yellow-600 dark:text-yellow-500 w-8 h-8" />
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold text-slate-900 dark:text-white">Analizador de mercado <span className="text-yellow-600 dark:text-yellow-500 text-sm align-top">PRO</span></h1>
                                <p className="text-slate-500 dark:text-slate-400 text-sm">Cripto (Binance) y Forex/Metales (TwelveData)</p>
                            </div>
                        </div>
                        {data.length > 0 && (
                            <div className="flex items-center gap-3">
                                <div className="flex items-center gap-2 bg-emerald-500/10 px-4 py-2 rounded-full border border-emerald-500/20">
                                    <CheckCircle2 className="w-4 h-4 text-emerald-600 dark:text-emerald-400" />
                                    <span className="text-emerald-600 dark:text-emerald-400 font-medium text-sm">{data.length.toLocaleString()} Velas Analizadas</span>
                                </div>
                                <button
                                    onClick={downloadCSV}
                                    className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium shadow-lg transition-all active:scale-95 text-sm"
                                >
                                    <Download className="w-4 h-4" /> Exportar CSV
                                </button>
                                <button
                                    onClick={downloadCompressed}
                                    className="flex items-center gap-2 bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-lg font-medium shadow-lg transition-all active:scale-95 text-sm"
                                >
                                    <Download className="w-4 h-4" /> Exportar binario
                                </button>
                            </div>
                        )}
                    </div>

                    <div className="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-lg border border-slate-200 dark:border-slate-700 mb-8 transition-colors duration-300">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 items-end">
                            <div className="space-y-2">
                                <label className="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Modo</label>
                                <div className="flex items-center gap-2 bg-slate-100 dark:bg-slate-900 p-1 rounded-lg border border-slate-200 dark:border-slate-700">
                                    <button onClick={() => { setMode('crypto'); setSymbol('BTCUSDT'); }} className={`px-3 py-1.5 rounded-md text-sm font-medium ${mode === 'crypto' ? 'bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow border border-slate-200 dark:border-slate-700' : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-800'}`}>Cripto</button>
                                    <button onClick={() => { setMode('forex'); setSymbol('EUR/USD'); }} className={`px-3 py-1.5 rounded-md text-sm font-medium ${mode === 'forex' ? 'bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow border border-slate-200 dark:border-slate-700' : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-800'}`}>Forex</button>
                                </div>
                            </div>
                            <div className="space-y-2">
                                <label className="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider flex items-center gap-1"><Search className="w-3 h-3" /> {mode === 'crypto' ? 'Criptomoneda' : 'Par Forex/Metal'}</label>
                                {mode === 'crypto' ? (
                                    <>
                                        <input type="text" value={symbol} onChange={(e) => setSymbol(e.target.value.toUpperCase())} list="crypto-options" className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2.5 text-slate-900 dark:text-white focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500 outline-none transition" placeholder="Ej: BTCUSDT" />
                                        <datalist id="crypto-options">{POPULAR_PAIRS.map(pair => <option key={pair} value={pair} />)}</datalist>
                                    </>
                                ) : (
                                    <>
                                        <input type="text" value={symbol} onChange={(e) => setSymbol(e.target.value)} list="forex-options" className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2.5 text-slate-900 dark:text-white focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500 outline-none transition" placeholder="Ej: EUR/USD o XAU/USD" />
                                        <datalist id="forex-options">{FOREX_PAIRS.map(pair => <option key={pair} value={pair} />)}</datalist>
                                    </>
                                )}
                            </div>
                            <div className="space-y-2">
                                <label className="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider flex items-center gap-1"><Clock className="w-3 h-3" /> Temporalidad</label>
                                <select value={interval} onChange={(e) => setInterval(e.target.value)} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2.5 text-slate-900 dark:text-white focus:border-yellow-500 outline-none">
                                    <option value="1m">1 Minuto</option>
                                    <option value="5m">5 Minutos</option>
                                    <option value="15m">15 Minutos</option>
                                    <option value="1h">1 Hora</option>
                                    <option value="4h">4 Horas</option>
                                    <option value="1d">1 Día</option>
                                    <option value="1w">1 Semana</option>
                                </select>
                            </div>
                            <div className="space-y-2">
                                <label className="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider flex items-center gap-1"><Calendar className="w-3 h-3" /> Desde</label>
                                <input type="datetime-local" value={startDate} onChange={(e) => setStartDate(e.target.value)} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2.5 text-slate-900 dark:text-white text-sm focus:border-yellow-500 outline-none" />
                            </div>
                            <div className="space-y-2">
                                <label className="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider flex items-center gap-1"><Calendar className="w-3 h-3" /> Hasta</label>
                                <input type="datetime-local" value={endDate} onChange={(e) => setEndDate(e.target.value)} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2.5 text-slate-900 dark:text-white text-sm focus:border-yellow-500 outline-none" />
                            </div>

                            <div className="space-y-2">
                                <div className="flex flex-col text-[10px] px-1 gap-1">
                                    <div className="flex justify-between items-center">
                                        <span className="text-slate-500 dark:text-slate-400">Velas:</span>
                                        <span className="font-mono font-bold text-slate-700 dark:text-slate-200">~{estimates.candles.toLocaleString()}</span>
                                    </div>
                                    {mode === 'crypto' ? (
                                        <div className="flex justify-between items-center group relative cursor-help">
                                            <span className="text-slate-500 dark:text-slate-400 flex items-center gap-1">Peso API: <Scale className="w-3 h-3 text-slate-400 dark:text-slate-500" /></span>
                                            <span className={`font-mono font-bold ${weightColor}`}>{estimates.weight} <span className="text-slate-500 dark:text-slate-600">/ 1200</span></span>
                                            <div className="absolute bottom-full right-0 mb-1 hidden group-hover:block bg-white dark:bg-slate-900 text-slate-600 dark:text-slate-300 p-2 rounded border border-slate-200 dark:border-slate-700 w-48 z-50 shadow-xl">Límite: 1200/min. El sistema gestiona el ritmo automáticamente.</div>
                                        </div>
                                    ) : (
                                        <div className="flex justify-between items-center group relative cursor-help">
                                            <span className="text-slate-500 dark:text-slate-400 flex items-center gap-1">Llamadas/min: <Scale className="w-3 h-3 text-slate-400 dark:text-slate-500" /></span>
                                            <span className={`font-mono font-bold ${twelveLimitColor}`}>{twelveCallsThisMinute} <span className="text-slate-500 dark:text-slate-600">/ 8</span></span>
                                            <div className="absolute bottom-full right-0 mb-1 hidden group-hover:block bg-white dark:bg-slate-900 text-slate-600 dark:text-slate-300 p-2 rounded border border-slate-200 dark:border-slate-700 w-56 z-50 shadow-xl">Límite TwelveData: 8/min. Se usa cola automática para evitar exceder el límite.</div>
                                        </div>
                                    )}
                                    <div className="flex justify-between items-center group relative cursor-help border-t border-slate-200 dark:border-slate-700 pt-1 mt-0.5">
                                        <span className="text-slate-500 dark:text-slate-400 flex items-center gap-1">Tiempo: <Timer className="w-3 h-3 text-slate-400 dark:text-slate-500" /></span>
                                        <span className="font-mono font-bold text-blue-600 dark:text-blue-300">{estimates.timeStr}</span>
                                        <div className="absolute bottom-full right-0 mb-1 hidden group-hover:block bg-white dark:bg-slate-900 text-slate-600 dark:text-slate-300 p-2 rounded border border-slate-200 dark:border-slate-700 w-48 z-50 shadow-xl">Tiempo total estimado incluyendo pausas de seguridad.</div>
                                    </div>
                                </div>
                                <button onClick={fetchData} disabled={loading} className={`w-full py-2.5 rounded-lg font-bold text-slate-900 transition-all shadow-lg flex items-center justify-center gap-2 ${loading ? 'bg-slate-300 dark:bg-slate-600 cursor-not-allowed' : 'bg-yellow-500 hover:bg-yellow-400 active:scale-95'}`}>{loading ? 'Analizando...' : (<><BarChart3 className="w-4 h-4" /> Procesar</>)}</button>
                            </div>
                        </div>
                        {mode === 'forex' && (
                            <div className="mt-6 grid grid-cols-1 lg:grid-cols-5 gap-6 items-start">
                                <div className="lg:col-span-2 space-y-2">
                                    <label className="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">API Key TwelveData</label>
                                    <div className="flex items-center gap-2">
                                        <input type="password" value={twelveApiKeyInput} onChange={(e) => setTwelveApiKeyInput(e.target.value)} placeholder={hasSavedApiKey ? 'Clave guardada' : 'Ingresa tu API Key'} className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg px-4 py-2.5 text-slate-900 dark:text-white focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500 outline-none transition" />
                                        <button onClick={() => { if (twelveApiKeyInput.trim()) { localStorage.setItem('fti_twelve_api_key', twelveApiKeyInput.trim()); setHasSavedApiKey(true); setTwelveApiKeyInput(''); } }} className="px-3 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium shadow">Guardar</button>
                                        <button onClick={() => { localStorage.removeItem('fti_twelve_api_key'); setHasSavedApiKey(false); setTwelveApiKeyInput(''); }} className="px-3 py-2 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-900 dark:text-white text-sm font-medium">Borrar</button>
                                    </div>
                                    <div className="text-xs text-slate-500 dark:text-slate-400">La clave se guarda localmente en tu navegador. No se comparte ni se envía a terceros salvo al proveedor TwelveData para las consultas solicitadas.</div>
                                </div>
                                <div className="lg:col-span-3 space-y-3">
                                    <div className="p-4 rounded-lg border border-amber-300 dark:border-amber-500 bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-300">
                                        <div className="font-semibold">Costes y responsabilidad</div>
                                        <div className="text-sm">El uso de TwelveData puede generar costes según tu plan. Eres responsable de gestionar tu consumo y respetar los límites de uso (8 llamadas/min en plan gratuito).</div>
                                    </div>
                                    <div className="p-4 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/30 text-slate-700 dark:text-slate-300">
                                        <div className="font-semibold">Cómo obtener tu API Key</div>
                                        <div className="text-sm">Crea una cuenta en TwelveData, accede al panel y genera una clave personal. Copia y pégala en el campo de arriba y presiona Guardar.</div>
                                    </div>
                                    <div className="p-4 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/30 text-slate-700 dark:text-slate-300">
                                        <div className="font-semibold">Diferencias de formato</div>
                                        <div className="text-sm">Los datos de TwelveData incluyen OHLC y pueden no incluir volumen/trades para ciertos pares Forex y metales (p. ej., XAU/USD). Las columnas de flujo agresivo (Buy/Sell Vol), Delta y Presión% no aplican en estos instrumentos y se muestran como N/A.</div>
                                    </div>
                                    <div className="p-4 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/30 text-slate-700 dark:text-slate-300">
                                        <div className="font-semibold">Límites y políticas</div>
                                        <div className="text-sm">El plan gratuito de TwelveData permite 8 llamadas por minuto. Esta herramienta implementa cola y control visible para cumplir los límites. Revisa las políticas de uso de TwelveData antes de operar en producción.</div>
                                    </div>
                                </div>
                            </div>
                        )}
                        {progress && <div className="mt-4 text-xs font-medium text-yellow-600 dark:text-yellow-500 animate-pulse">{progress}</div>}
                        {error && <div className="mt-4 p-3 bg-red-50 dark:bg-red-500/10 border border-red-200 dark:border-red-500/30 rounded-lg flex items-center gap-2 text-red-600 dark:text-red-400 text-sm"><AlertTriangle className="w-4 h-4" />{error}</div>}
                    </div>

                    {data.length > 0 && (
                        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-200 dark:border-slate-700 overflow-hidden flex flex-col transition-colors duration-300">
                            <div className="overflow-x-auto">
                                <table className="w-full text-left border-collapse tabular-nums">
                                    <thead>
                                        <tr className="bg-slate-50 dark:bg-slate-900 text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider border-b border-slate-200 dark:border-slate-700">
                                            <th className="p-4 font-medium sticky left-0 bg-slate-50 dark:bg-slate-900 z-20 border-r border-slate-200 dark:border-slate-800 shadow-xl min-w-[160px]">Fecha / Hora</th>
                                            <th className="p-4 font-medium text-right">Open</th>
                                            <th className="p-4 font-medium text-right">High</th>
                                            <th className="p-4 font-medium text-right">Low</th>
                                            <th className="p-4 font-medium text-right">Close</th>
                                            <th className="p-4 font-medium text-right">Trades</th>
                                            <th className="p-4 font-medium text-right border-l border-slate-200 dark:border-slate-700">Vol Total</th>
                                            <th className="p-4 font-medium text-right text-emerald-600 dark:text-emerald-400 relative group cursor-help"><span className="tooltip" data-tip="Volumen de compradores golpeando el ASK (Agresivos)">Buy Vol</span></th>
                                            <th className="p-4 font-medium text-right text-rose-600 dark:text-rose-400 relative group cursor-help"><span className="tooltip" data-tip="Volumen de vendedores golpeando el BID (Agresivos)">Sell Vol</span></th>
                                            <th className="p-4 font-medium text-center border-l border-slate-200 dark:border-slate-700 relative group cursor-help"><span className="tooltip" data-tip="Diferencia: Compras Agresivas - Ventas Agresivas">Delta</span></th>
                                            <th className="p-4 font-medium text-center relative group cursor-help"><span className="tooltip" data-tip="% del volumen total que fue compra agresiva">Presión %</span></th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-200 dark:divide-slate-700 text-sm font-medium">
                                        {currentItems.map((candle) => {
                                            const isBullish = candle.close >= candle.open;
                                            const deltaColor = candle.delta > 0 ? "text-emerald-600 dark:text-emerald-400" : "text-rose-600 dark:text-rose-400";
                                            const pressureColor = candle.buyPressure >= 50 ? "text-emerald-600 dark:text-emerald-400" : "text-rose-600 dark:text-rose-400";

                                            return (
                                                <tr key={candle.time} className={`hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors ${candle.isLive ? 'bg-slate-50 dark:bg-slate-700/20' : ''}`}>
                                                    <td className="p-4 text-slate-700 dark:text-slate-300 whitespace-nowrap sticky left-0 bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 z-10 font-bold flex items-center gap-2">
                                                        {formatDateTime(candle.time)}
                                                        {candle.isLive && (
                                                            <span className="relative flex h-2 w-2">
                                                                <span className="live-dot absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                                                <span className="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                                                            </span>
                                                        )}
                                                    </td>
                                                    <td className="p-4 text-right text-slate-600 dark:text-slate-400">{candle.open == null ? 'N/A' : formatMoney(candle.open)}</td>
                                                    <td className="p-4 text-right text-slate-600 dark:text-slate-400">{candle.high == null ? 'N/A' : formatMoney(candle.high)}</td>
                                                    <td className="p-4 text-right text-slate-600 dark:text-slate-400">{candle.low == null ? 'N/A' : formatMoney(candle.low)}</td>
                                                    <td className={`p-4 text-right font-bold ${isBullish ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-600 dark:text-rose-400'}`}>{candle.close == null ? 'N/A' : formatMoney(candle.close)}</td>
                                                    <td className="p-4 text-right text-purple-600 dark:text-purple-300">{candle.trades == null ? 'N/A' : candle.trades}</td>
                                                    <td className="p-4 text-right text-slate-700 dark:text-slate-300 border-l border-slate-200 dark:border-slate-700">{candle.volume == null ? 'N/A' : formatVol(candle.volume)}</td>
                                                    <td className="p-4 text-right text-emerald-600/80 dark:text-emerald-500/80">{candle.takerBuyVol == null ? 'N/A' : formatVol(candle.takerBuyVol)}</td>
                                                    <td className="p-4 text-right text-rose-600/80 dark:text-rose-500/80">{candle.takerSellVol == null ? 'N/A' : formatVol(candle.takerSellVol)}</td>
                                                    <td className={`p-4 text-right font-bold border-l border-slate-200 dark:border-slate-700 ${deltaColor}`}>{candle.delta == null ? 'N/A' : `${candle.delta > 0 ? '+' : ''}${formatVol(candle.delta)}`}</td>
                                                    <td className="p-4 text-center">
                                                        <div className="flex items-center justify-center gap-2">
                                                            <span className={`font-bold ${pressureColor}`}>{candle.buyPressure == null ? 'N/A' : `${candle.buyPressure.toFixed(1)}%`}</span>
                                                            <div className="w-16 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                                                                <div className={`h-full ${candle.buyPressure >= 50 ? 'bg-emerald-500' : 'bg-rose-500'}`} style={{ width: `${candle.buyPressure == null ? 0 : candle.buyPressure}%` }}></div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                            <div className="p-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/30 flex flex-col sm:flex-row items-center justify-between gap-4">
                                <div className="text-sm text-slate-500 dark:text-slate-400">Mostrando {indexOfFirstItem + 1} - {Math.min(indexOfLastItem, data.length)} de <span className="text-slate-900 dark:text-white font-bold">{data.length}</span></div>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => setCurrentPage(1)} disabled={currentPage === 1} className="p-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed transition text-xs font-medium text-slate-600 dark:text-slate-300">Inicio</button>
                                    <button onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))} disabled={currentPage === 1} className="p-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed transition"><ChevronLeft className="w-4 h-4 text-slate-600 dark:text-slate-300" /></button>

                                    {/* Selector de Página Interactivo */}
                                    <form
                                        onSubmit={(e) => {
                                            e.preventDefault();
                                            // Validar rango
                                            const val = Math.min(Math.max(parseInt(inputPage), 1), totalPages);
                                            setCurrentPage(val);
                                        }}
                                        className="flex items-center gap-2 bg-slate-100 dark:bg-slate-900 px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-700"
                                    >
                                        <span className="text-xs text-slate-500 font-medium">Página</span>
                                        <input
                                            type="number"
                                            min="1"
                                            max={totalPages}
                                            value={inputPage}
                                            onChange={(e) => setInputPage(e.target.value)}
                                            onBlur={() => {
                                                if (inputPage === "") setInputPage(currentPage);
                                                else {
                                                    const val = Math.min(Math.max(parseInt(inputPage), 1), totalPages);
                                                    setCurrentPage(val);
                                                    setInputPage(val);
                                                }
                                            }}
                                            className="w-12 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-center text-sm font-bold text-slate-900 dark:text-white focus:outline-none focus:border-blue-500 py-0.5"
                                        />
                                        <span className="text-xs text-slate-500 font-medium">de {totalPages}</span>
                                    </form>

                                    <button onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))} disabled={currentPage === totalPages} className="p-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed transition"><ChevronRight className="w-4 h-4 text-slate-600 dark:text-slate-300" /></button>
                                    <button onClick={() => setCurrentPage(totalPages)} disabled={currentPage === totalPages} className="p-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed transition text-xs font-medium text-slate-600 dark:text-slate-300">Final</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {!data.length && !loading && (
                        <div className="text-center py-20 opacity-50">
                            <Database className="w-16 h-16 mx-auto mb-4 text-slate-400 dark:text-slate-600" />
                            <p className="text-slate-500">Configura los parámetros arriba para cargar los datos.</p>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MarketInspector />);
    </script>
</body>

</html>
