<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Inversiones GO Mining</title>
    <meta name="theme-color" content="#2563eb">
    <link rel="icon" href="/pwa/logo-app.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { slate: { 850: '#1e293b', 900: '#0f172a' } } } } };
    </script>
    <script>
        (function(){try{var t=localStorage.getItem('fti_theme_preference');var d=window.matchMedia('(prefers-color-scheme: dark)').matches;if(t==='dark'||((!t||t==='system')&&d)){document.documentElement.classList.add('dark');}else{document.documentElement.classList.remove('dark');}}catch(e){}})();
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{--bg-body:#f9fafb;--text-body:#374151;--bg-card:#ffffff;--border-card:#e5e7eb;--accent-blue:#3b82f6;--accent-blue-hover:#2563eb;--progress-bg:#e5e7eb;--progress-fg:#10b981;--scrollbar-thumb:#cbd5e1;--scrollbar-thumb-hover:#94a3b8}
        html.dark{--bg-body:#0f172a;--text-body:#e2e8f0;--bg-card:#1e293b;--border-card:#334155;--accent-blue:#3b82f6;--accent-blue-hover:#60a5fa;--progress-bg:#334155;--progress-fg:#10b981;--scrollbar-thumb:#334155;--scrollbar-thumb-hover:#64748b}
        /* Estilo para la barra de desplazamiento */
        ::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb{background-color:var(--scrollbar-thumb);border-radius:4px}
        
        ::-webkit-scrollbar-thumb:hover{background-color:var(--scrollbar-thumb-hover)}
        
        body{font-family:'Inter',sans-serif;background-color:var(--bg-body);color:var(--text-body);transition:background-color .3s ease,color .3s ease}
        .card{background-color:var(--bg-card);border-radius:.75rem;padding:1.5rem;border:1px solid var(--border-card);box-shadow:0 1px 3px rgba(0,0,0,.1);transition:background-color .3s ease,border-color .3s ease}
        .form-input{width:100%;background-color:var(--bg-card);border:1px solid var(--border-card);color:var(--text-body);border-radius:.5rem;padding:.75rem 1rem;transition:border-color .2s,box-shadow .2s}
        .form-input:focus{outline:none;border-color:var(--accent-blue);box-shadow:0 0 0 3px rgba(59,130,246,.2)}
        .btn{background-color:var(--accent-blue);color:#fff;font-weight:600;padding:.75rem 1.5rem;border-radius:.5rem;transition:background-color .2s;width:100%}
        .btn:hover{background-color:var(--accent-blue-hover)}
        .progress-bar-bg{background-color:var(--progress-bg)}
        .progress-bar-fg{background-color:var(--progress-fg)}
        .tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .tag-recovering {
            background-color: #f59e0b; /* bg-amber-500 */
            color: #78350f;
        }
        .tag-recovered {
            background-color: #10b981; /* bg-green-500 */
            color: #064e3b;
        }
        .tag-expired {
            background-color: #6b7280; /* bg-gray-500 */
            color: white;
        }
        .tag-expiring {
            background-color: #f59e0b; /* bg-amber-500 */
            color: #78350f;
        }
        .tag-duration {
            background-color: #dbeafe; /* bg-blue-100 */
            color: #1e40af; /* text-blue-800 */
        }
        .tag-no-expiration {
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #1f2937; /* text-gray-800 */
        }
        /* Estilos para las pestañas */
        .tab-btn {
            cursor: pointer;
            border-bottom: 3px solid transparent;
            padding: 0.75rem 0.25rem;
            font-size: 1rem;
            font-weight: 600;
            color: #6b7280; /* text-gray-500 */
            transition: color 0.2s, border-color 0.2s;
        }
        .tab-btn:hover {
            color: #374151; /* text-gray-700 */
        }
        .tab-btn.active {
            color: #3b82f6; /* text-blue-500 */
            border-color: #3b82f6; /* border-blue-500 */
        }
        /* Estilos para el modal de confirmación */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content{background-color:var(--bg-card);padding:2rem;border-radius:.75rem;max-width:400px;width:90%;box-shadow:0 4px 6px rgba(0,0,0,.1)}
        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .modal-btn {
            flex: 1;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .modal-btn-cancel {
            background-color: #e5e7eb;
            color: #374151;
        }
        .modal-btn-cancel:hover {
            background-color: #d1d5db;
        }
        .modal-btn-confirm {
            background-color: #ef4444;
            color: white;
        }
        .modal-btn-confirm:hover{background-color:#dc2626}

        html.dark .border-gray-100{border-color:#334155!important}
        html.dark .border-gray-200{border-color:#334155!important}
        html.dark .bg-blue-50{background-color:rgba(59,130,246,.12)!important}
        html.dark .border-blue-400{border-color:#60a5fa!important}
        html.dark .text-blue-700{color:#60a5fa!important}
        html.dark .bg-blue-100{background-color:rgba(59,130,246,.12)!important}
        html.dark .text-blue-800{color:#93c5fd!important}
        html.dark .bg-white{background-color:var(--bg-card)!important}
        html.dark .bg-gray-50{background-color:rgba(255,255,255,.04)!important}
        html.dark .bg-gray-100{background-color:rgba(255,255,255,.06)!important}
        html.dark .text-gray-900{color:#f1f5f9!important}
        html.dark .text-gray-800{color:#e2e8f0!important}
        html.dark .text-gray-700{color:#cbd5e1!important}
        html.dark .text-gray-600{color:#94a3b8!important}
        html.dark .text-gray-500{color:#94a3b8!important}
        html.dark .text-gray-400{color:#94a3b8!important}

        html.dark .tab-btn{color:#94a3b8}
        html.dark .tab-btn:hover{color:#e2e8f0}
        html.dark .tab-btn.active{color:#60a5fa;border-color:#60a5fa}

        html.dark .modal-btn-cancel{background-color:#334155;color:#e2e8f0}
        html.dark .modal-btn-cancel:hover{background-color:#475569}

        html.dark #toggle-roi-table{background-color:var(--bg-card)!important;color:var(--text-body)!important;border-color:var(--border-card)!important}
        html.dark #toggle-roi-table:hover{background-color:rgba(255,255,255,.06)!important}

        #toast-container{position:fixed;top:1rem;right:1rem;z-index:100;display:flex;flex-direction:column;gap:.75rem;max-width:calc(100vw - 2rem)}
        .toast{width:352px;max-width:calc(100vw - 2rem);background-color:var(--bg-card);border:1px solid var(--border-card);border-radius:.75rem;box-shadow:0 10px 25px rgba(0,0,0,.12);overflow:hidden}
        .toast-row{display:flex;gap:.75rem;align-items:flex-start;padding:1rem}
        .toast-icon{height:36px;width:36px;border-radius:.5rem;display:flex;align-items:center;justify-content:center;flex:none}
        .toast-body{min-width:0;flex:1}
        .toast-title{font-weight:700;color:var(--text-body)}
        .toast-message{margin-top:.125rem;font-size:.875rem;color:var(--text-body);opacity:.9}
        .toast-close{border:none;background:transparent;color:#94a3b8;cursor:pointer;padding:0;line-height:0}
        .toast-close:hover{color:var(--text-body)}
        .toast-bar{height:4px;width:100%;background-color:rgba(148,163,184,.25)}
        .toast-bar > div{height:4px;width:100%;transform-origin:left;animation:toastBar 4s linear forwards}
        .toast--success .toast-icon{background-color:rgba(16,185,129,.12);color:#10b981}
        .toast--success .toast-bar > div{background-color:#10b981}
        .toast--error .toast-icon{background-color:rgba(239,68,68,.12);color:#ef4444}
        .toast--error .toast-bar > div{background-color:#ef4444}
        .toast--info .toast-icon{background-color:rgba(59,130,246,.12);color:#3b82f6}
        .toast--info .toast-bar > div{background-color:#3b82f6}
        .spinner{height:16px;width:16px;animation:spin .9s linear infinite}
        @keyframes toastBar{from{transform:scaleX(1)}to{transform:scaleX(0)}}
        @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Panel de Control - GO Mining</h1>
            <p class="text-gray-600 mt-2">Registra y monitorea el rendimiento de los activos.</p>
        </header>

        <!-- Navegación de Pestañas -->
        <div class="mb-8 border-b border-gray-200 overflow-hidden">
            <div class="overflow-x-auto" style="scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent;">
                <nav class="-mb-px flex space-x-6 min-w-max px-1 pb-2" aria-label="Tabs">
                    <a href="../index.html" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 text-gray-600 hover:bg-blue-500 hover:text-white transition-colors" title="Volver a Inversiones">
                        <i class="fas fa-arrow-left text-lg"></i>
                    </a>
                    <button id="tab-btn-register" class="tab-btn active whitespace-nowrap">Registrar</button>
                    <button id="tab-btn-history" class="tab-btn whitespace-nowrap">Historial</button>
                    <button id="tab-btn-summary" class="tab-btn whitespace-nowrap">Resumen</button>
                    <button id="tab-btn-storage" class="tab-btn whitespace-nowrap">Almacenamiento</button>
                </nav>
            </div>
        </div>

        <main id="tab-content-wrapper">
            <!-- Pestaña de Registro -->
            <div id="tab-content-register" class="tab-content-item">
                <div class="card max-w-lg mx-auto">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Registrar Nueva Inversión</h2>
                    <form id="investment-form" class="space-y-4">
                        <div>
                            <label for="investment-name" class="block text-sm font-medium text-gray-600 mb-1">Nombre Inversión</label>
                            <input type="text" id="investment-name" class="form-input" placeholder="Ej: Minero ASIC S19" required>
                        </div>
                        <div>
                            <label for="registration-date" class="block text-sm font-medium text-gray-600 mb-1">Fecha de Registro</label>
                            <input type="date" id="registration-date" class="form-input" required>
                        </div>
                        <div>
                            <label for="cost" class="block text-sm font-medium text-gray-600 mb-1">Costo (MXN)</label>
                            <input type="number" id="cost" class="form-input" placeholder="Ej: 5000.00" required step="0.01">
                        </div>
                        <div>
                            <label for="daily-income" class="block text-sm font-medium text-gray-600 mb-1">Ingreso Diario (MXN)</label>
                            <input type="number" id="daily-income" class="form-input" placeholder="Ej: 50.00" required step="0.01">
                        </div>
                        <div>
                            <label class="flex items-center space-x-2 text-sm font-medium text-gray-600 mb-1">
                                <input type="checkbox" id="has-expiration" class="form-checkbox h-4 w-4 text-blue-600">
                                <span>¿Vencimiento?</span>
                            </label>
                        </div>
                        <div id="expiration-duration" class="hidden">
                            <label for="duration" class="block text-sm font-medium text-gray-600 mb-1">Duración</label>
                            <select id="duration" class="form-input" disabled>
                                <option value="1m">1 mes</option>
                                <option value="3m">3 meses</option>
                                <option value="6m">6 meses</option>
                                <option value="1y">1 año</option>
                                <option value="2y">2 años</option>
                                <option value="3y">3 años</option>
                            </select>
                        </div>
                        <div>
                            <label for="note" class="block text-sm font-medium text-gray-600 mb-1">Nota (Opcional)</label>
                            <textarea id="note" class="form-input" placeholder="Anotaciones sobre esta inversión..." rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn">Agregar Inversión</button>
                    </form>
                </div>
            </div>

            <!-- Pestaña de Historial -->
            <div id="tab-content-history" class="tab-content-item hidden">
                 <div class="card h-full">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Historial de Inversiones</h2>
                    <div id="investment-history" class="space-y-6">
                        <!-- Las inversiones se insertarán aquí dinámicamente -->
                        <p class="text-gray-500 text-center py-8">No hay inversiones registradas aún.</p>
                    </div>
                </div>
            </div>

            <!-- Pestaña de Resumen -->
            <div id="tab-content-summary" class="tab-content-item hidden">
                <div class="card max-w-lg mx-auto">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Resumen General</h2>
                    <div id="summary-details" class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Tiempo desde la primera inversión:</span>
                            <span id="time-since-first-investment" class="text-xl font-bold text-purple-600"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Costo Total Invertido:</span>
                            <span id="total-cost" class="text-xl font-bold text-gray-800"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Total Recuperado:</span>
                            <span id="total-recovered" class="text-xl font-bold text-green-600"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">ROI anualizado:</span>
                            <span id="annualized-roi" class="text-xl font-bold text-indigo-600"></span>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-gray-600">Evaluación del ROI:</span>
                            <div class="flex items-center gap-3">
                                <span id="roi-evaluation" class="text-xl font-bold text-gray-800">N/A</span>
                                <button id="toggle-roi-table" class="text-sm px-3 py-1 rounded-md border border-gray-200 bg-white hover:bg-gray-50">Mostrar referencia</button>
                            </div>
                        </div>
                        <div class="text-sm text-gray-600 mt-2" id="roi-eval-note">Comparando el ROI anualizado con una tabla de referencia para indicar si el rendimiento es malo, aceptable, bueno o excelente.</div>
                        <!-- Modal overlay para la tabla de referencia -->
                        <div id="roi-reference-table" class="modal-overlay" aria-hidden="true">
                            <div class="modal-content max-w-2xl w-11/12">
                                    <div class="flex justify-between items-center gap-4">
                                        <h3 class="text-lg font-semibold text-gray-800 flex-1">Tabla de evaluación del ROI</h3>
                                        <button id="close-roi-table" class="modal-btn modal-btn-cancel px-3 py-1 text-sm">Cerrar</button>
                                    </div>
                                <div class="mt-4 overflow-auto" style="max-height:60vh">
                                    <table class="w-full text-sm border-collapse">
                                        <thead>
                                            <tr>
                                                <th class="text-left pb-2">Categoría</th>
                                                <th class="text-left pb-2">Rango anualizado</th>
                                                <th class="text-left pb-2">Comentario</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class="border-t"><td class="py-2">Malo</td><td class="py-2">&lt; 5%</td><td class="py-2">Por debajo de la inflación o bonos de bajo riesgo</td></tr>
                                            <tr class="border-t"><td class="py-2">Aceptable</td><td class="py-2">5–10%</td><td class="py-2">Similar a índices diversificados (ej. S&amp;P 500)</td></tr>
                                            <tr class="border-t"><td class="py-2">Bueno</td><td class="py-2">10–20%</td><td class="py-2">Sobre el promedio histórico; buen rendimiento</td></tr>
                                            <tr class="border-t"><td class="py-2">Excelente</td><td class="py-2">&gt; 20%</td><td class="py-2">Alto retorno (arriesgado)</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Ingresos Diarios Totales:</span>
                            <span id="total-daily-income" class="text-xl font-bold text-green-600"></span>
                        </div>
                        <hr class="border-gray-200">
                        <div class="bg-gray-50 p-4 rounded-lg space-y-3">
                            <h3 class="text-lg font-semibold text-gray-700 mb-2">Análisis de Ingresos</h3>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Últimos 7 días:</span>
                                <span id="last-7-days-income" class="text-lg font-semibold text-green-600"></span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Últimas 2 semanas:</span>
                                <span id="last-2-weeks-income" class="text-lg font-semibold text-green-600"></span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Último mes:</span>
                                <span id="last-month-income" class="text-lg font-semibold text-green-600"></span>
                            </div>
                        </div>
                        <hr class="border-gray-200">
                        <div class="text-center">
                            <span class="text-gray-600 text-sm">Como referencia, si quisieras recuperar el costo total de todas tus inversiones, en base al ingreso diario, tardarías aproximadamente:</span>
                            <p id="total-roi" class="text-2xl font-bold text-blue-600"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pestaña de Almacenamiento -->
            <div id="tab-content-storage" class="tab-content-item hidden">
                <div class="card max-w-lg mx-auto">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Uso de Almacenamiento</h2>
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4 rounded">
                        <p class="text-sm text-blue-700">
                            <i class="fas fa-info-circle mr-2"></i>
                            Los datos se almacenan localmente en LocalStorage.
                        </p>
                    </div>
                    <div id="storage-details" class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Espacio Total Usado:</span>
                            <span id="total-storage" class="text-xl font-bold text-blue-600"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Número de Registros:</span>
                            <span id="total-records" class="text-xl font-bold text-gray-800"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Última Actualización:</span>
                            <span id="last-update" class="text-xl font-bold text-gray-800"></span>
                        </div>
                        <hr class="border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <button id="download-data" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                                Descargar Datos
                            </button>
                            <div class="relative">
                                <input type="file" id="import-data" accept=".json" class="hidden">
                                <button id="import-data-btn" class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" transform="rotate(180 10 10)" />
                                    </svg>
                                    Importar Datos
                                </button>
                            </div>
                        </div>
                        <div class="mt-4">
                            <button id="backup-to-discord" class="w-full bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition-colors flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M20.317 4.492c-1.53-.69-3.17-1.2-4.885-1.49a.075.075 0 0 0-.079.036c-.21.369-.444.85-.608 1.23a18.566 18.566 0 0 0-5.487 0 12.36 12.36 0 0 0-.617-1.23A.077.077 0 0 0 8.562 3c-1.714.29-3.354.8-4.885 1.491a.07.07 0 0 0-.032.027C.533 9.093-.32 13.555.099 17.961a.08.08 0 0 0 .031.055 20.03 20.03 0 0 0 5.993 2.98.078.078 0 0 0 .084-.026 13.83 13.83 0 0 0 1.226-1.963.074.074 0 0 0-.041-.104 13.175 13.175 0 0 1-1.872-.878.075.075 0 0 1-.008-.125c.126-.093.252-.19.372-.287a.075.075 0 0 1 .078-.01c3.927 1.764 8.18 1.764 12.061 0a.075.075 0 0 1 .079.009c.12.098.245.195.372.288a.075.075 0 0 1-.006.125c-.598.344-1.22.635-1.873.877a.075.075 0 0 0-.041.105c.36.687.772 1.341 1.225 1.962a.077.077 0 0 0 .084.028 19.963 19.963 0 0 0 6.002-2.981.076.076 0 0 0 .032-.054c.5-5.094-.838-9.52-3.549-13.442a.06.06 0 0 0-.031-.028zM8.02 15.278c-1.182 0-2.157-1.069-2.157-2.38 0-1.312.956-2.38 2.157-2.38 1.21 0 2.176 1.077 2.157 2.38 0 1.312-.956 2.38-2.157 2.38zm7.975 0c-1.183 0-2.157-1.069-2.157-2.38 0-1.312.955-2.38 2.157-2.38 1.21 0 2.176 1.077 2.157 2.38 0 1.312-.946 2.38-2.157 2.38z"></path>
                                </svg>
                                Respaldar en Discord
                        </button>
                            <div id="webhook-config" class="mt-4">
                                <label for="discord-webhook" class="block text-sm font-medium text-gray-600 mb-1">URL del Webhook de Discord</label>
                                <input type="url" id="discord-webhook" placeholder="https://discord.com/api/webhooks/..." class="form-input mb-2" autocomplete="off" inputmode="url">
                                <div class="flex justify-end">
                                    <button id="save-webhook" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition-colors text-sm">
                                        Guardar URL
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-4">
                            <button id="clear-storage" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                                Limpiar Almacenamiento
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
            document.addEventListener('DOMContentLoaded', () => {
                const investmentForm = document.getElementById('investment-form');
                const investmentHistory = document.getElementById('investment-history');
                
                const totalCostEl = document.getElementById('total-cost');
                const totalDailyIncomeEl = document.getElementById('total-daily-income');
                const totalRoiEl = document.getElementById('total-roi');

                // Manejar el checkbox de vencimiento
                const hasExpirationCheckbox = document.getElementById('has-expiration');
                const durationSelect = document.getElementById('duration');
                const expirationDurationDiv = document.getElementById('expiration-duration');

                hasExpirationCheckbox.addEventListener('change', (e) => {
                    expirationDurationDiv.classList.toggle('hidden', !e.target.checked);
                    durationSelect.disabled = !e.target.checked;
                });            let investments = JSON.parse(localStorage.getItem('goMiningInvestments')) || [];

            // Lógica para Pestañas
            const tabs = [
                { btn: document.getElementById('tab-btn-register'), content: document.getElementById('tab-content-register') },
                { btn: document.getElementById('tab-btn-history'), content: document.getElementById('tab-content-history') },
                { btn: document.getElementById('tab-btn-summary'), content: document.getElementById('tab-content-summary') },
                { btn: document.getElementById('tab-btn-storage'), content: document.getElementById('tab-content-storage') }
            ];

            const switchTab = (activeBtn) => {
                tabs.forEach(tab => {
                    const isTabActive = tab.btn === activeBtn;
                    tab.btn.classList.toggle('active', isTabActive);
                    tab.content.classList.toggle('hidden', !isTabActive);
                });
            };

            tabs.forEach(tab => {
                tab.btn.addEventListener('click', () => switchTab(tab.btn));
            });
            // Fin Lógica para Pestañas

            // Formateador de moneda para MXN
            const currencyFormatter = new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            });

            const discordWebhookInput = document.getElementById('discord-webhook');
            const saveWebhookBtn = document.getElementById('save-webhook');
            const backupToDiscordBtn = document.getElementById('backup-to-discord');
            let discordWebhookUrl = localStorage.getItem('goMiningWebhook') || '';
            if (discordWebhookInput && discordWebhookUrl) discordWebhookInput.value = discordWebhookUrl;

            const setButtonBusy = (btn, busyText, isBusy) => {
                if (!btn) return;
                if (isBusy) {
                    if (!btn.dataset.originalHtml) btn.dataset.originalHtml = btn.innerHTML;
                    btn.disabled = true;
                    btn.classList.add('opacity-70', 'cursor-not-allowed');
                    btn.innerHTML = `
                        <span class="inline-flex items-center justify-center gap-2">
                            <svg class="spinner" viewBox="0 0 24 24" fill="none">
                                <circle style="opacity:.25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path style="opacity:.75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                            </svg>
                            <span>${busyText}</span>
                        </span>
                    `;
                } else {
                    btn.disabled = false;
                    btn.classList.remove('opacity-70', 'cursor-not-allowed');
                    if (btn.dataset.originalHtml) btn.innerHTML = btn.dataset.originalHtml;
                }
            };

            const showToast = ({ type, title, message }) => {
                const container = document.getElementById('toast-container');
                if (!container) return;

                const toast = document.createElement('div');
                toast.className = `toast toast--${type || 'info'}`;

                const iconSvg = type === 'success'
                    ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>'
                    : type === 'error'
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>'
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 2a10 10 0 100 20 10 10 0 000-20z"/></svg>';

                toast.innerHTML = `
                    <div class="toast-row">
                        <div class="toast-icon">${iconSvg}</div>
                        <div class="toast-body">
                            <div class="toast-title">${title || ''}</div>
                            <div class="toast-message">${message || ''}</div>
                        </div>
                        <button type="button" class="toast-close" aria-label="Cerrar">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                    <div class="toast-bar"><div></div></div>
                `;

                container.appendChild(toast);
                const closeBtn = toast.querySelector('button');
                const close = () => {
                    toast.style.transition = 'opacity .2s ease, transform .2s ease';
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateY(-6px)';
                    window.setTimeout(() => toast.remove(), 220);
                };
                if (closeBtn) closeBtn.addEventListener('click', close);
                window.setTimeout(close, 4200);
            };

            const validateDiscordWebhookUrl = (url) => {
                const trimmed = (url || '').trim();
                if (!trimmed) return { ok: true, value: '' };
                const isDiscordWebhook = /^https:\/\/(?:canary\.|ptb\.)?discord(?:app)?\.com\/api\/webhooks\//i.test(trimmed);
                if (!isDiscordWebhook) return { ok: false, value: trimmed };
                return { ok: true, value: trimmed };
            };

            // Función principal para renderizar todo
            const renderApp = () => {
                renderHistory();
                renderSummary();
            };

            // Renderizar el historial de inversiones
            const renderHistory = () => {
                investmentHistory.innerHTML = '';
                if (investments.length === 0) {
                    investmentHistory.innerHTML = '<p class="text-gray-500 text-center py-8">No hay inversiones registradas aún.</p>';
                    return;
                }
                const sortedInvestments = [...investments].sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedInvestments.forEach(inv => {
                    const now = new Date();
                    now.setUTCHours(0, 0, 0, 0);
                    
                    // Ordenar el historial de ingresos por fecha
                    const incomeHistory = inv.incomeHistory ? 
                        [...inv.incomeHistory].sort((a, b) => new Date(a.date) - new Date(b.date)) :
                        [{ date: inv.date, dailyIncome: inv.dailyIncome }];
                    
                    // Calcular ganancias totales considerando los cambios de tasa y fecha de vencimiento
                    let totalEarned = 0;
                    let currentDate = new Date(inv.date);
                    currentDate.setUTCHours(0, 0, 0, 0);
                    
                    // Determinar la fecha límite para el cálculo (fecha de vencimiento o fecha actual)
                    let limitDate = now;
                    if (inv.hasExpiration) {
                        const expirationDate = new Date(inv.expirationDate);
                        expirationDate.setUTCHours(0, 0, 0, 0);
                        limitDate = expirationDate < now ? expirationDate : now;
                    }
                    
                    for (let i = 0; i < incomeHistory.length; i++) {
                        const currentRate = incomeHistory[i];
                        const nextRate = incomeHistory[i + 1];
                        let endDate = nextRate ? new Date(nextRate.date) : limitDate;
                        endDate.setUTCHours(0, 0, 0, 0);
                        
                        // Si la fecha de fin supera el límite, usar el límite
                        if (endDate > limitDate) {
                            endDate = limitDate;
                        }
                        
                        // Solo calcular si no hemos superado la fecha límite
                        if (currentDate < limitDate) {
                            const periodDays = Math.max(0, Math.floor((endDate - currentDate) / (1000 * 60 * 60 * 24)));
                            totalEarned += periodDays * currentRate.dailyIncome;
                        }
                    
                    currentDate = new Date(endDate);
                }
                
                const daysPassed = Math.max(0, Math.floor((now - new Date(inv.date)) / (1000 * 60 * 60 * 24)));
                const recoveryPercentage = Math.min((totalEarned / inv.cost) * 100, 100);
                const isRecovered = totalEarned >= inv.cost;
                const timeToRecover = Math.ceil(inv.cost / inv.dailyIncome);

                // Manejar estado de vencimiento y duración
                let statusTag = '';
                let durationTag = '';
                let estimatedNetProfit = null;
                
                if (inv.hasExpiration) {
                    const expirationDate = new Date(inv.expirationDate);
                    const startDate = new Date(inv.date);
                    const isExpired = now > expirationDate;
                    const daysToExpiration = Math.ceil((expirationDate - now) / (1000 * 60 * 60 * 24));
                    
                    // Calcular duración total en días
                    const totalDuration = Math.ceil((expirationDate - startDate) / (1000 * 60 * 60 * 24));
                    
                    // Formatear duración para mostrar
                    let durationText = '';
                    if (totalDuration >= 365) {
                        const years = Math.floor(totalDuration / 365);
                        durationText = years === 1 ? '1 año' : `${years} años`;
                    } else if (totalDuration >= 30) {
                        const months = Math.floor(totalDuration / 30);
                        durationText = months === 1 ? '1 mes' : `${months} meses`;
                    } else {
                        durationText = `${totalDuration} días`;
                    }
                    
                    durationTag = `<span class="tag bg-blue-100 text-blue-800">Duración: ${durationText}</span>`;
                    
                    if (isExpired) {
                        statusTag = `<span class="tag tag-expired">Vencida</span>`;
                    } else {
                        statusTag = `<span class="tag tag-expiring">Vence en ${daysToExpiration} días</span>`;
                        // Calcular ganancia neta estimada al vencimiento
                        estimatedNetProfit = (totalDuration * inv.dailyIncome) - inv.cost;
                    }
                    
                    if (isRecovered) {
                        statusTag += ` <span class="tag tag-recovered">Recuperada</span>`;
                    }
                } else {
                    durationTag = `<span class="tag bg-gray-100 text-gray-800">Sin vencimiento</span>`;
                    statusTag = isRecovered
                        ? `<span class="tag tag-recovered">Recuperado</span>`
                        : `<span class="tag tag-recovering">En recuperación</span>`;
                }                    const investmentEl = document.createElement('div');
                    investmentEl.className = 'p-5 rounded-lg border border-gray-200 bg-gray-50 space-y-3';
                    
                    investmentEl.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="flex items-center gap-3">
                                    <h3 class="text-xl font-semibold text-gray-800">${inv.name}</h3>
                                    ${statusTag}
                                </div>
                                <div class="flex items-center gap-2 mt-1">
                                    ${durationTag}
                                </div>
                                <p class="text-sm text-gray-600 mt-1">Registrado: ${new Date(inv.date).toLocaleDateString('es-MX', { timeZone: 'UTC' })}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-bold text-blue-600">${currencyFormatter.format(inv.cost)}</p>
                                <p class="text-sm text-green-600">+${currencyFormatter.format(inv.dailyIncome)} / día</p>
                                <div class="flex justify-end gap-2 mt-2">
                                    <button class="edit-investment text-blue-600 hover:text-blue-800 p-1.5 rounded-lg border border-blue-200 hover:bg-blue-50 transition-colors" data-id="${inv.id}">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                        </svg>
                                    </button>
                                    <button class="delete-investment text-red-600 hover:text-red-800 p-1.5 rounded-lg border border-red-200 hover:bg-red-50 transition-colors" data-id="${inv.id}">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        ${inv.note ? `<p class="text-gray-700 pt-2 border-t border-gray-200"><em>Nota: ${inv.note}</em></p>` : ''}
                        <div class="space-y-2 pt-2">
                             <div class="w-full progress-bar-bg rounded-full h-2.5">
                                <div class="progress-bar-fg h-2.5 rounded-full" style="width: ${recoveryPercentage}%"></div>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Progreso de recuperación</span>
                                <span>${recoveryPercentage.toFixed(2)}%</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center pt-2 text-sm">
                            <div>
                                <p class="font-semibold text-gray-800">${daysPassed} días</p>
                                <p class="text-gray-600">Tiempo transcurrido</p>
                            </div>
                             <div>
                                <p class="font-semibold text-gray-800">${currencyFormatter.format(totalEarned)}</p>
                                <p class="text-gray-600">Monto recuperado</p>
                            </div>
                             <div>
                                <p class="font-semibold text-gray-800">${timeToRecover} días</p>
                                <p class="text-gray-600">ROI esperado</p>
                            </div>
                        </div>
                    `;
                    investmentHistory.appendChild(investmentEl);
                });
            };

            // Función para calcular ingresos en un período específico
            const calculatePeriodIncome = (days) => {
                const now = new Date();
                now.setUTCHours(0, 0, 0, 0);
                const startDate = new Date(now);
                startDate.setDate(startDate.getDate() - days);

                return investments.reduce((total, inv) => {
                    const investmentStartDate = new Date(inv.date);
                    investmentStartDate.setUTCHours(0, 0, 0, 0);
                    
                    // Si la inversión tiene vencimiento, verificar si ya venció
                    if (inv.hasExpiration) {
                        const expirationDate = new Date(inv.expirationDate);
                        expirationDate.setUTCHours(0, 0, 0, 0);
                        
                        // Si ya venció, calcular solo hasta la fecha de vencimiento
                        if (now > expirationDate) {
                            if (expirationDate < startDate) {
                                return total; // La inversión venció antes del período
                            }
                            // Calcular solo los días hasta el vencimiento
                            const daysToExpiration = Math.floor((expirationDate - startDate) / (1000 * 60 * 60 * 24));
                            return total + (Math.min(days, daysToExpiration) * inv.dailyIncome);
                        }
                    }
                    
                    // Para inversiones sin vencimiento o aún no vencidas
                    if (investmentStartDate > startDate) {
                        const daysActive = Math.floor((now - investmentStartDate) / (1000 * 60 * 60 * 24));
                        return total + (daysActive * inv.dailyIncome);
                    }
                    
                    return total + (days * inv.dailyIncome);
                }, 0);
            };

            // Función para formatear un lapso de tiempo en días a un formato legible
            const formatTimeSpan = (days) => {
                if (days >= 365) {
                    const years = Math.floor(days / 365);
                    const remainingMonths = Math.floor((days % 365) / 30);
                    let result = `${years} ${years === 1 ? 'año' : 'años'}`;
                    if (remainingMonths > 0) {
                        result += ` y ${remainingMonths} ${remainingMonths === 1 ? 'mes' : 'meses'}`;
                    }
                    return result;
                } else if (days >= 30) {
                    const months = Math.floor(days / 30);
                    return `${months} ${months === 1 ? 'mes' : 'meses'}`;
                } else {
                    return `${days} ${days === 1 ? 'día' : 'días'}`;
                }
            };

            // Renderizar el resumen general
            const renderSummary = () => {
                const now = new Date();
                now.setUTCHours(0, 0, 0, 0);

                // Filtrar inversiones expiradas para los cálculos de ingresos diarios
                const activeInvestments = investments.filter(inv => {
                    if (!inv.hasExpiration) return true;
                    const expirationDate = new Date(inv.expirationDate);
                    return now <= expirationDate;
                });

                const totalCost = investments.reduce((sum, inv) => sum + inv.cost, 0);
                const totalDaily = activeInvestments.reduce((sum, inv) => sum + inv.dailyIncome, 0);
                
                // Calcular el total recuperado de todas las inversiones
                const totalRecovered = investments.reduce((total, inv) => {
                    let investmentEarned = 0;
                    let currentDate = new Date(inv.date);
                    currentDate.setUTCHours(0, 0, 0, 0);

                    let limitDate = now;
                    if (inv.hasExpiration) {
                        const expirationDate = new Date(inv.expirationDate);
                        expirationDate.setUTCHours(0, 0, 0, 0);
                        if (expirationDate < limitDate) {
                            limitDate = expirationDate;
                        }
                    }

                    const incomeHistory = inv.incomeHistory ? 
                        [...inv.incomeHistory].sort((a, b) => new Date(a.date) - new Date(b.date)) :
                        [{ date: inv.date, dailyIncome: inv.dailyIncome }];

                    for (let i = 0; i < incomeHistory.length; i++) {
                        const currentRate = incomeHistory[i];
                        const nextRate = incomeHistory[i + 1];
                        let endDate = nextRate ? new Date(nextRate.date) : limitDate;
                        endDate.setUTCHours(0, 0, 0, 0);

                        if (endDate > limitDate) {
                            endDate = limitDate;
                        }

                        if (currentDate < limitDate) {
                            const periodDays = Math.max(0, Math.floor((endDate - currentDate) / (1000 * 60 * 60 * 24)));
                            investmentEarned += periodDays * currentRate.dailyIncome;
                        }
                        currentDate = new Date(endDate);
                    }
                    return total + investmentEarned;
                }, 0);

                // Calcular tiempo desde la primera inversión
                let timeSinceFirstInvestment = 'N/A';
                if (investments.length > 0) {
                    const firstInvestmentDate = investments.reduce((oldest, inv) => {
                        const invDate = new Date(inv.date);
                        return invDate < oldest ? invDate : oldest;
                    }, new Date());
                    const days = Math.floor((now - firstInvestmentDate) / (1000 * 60 * 60 * 24));
                    timeSinceFirstInvestment = formatTimeSpan(days);
                }

                // Calcular ingresos para diferentes períodos
                const last7DaysIncome = calculatePeriodIncome(7);
                const last2WeeksIncome = calculatePeriodIncome(14);
                const lastMonthIncome = calculatePeriodIncome(30);

                // Actualizar elementos en la UI
                document.getElementById('time-since-first-investment').textContent = timeSinceFirstInvestment;
                totalCostEl.textContent = currencyFormatter.format(totalCost);
                document.getElementById('total-recovered').textContent = currencyFormatter.format(totalRecovered);
                totalDailyIncomeEl.textContent = `${currencyFormatter.format(totalDaily)} / día`;
                document.getElementById('last-7-days-income').textContent = currencyFormatter.format(last7DaysIncome);
                document.getElementById('last-2-weeks-income').textContent = currencyFormatter.format(last2WeeksIncome);
                document.getElementById('last-month-income').textContent = currencyFormatter.format(lastMonthIncome);

                if (totalDaily > 0) {
                    const totalRoiDays = Math.ceil(totalCost / totalDaily);
                    totalRoiEl.textContent = `${totalRoiDays} días`;
                } else {
                    totalRoiEl.textContent = 'N/A';
                }

                // Calcular ROI anualizado (CAGR) correctamente usando crecimiento compuesto
                // Fórmula: CAGR = (ValorFinal / ValorInicial)^(1 / años) - 1
                const msDay = 1000 * 60 * 60 * 24;
                let annualizedRoiText = 'N/A';
                if (totalCost > 0 && investments.length > 0) {
                    // Determinar la fecha de la primera inversión (usa la más antigua)
                    const firstInvestmentDate = investments.reduce((oldest, inv) => {
                        const invDate = new Date(inv.date);
                        return invDate < oldest ? invDate : oldest;
                    }, new Date());

                    const daysSinceFirst = Math.max(1, Math.floor((now - firstInvestmentDate) / msDay));
                    const years = daysSinceFirst / 365; // aproximación razonable

                    if (years > 0 && totalRecovered > 0) {
                        const totalReturnRatio = totalRecovered / totalCost;
                        // Evitar casos inválidos (ratio <= 0)
                        if (totalReturnRatio > 0) {
                            const cagr = Math.pow(totalReturnRatio, 1 / years) - 1;
                            annualizedRoiText = `${(cagr * 100).toFixed(2)}%`;
                        }
                    }
                }

                const annualizedEl = document.getElementById('annualized-roi');
                if (annualizedEl) {
                    annualizedEl.textContent = annualizedRoiText;
                    // colorear según positivo/negativo para dar feedback visual
                    if (annualizedRoiText !== 'N/A') {
                        const value = parseFloat(annualizedRoiText.replace('%', ''));
                        annualizedEl.classList.remove('text-green-600', 'text-red-600');
                        if (value >= 0) {
                            annualizedEl.classList.add('text-green-600');
                        } else {
                            annualizedEl.classList.add('text-red-600');
                        }
                    }
                }

                // Evaluar el ROI anualizado contra la tabla de referencia
                const roiEvalEl = document.getElementById('roi-evaluation');
                const roiNoteEl = document.getElementById('roi-eval-note');
                if (roiEvalEl) {
                    if (annualizedRoiText === 'N/A') {
                        roiEvalEl.textContent = 'N/A';
                        roiEvalEl.className = 'text-xl font-bold text-gray-800';
                        if (roiNoteEl) roiNoteEl.textContent = 'No hay suficientes datos para evaluar el ROI.';
                    } else {
                        const roiValue = parseFloat(annualizedRoiText.replace('%', ''));
                        let verdict = '';
                        let colorClass = 'text-gray-800';
                        let note = '';

                        // Tabla de referencia:
                        // Malo: < 5%
                        // Aceptable: 5–10%
                        // Bueno: 10–20%
                        // Excelente: >20%
                        if (roiValue < 5) {
                            verdict = 'Malo';
                            colorClass = 'text-red-600';
                            note = 'ROI por debajo de la inflación o de bonos de bajo riesgo.';
                        } else if (roiValue < 10) {
                            verdict = 'Aceptable';
                            colorClass = 'text-yellow-600';
                            note = 'Rendimiento similar a índices diversificados (ej. S&P 500).';
                        } else if (roiValue < 20) {
                            verdict = 'Bueno';
                            colorClass = 'text-green-600';
                            note = 'Sobre el promedio histórico; buen rendimiento.';
                        } else {
                            verdict = 'Excelente';
                            colorClass = 'text-indigo-600';
                            note = 'Alto retorno (arriesgado). Revisa la volatilidad y riesgos asociados.';
                        }

                        // Mostrar solo el veredicto (sin repetir el porcentaje)
                        roiEvalEl.textContent = verdict;
                        roiEvalEl.className = `text-xl font-bold ${colorClass}`;
                        if (roiNoteEl) roiNoteEl.textContent = note;
                    }
                }
                // Toggle para abrir el modal de referencia
                const toggleBtn = document.getElementById('toggle-roi-table');
                const roiTable = document.getElementById('roi-reference-table');
                const closeBtn = document.getElementById('close-roi-table');
                if (toggleBtn && roiTable) {
                    toggleBtn.addEventListener('click', () => {
                        roiTable.classList.add('active');
                        roiTable.setAttribute('aria-hidden', 'false');
                    });
                }

                if (closeBtn && roiTable) {
                    closeBtn.addEventListener('click', () => {
                        roiTable.classList.remove('active');
                        roiTable.setAttribute('aria-hidden', 'true');
                    });
                }

                // Cerrar modal al hacer click fuera del contenido
                if (roiTable) {
                    roiTable.addEventListener('click', (e) => {
                        if (e.target === roiTable) {
                            roiTable.classList.remove('active');
                            roiTable.setAttribute('aria-hidden', 'true');
                        }
                    });
                }
            };
            
            // Manejar el envío del formulario
            investmentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('investment-name').value.trim();
                const registrationDate = document.getElementById('registration-date').value;
                const cost = parseFloat(document.getElementById('cost').value);
                const dailyIncome = parseFloat(document.getElementById('daily-income').value);
                const note = document.getElementById('note').value;

                if (!name || !registrationDate) {
                    alert('El nombre y la fecha de registro son obligatorios.');
                    return;
                }

                if (isNaN(cost) || isNaN(dailyIncome) || cost <= 0 || dailyIncome <= 0) {
                    alert('Por favor, ingresa valores válidos para costo e ingreso diario.');
                    return;
                }
                // Calcular fecha de vencimiento si está habilitada
                let expirationDate = null;
                if (hasExpirationCheckbox.checked) {
                    const duration = durationSelect.value;
                    const startDate = new Date(registrationDate);
                    expirationDate = new Date(startDate);
                    
                    switch(duration) {
                        case '1m': expirationDate.setMonth(startDate.getMonth() + 1); break;
                        case '3m': expirationDate.setMonth(startDate.getMonth() + 3); break;
                        case '6m': expirationDate.setMonth(startDate.getMonth() + 6); break;
                        case '1y': expirationDate.setFullYear(startDate.getFullYear() + 1); break;
                        case '2y': expirationDate.setFullYear(startDate.getFullYear() + 2); break;
                        case '3y': expirationDate.setFullYear(startDate.getFullYear() + 3); break;
                    }
                }

                const newInvestment = {
                    id: Date.now(),
                    name: name,
                    cost: cost,
                    dailyIncome: dailyIncome,
                    note: note,
                    date: registrationDate,
                    hasExpiration: hasExpirationCheckbox.checked,
                    expirationDate: expirationDate ? expirationDate.toISOString().split('T')[0] : null,
                    incomeHistory: [{
                        date: registrationDate,
                        dailyIncome: dailyIncome
                    }]
                };
                investments.push(newInvestment);
                localStorage.setItem('goMiningInvestments', JSON.stringify(investments));
                investmentForm.reset();
                renderApp();
                // Opcional: cambiar a la pestaña de historial después de registrar
                switchTab(document.getElementById('tab-btn-history'));
            });

            // Funcionalidad de editar y eliminar inversión
            investmentHistory.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-investment');
                const editBtn = e.target.closest('.edit-investment');
                
                if (deleteBtn) {
                    const investmentId = parseInt(deleteBtn.dataset.id);
                    const confirmed = await showDeleteConfirmationModal(investmentId);
                    
                    if (confirmed) {
                        investments = investments.filter(inv => inv.id !== investmentId);
                        localStorage.setItem('btcMiningInvestments', JSON.stringify(investments));
                        renderApp();
                    }
                } else if (editBtn) {
                    const investmentId = parseInt(editBtn.dataset.id);
                    const investment = investments.find(inv => inv.id === investmentId);
                    if (investment) {
                        const updatedInvestment = await showEditInvestmentModal(investment);
                        if (updatedInvestment) {
                            const index = investments.findIndex(inv => inv.id === investmentId);
                            investments[index] = { ...investment, ...updatedInvestment };
                            localStorage.setItem('btcMiningInvestments', JSON.stringify(investments));
                            renderApp();
                        }
                    }
                }
            });

            // Función para mostrar el modal de edición
            function showEditInvestmentModal(investment) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.innerHTML = `
                    <div class="modal-content">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Editar Inversión</h3>
                        <form id="edit-investment-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-600">Nombre Inversión</label>
                                <input type="text" name="name" class="form-input" value="${investment.name}" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600">Fecha de Registro</label>
                                <input type="date" name="date" class="form-input" value="${investment.date}" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600">Costo (MXN)</label>
                                <input type="number" name="cost" class="form-input" value="${investment.cost}" required step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600">Ingreso Diario (MXN)</label>
                                <input type="number" name="dailyIncome" class="form-input" value="${investment.dailyIncome}" required step="0.01">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600">Nota (Opcional)</label>
                                <textarea name="note" class="form-input" rows="3">${investment.note || ''}</textarea>
                            </div>
                            <div class="modal-buttons">
                                <button type="button" class="modal-btn modal-btn-cancel">Cancelar</button>
                                <button type="submit" class="modal-btn modal-btn-save">Guardar Cambios</button>
                            </div>
                        </form>
                    </div>
                `;
                
                document.body.appendChild(modal);

                return new Promise((resolve) => {
                    const form = modal.querySelector('#edit-investment-form');
                    const cancelBtn = modal.querySelector('.modal-btn-cancel');

                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const formData = new FormData(form);
                        const newDailyIncome = parseFloat(formData.get('dailyIncome'));
                        const currentDate = new Date().toISOString().split('T')[0];
                        
                        // Solo agregamos al historial si la tasa ha cambiado
                        const updatedInvestment = {
                            name: formData.get('name'),
                            date: formData.get('date'),
                            cost: parseFloat(formData.get('cost')),
                            dailyIncome: newDailyIncome,
                            note: formData.get('note')
                        };
                        
                        // Si la tasa diaria ha cambiado, agregamos una nueva entrada al historial
                        if (newDailyIncome !== investment.dailyIncome) {
                            const incomeHistory = investment.incomeHistory || 
                                [{ date: investment.date, dailyIncome: investment.dailyIncome }];
                            
                            updatedInvestment.incomeHistory = [
                                ...incomeHistory,
                                { date: currentDate, dailyIncome: newDailyIncome }
                            ];
                        } else {
                            updatedInvestment.incomeHistory = investment.incomeHistory;
                        }

                        if (isNaN(updatedInvestment.cost) || isNaN(updatedInvestment.dailyIncome) || 
                            updatedInvestment.cost <= 0 || updatedInvestment.dailyIncome <= 0) {
                            alert('Por favor, ingresa valores válidos para costo e ingreso diario.');
                            return;
                        }

                        document.body.removeChild(modal);
                        resolve(updatedInvestment);
                    });

                    cancelBtn.addEventListener('click', () => {
                        document.body.removeChild(modal);
                        resolve(null);
                    });

                    // Cerrar modal al hacer clic fuera
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            document.body.removeChild(modal);
                            resolve(null);
                        }
                    });
                });
            }

            // Función para actualizar la información de almacenamiento
            const updateStorageInfo = () => {
                const totalStorage = document.getElementById('total-storage');
                const totalRecords = document.getElementById('total-records');
                const lastUpdate = document.getElementById('last-update');
                
                // Calcular el tamaño total usado
                const storageSize = new Blob([localStorage.getItem('goMiningInvestments') || '']).size;
                totalStorage.textContent = `${(storageSize / 1024).toFixed(2)} KB`;
                
                // Contar registros
                totalRecords.textContent = investments.length;
                
                // Mostrar última actualización
                const now = new Date();
                lastUpdate.textContent = now.toLocaleString('es-MX', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            };

            // Función para descargar datos
            const downloadData = () => {
                if (discordWebhookInput) {
                    const validation = validateDiscordWebhookUrl(discordWebhookInput.value);
                    if (!validation.ok) {
                        discordWebhookInput.classList.add('ring-2', 'ring-red-500');
                        showToast({ type: 'error', title: 'URL inválida', message: 'La URL no se incluirá en el backup.' });
                    } else {
                        discordWebhookInput.classList.remove('ring-2', 'ring-red-500');
                        if (validation.value !== discordWebhookUrl) {
                            discordWebhookUrl = validation.value;
                            if (discordWebhookUrl) localStorage.setItem('goMiningWebhook', discordWebhookUrl);
                            else localStorage.removeItem('goMiningWebhook');
                        }
                    }
                }

                const data = {
                    type: 'go-mining-investments',
                    version: '1.0',
                    data: investments,
                    discordWebhookUrl: discordWebhookUrl,
                    exportDate: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `go-mining-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            };

            // Función para importar datos
            const importData = async (file) => {
                try {
                    const text = await file.text();
                    const importedData = JSON.parse(text);
                    
                    // Verificar que el archivo sea del tipo correcto
                    if (importedData.type !== 'go-mining-investments' && importedData.type !== 'go-mining') {
                        throw new Error('El archivo no es compatible con esta aplicación');
                    }

                    // Confirmar la importación
                    const confirmed = await showConfirmationModal(
                        'Confirmar importación',
                        `¿Estás seguro de que deseas importar ${importedData.data.length} inversiones? Los datos actuales serán reemplazados.`
                    );

                    if (confirmed) {
                        investments = importedData.data;
                        localStorage.setItem('goMiningInvestments', JSON.stringify(investments));

                        const importedWebhookUrl = (importedData && typeof importedData === 'object')
                            ? (importedData.discordWebhookUrl || (importedData.config && importedData.config.discordWebhookUrl))
                            : '';
                        if (typeof importedWebhookUrl === 'string') {
                            const trimmed = importedWebhookUrl.trim();
                            if (trimmed) {
                                discordWebhookUrl = trimmed;
                                localStorage.setItem('goMiningWebhook', discordWebhookUrl);
                                if (discordWebhookInput) discordWebhookInput.value = discordWebhookUrl;
                            } else {
                                discordWebhookUrl = '';
                                localStorage.removeItem('goMiningWebhook');
                                if (discordWebhookInput) discordWebhookInput.value = '';
                            }
                        }

                        renderApp();
                        updateStorageInfo();
                        showToast({ type: 'success', title: 'Importación completa', message: 'Los datos se importaron correctamente.' });
                    }
                } catch (error) {
                    showToast({ type: 'error', title: 'Error al importar', message: error.message || 'No fue posible importar el archivo.' });
                }
            };

            // Función genérica para mostrar modal de confirmación
            const showConfirmationModal = (title, message) => {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.innerHTML = `
                    <div class="modal-content">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">${title}</h3>
                        <p class="text-gray-600">${message}</p>
                        <div class="modal-buttons">
                            <button class="modal-btn modal-btn-cancel">Cancelar</button>
                            <button class="modal-btn modal-btn-confirm">Confirmar</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);

                return new Promise((resolve) => {
                    const cancelBtn = modal.querySelector('.modal-btn-cancel');
                    const confirmBtn = modal.querySelector('.modal-btn-confirm');

                    cancelBtn.addEventListener('click', () => {
                        document.body.removeChild(modal);
                        resolve(false);
                    });

                    confirmBtn.addEventListener('click', () => {
                        document.body.removeChild(modal);
                        resolve(true);
                    });

                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            document.body.removeChild(modal);
                            resolve(false);
                        }
                    });
                });
            };

            if (saveWebhookBtn && discordWebhookInput) {
                saveWebhookBtn.addEventListener('click', () => {
                    setButtonBusy(saveWebhookBtn, 'Guardando...', true);
                    try {
                        const validation = validateDiscordWebhookUrl(discordWebhookInput.value);
                        if (!validation.ok) {
                            discordWebhookInput.classList.add('ring-2', 'ring-red-500');
                            showToast({ type: 'error', title: 'URL inválida', message: 'Usa un Webhook de Discord válido.' });
                            discordWebhookInput.focus();
                            return;
                        }

                        discordWebhookInput.classList.remove('ring-2', 'ring-red-500');
                        if (validation.value) {
                            localStorage.setItem('goMiningWebhook', validation.value);
                            discordWebhookUrl = validation.value;
                            showToast({ type: 'success', title: 'Webhook guardado', message: 'Se usará para futuros respaldos y exportaciones.' });
                        } else {
                            localStorage.removeItem('goMiningWebhook');
                            discordWebhookUrl = '';
                            showToast({ type: 'info', title: 'Webhook eliminado', message: 'No se enviarán respaldos a Discord hasta configurar uno.' });
                        }
                    } finally {
                        setButtonBusy(saveWebhookBtn, 'Guardando...', false);
                    }
                });
            }

            // Función para respaldar en Discord
            const backupToDiscord = async () => {
                setButtonBusy(backupToDiscordBtn, 'Enviando...', true);

                const validation = validateDiscordWebhookUrl(discordWebhookInput ? discordWebhookInput.value : discordWebhookUrl);
                if (!validation.ok) {
                    if (discordWebhookInput) {
                        discordWebhookInput.classList.add('ring-2', 'ring-red-500');
                        discordWebhookInput.focus();
                    }
                    showToast({ type: 'error', title: 'URL inválida', message: 'Usa un Webhook de Discord válido.' });
                    setButtonBusy(backupToDiscordBtn, 'Enviando...', false);
                    return;
                }
                if (!validation.value) {
                    showToast({ type: 'error', title: 'Falta la URL', message: 'Configura tu URL de Webhook antes de respaldar.' });
                    if (discordWebhookInput) discordWebhookInput.focus();
                    setButtonBusy(backupToDiscordBtn, 'Enviando...', false);
                    return;
                }
                if (discordWebhookInput) discordWebhookInput.classList.remove('ring-2', 'ring-red-500');
                if (validation.value !== discordWebhookUrl) {
                    localStorage.setItem('goMiningWebhook', validation.value);
                    discordWebhookUrl = validation.value;
                    if (discordWebhookInput) discordWebhookInput.value = discordWebhookUrl;
                }

                const webhookUrl = discordWebhookUrl;

                const confirmed = await showConfirmationModal('Discord', '¿Enviar respaldo al Webhook configurado?');
                if (!confirmed) {
                    setButtonBusy(backupToDiscordBtn, 'Enviando...', false);
                    return;
                }

                try {
                    const now = new Date();
                    now.setUTCHours(0, 0, 0, 0);
                    const totalCost = investments.reduce((sum, inv) => sum + (Number(inv.cost) || 0), 0);
                    const activeInvestments = investments.filter(inv => {
                        if (!inv.hasExpiration) return true;
                        return now <= new Date(inv.expirationDate);
                    });
                    const totalDaily = activeInvestments.reduce((sum, inv) => sum + (Number(inv.dailyIncome) || 0), 0);

                    const totalRecovered = investments.reduce((total, inv) => {
                        let investmentEarned = 0;
                        let currentDate = new Date(inv.date);
                        currentDate.setUTCHours(0, 0, 0, 0);

                        let limitDate = now;
                        if (inv.hasExpiration) {
                            const expirationDate = new Date(inv.expirationDate);
                            expirationDate.setUTCHours(0, 0, 0, 0);
                            if (expirationDate < limitDate) limitDate = expirationDate;
                        }

                        const incomeHistory = inv.incomeHistory
                            ? [...inv.incomeHistory].sort((a, b) => new Date(a.date) - new Date(b.date))
                            : [{ date: inv.date, dailyIncome: inv.dailyIncome }];

                        for (let i = 0; i < incomeHistory.length; i++) {
                            const currentRate = incomeHistory[i];
                            const nextRate = incomeHistory[i + 1];
                            let endDate = nextRate ? new Date(nextRate.date) : limitDate;
                            endDate.setUTCHours(0, 0, 0, 0);
                            if (endDate > limitDate) endDate = limitDate;

                            if (currentDate < limitDate) {
                                const periodDays = Math.max(0, Math.floor((endDate - currentDate) / (1000 * 60 * 60 * 24)));
                                investmentEarned += periodDays * (Number(currentRate.dailyIncome) || 0);
                            }
                            currentDate = new Date(endDate);
                        }

                        return total + investmentEarned;
                    }, 0);

                    // Crear el archivo JSON
                    const fileData = JSON.stringify({
                        type: 'go-mining-investments',
                        version: '1.0',
                        data: investments,
                        discordWebhookUrl: discordWebhookUrl,
                        exportDate: new Date().toISOString()
                    }, null, 2);

                    // Crear el FormData para enviar el archivo
                    const formData = new FormData();
                    
                    // Agregar el JSON del mensaje embed
                    const messageData = {
                        content: 'Respaldo automático GO Mining',
                        embeds: [{
                            title: 'Respaldo de Datos de Minería GO',
                            description: 'Resumen',
                            color: 2454510,
                            fields: [
                                { name: 'Total de inversiones', value: String(investments.length), inline: true },
                                { name: 'Costo total', value: currencyFormatter.format(totalCost), inline: true },
                                { name: 'Ingreso diario activo', value: currencyFormatter.format(totalDaily), inline: true },
                                { name: 'Total recuperado', value: currencyFormatter.format(totalRecovered), inline: true },
                                { name: 'Última actualización', value: new Date().toLocaleString('es-MX'), inline: false }
                            ],
                            footer: {
                                text: 'Respaldo automático de inversiones'
                            },
                            timestamp: new Date().toISOString()
                        }]
                    };
                    
                    // Agregar el mensaje como parte del FormData
                    formData.append('payload_json', JSON.stringify(messageData));
                    
                    // Crear el Blob y agregar el archivo
                    const blob = new Blob([fileData], { type: 'application/json' });
                    formData.append('file', blob, `go-mining-backup-${new Date().toISOString().split('T')[0]}.json`);

                    // Enviar la solicitud
                    const response = await fetch(webhookUrl, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error('Error al enviar datos a Discord');
                    }

                    showToast({ type: 'success', title: 'Respaldo enviado', message: 'Se envió el backup y el resumen al canal de Discord.' });
                } catch (error) {
                    showToast({ type: 'error', title: 'Error al enviar', message: error.message || 'No fue posible enviar el respaldo a Discord.' });
                } finally {
                    setButtonBusy(backupToDiscordBtn, 'Enviando...', false);
                }
            };

            // Event listeners para los botones de la pestaña de almacenamiento
            document.getElementById('download-data').addEventListener('click', downloadData);
            
            document.getElementById('import-data-btn').addEventListener('click', () => {
                document.getElementById('import-data').click();
            });

            document.getElementById('backup-to-discord').addEventListener('click', backupToDiscord);
            
            document.getElementById('import-data').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    importData(e.target.files[0]);
                }
            });

            // Manejar la limpieza del almacenamiento
            document.getElementById('clear-storage').addEventListener('click', async () => {
                const confirmed = await showConfirmationModal(
                    'Confirmar limpieza',
                    '¿Estás seguro de que deseas eliminar todos los datos de inversiones? Esta acción no se puede deshacer.'
                );
                
                if (confirmed) {
                    localStorage.removeItem('goMiningInvestments');
                    investments = [];
                    renderApp();
                    updateStorageInfo();
                }
            });

            // Actualizar la información de almacenamiento cuando se cambie a esa pestaña
            document.getElementById('tab-btn-storage').addEventListener('click', updateStorageInfo);

            // Renderizar la app al cargar y establecer un intervalo para actualizar el estado en tiempo real
            renderApp();
            setInterval(renderHistory, 60000); // Actualiza el historial cada minuto

            // Funciones para el modal de confirmación
            function showDeleteConfirmationModal(investmentId) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.innerHTML = `
                    <div class="modal-content">
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Confirmar eliminación</h3>
                        <p class="text-gray-600">¿Estás seguro de que deseas eliminar esta inversión? Esta acción no se puede deshacer.</p>
                        <div class="modal-buttons">
                            <button class="modal-btn modal-btn-cancel">Cancelar</button>
                            <button class="modal-btn modal-btn-confirm">Eliminar</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);

                return new Promise((resolve) => {
                    const cancelBtn = modal.querySelector('.modal-btn-cancel');
                    const confirmBtn = modal.querySelector('.modal-btn-confirm');

                    cancelBtn.addEventListener('click', () => {
                        document.body.removeChild(modal);
                        resolve(false);
                    });

                    confirmBtn.addEventListener('click', () => {
                        document.body.removeChild(modal);
                        resolve(true);
                    });

                    // Cerrar modal al hacer clic fuera
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            document.body.removeChild(modal);
                            resolve(false);
                        }
                    });
                });
            }
        });
    </script>
    <script src="/theme.js"></script>
</body>
</html>
