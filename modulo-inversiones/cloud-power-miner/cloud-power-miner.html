<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Inversiones Cloud Power Miner</title>
    <meta name="theme-color" content="#2563eb">
    <link rel="icon" href="/pwa/logo-app.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { slate: { 850: '#1e293b', 900: '#0f172a' } } } }
        }
    </script>
    <script>
        (function(){try{var t=localStorage.getItem('fti_theme_preference');var d=window.matchMedia('(prefers-color-scheme: dark)').matches;if(t==='dark'||((!t||t==='system')&&d)){document.documentElement.classList.add('dark');}else{document.documentElement.classList.remove('dark');}}catch(e){}})();
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --bg-body:#f9fafb; --text-body:#374151; --bg-card:#ffffff; --border-card:#e5e7eb; --accent-blue:#3b82f6; --accent-blue-hover:#2563eb; --progress-bg:#e5e7eb; --progress-fg:#10b981; --scrollbar-thumb:#cbd5e1; --scrollbar-thumb-hover:#94a3b8; }
        html.dark { --bg-body:#0f172a; --text-body:#e2e8f0; --bg-card:#1e293b; --border-card:#334155; --accent-blue:#3b82f6; --accent-blue-hover:#60a5fa; --progress-bg:#334155; --progress-fg:#10b981; --scrollbar-thumb:#334155; --scrollbar-thumb-hover:#64748b; }
        /* Estilo para la barra de desplazamiento */
        ::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb); border-radius: 4px; }
        
        ::-webkit-scrollbar-thumb:hover { background-color: var(--scrollbar-thumb-hover); }
        
        body { font-family:'Inter',sans-serif; background-color: var(--bg-body); color: var(--text-body); transition: background-color .3s ease, color .3s ease; }
        .card { background-color: var(--bg-card); border-radius: .75rem; padding: 1.5rem; border: 1px solid var(--border-card); box-shadow: 0 1px 3px rgba(0,0,0,.1); transition: background-color .3s ease, border-color .3s ease; }
        .form-input { width:100%; background-color: var(--bg-card); border:1px solid var(--border-card); color: var(--text-body); border-radius:.5rem; padding:.75rem 1rem; transition:border-color .2s, box-shadow .2s; }
        .form-input:focus { outline:none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(59,130,246,.2); }
        .btn { background-color: var(--accent-blue); color:#fff; font-weight:600; padding:.75rem 1.5rem; border-radius:.5rem; transition: background-color .2s; width:100%; }
        .btn:hover { background-color: var(--accent-blue-hover); }
        .progress-bar-bg { background-color: var(--progress-bg); }
        .progress-bar-fg { background-color: var(--progress-fg); }
        .tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .tag-recovering {
            background-color: #f59e0b; /* bg-amber-500 */
            color: #78350f;
        }
        .tag-recovered {
            background-color: #10b981; /* bg-green-500 */
            color: #064e3b;
        }
        .tag-expired {
            background-color: #6b7280; /* bg-gray-500 */
            color: white;
        }
        .tag-expiring {
            background-color: #f59e0b; /* bg-amber-500 */
            color: #78350f;
        }
        .tag-duration {
            background-color: #dbeafe; /* bg-blue-100 */
            color: #1e40af; /* text-blue-800 */
        }
        .tag-no-expiration {
            background-color: #f3f4f6; /* bg-gray-100 */
            color: #1f2937; /* text-gray-800 */
        }
        /* Estilos para las pestañas */
        .tab-btn {
            cursor: pointer;
            border-bottom: 3px solid transparent;
            padding: 0.75rem 0.25rem;
            font-size: 1rem;
            font-weight: 600;
            color: #6b7280; /* text-gray-500 */
            transition: color 0.2s, border-color 0.2s;
        }
        .tab-btn:hover {
            color: #374151; /* text-gray-700 */
        }
        .tab-btn.active {
            color: #3b82f6; /* text-blue-500 */
            border-color: #3b82f6; /* border-blue-500 */
        }
        /* Estilos para el modal de confirmación */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content { background-color: var(--bg-card); padding:2rem; border-radius:.75rem; max-width:400px; width:90%; box-shadow:0 4px 6px rgba(0,0,0,.1); }
        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .modal-btn {
            flex: 1;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .modal-btn-cancel {
            background-color: #e5e7eb;
            color: #374151;
        }
        .modal-btn-cancel:hover {
            background-color: #d1d5db;
        }
        .modal-btn-confirm {
            background-color: #ef4444;
            color: white;
        }
        .modal-btn-confirm:hover {
            background-color: #dc2626;
        }
        html.dark .border-gray-100{border-color:#334155!important}
        html.dark .border-gray-200{border-color:#334155!important}
        html.dark .bg-blue-50{background-color:rgba(59,130,246,.12)!important}
        html.dark .border-blue-400{border-color:#60a5fa!important}
        html.dark .text-blue-700{color:#60a5fa!important}
        html.dark .bg-white{background-color:var(--bg-card)!important}
        html.dark .bg-gray-50{background-color:rgba(255,255,255,.04)!important}
        html.dark .bg-gray-100{background-color:rgba(255,255,255,.06)!important}
        html.dark .text-gray-900{color:#f1f5f9!important}
        html.dark .text-gray-800{color:#e2e8f0!important}
        html.dark .text-gray-700{color:#cbd5e1!important}
        html.dark .text-gray-600{color:#94a3b8!important}
        html.dark .text-gray-500{color:#94a3b8!important}
        html.dark .text-gray-400{color:#94a3b8!important}

        html.dark .tab-btn{color:#94a3b8}
        html.dark .tab-btn:hover{color:#e2e8f0}
        html.dark .tab-btn.active{color:#60a5fa;border-color:#60a5fa}

        html.dark .modal-btn-cancel{background-color:#334155;color:#e2e8f0}
        html.dark .modal-btn-cancel:hover{background-color:#475569}

        html.dark #toggle-roi-table{background-color:var(--bg-card)!important;color:var(--text-body)!important;border-color:var(--border-card)!important}
        html.dark #toggle-roi-table:hover{background-color:rgba(255,255,255,.06)!important}

        #toast-container{position:fixed;top:1rem;right:1rem;z-index:100;display:flex;flex-direction:column;gap:.75rem;max-width:calc(100vw - 2rem)}
        .toast{width:352px;max-width:calc(100vw - 2rem);background-color:var(--bg-card);border:1px solid var(--border-card);border-radius:.75rem;box-shadow:0 10px 25px rgba(0,0,0,.12);overflow:hidden}
        .toast-row{display:flex;gap:.75rem;align-items:flex-start;padding:1rem}
        .toast-icon{height:36px;width:36px;border-radius:.5rem;display:flex;align-items:center;justify-content:center;flex:none}
        .toast-body{min-width:0;flex:1}
        .toast-title{font-weight:700;color:var(--text-body)}
        .toast-message{margin-top:.125rem;font-size:.875rem;color:var(--text-body);opacity:.9}
        .toast-close{border:none;background:transparent;color:#94a3b8;cursor:pointer;padding:0;line-height:0}
        .toast-close:hover{color:var(--text-body)}
        .toast-bar{height:4px;width:100%;background-color:rgba(148,163,184,.25)}
        .toast-bar > div{height:4px;width:100%;transform-origin:left;animation:toastBar 4s linear forwards}
        .toast--success .toast-icon{background-color:rgba(16,185,129,.12);color:#10b981}
        .toast--success .toast-bar > div{background-color:#10b981}
        .toast--error .toast-icon{background-color:rgba(239,68,68,.12);color:#ef4444}
        .toast--error .toast-bar > div{background-color:#ef4444}
        .toast--info .toast-icon{background-color:rgba(59,130,246,.12);color:#3b82f6}
        .toast--info .toast-bar > div{background-color:#3b82f6}
        .spinner{height:16px;width:16px;animation:spin .9s linear infinite}
        @keyframes toastBar{from{transform:scaleX(1)}to{transform:scaleX(0)}}
        @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Panel de Control - Cloud Power Miner</h1>
            <p class="text-gray-600 mt-2">Registra y monitorea el rendimiento de los activos.</p>
        </header>

        <!-- Navegación de Pestañas -->
        <div class="mb-8 border-b border-gray-200 overflow-hidden">
            <div class="overflow-x-auto" style="scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent;">
                <nav class="-mb-px flex space-x-6 min-w-max px-1 pb-2" aria-label="Tabs">
                    <a href="../index.html" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 text-gray-600 hover:bg-blue-500 hover:text-white transition-colors" title="Volver a Inversiones">
                        <i class="fas fa-arrow-left text-lg"></i>
                    </a>
                    <button id="tab-btn-register" class="tab-btn active whitespace-nowrap">Registrar</button>
                    <button id="tab-btn-history" class="tab-btn whitespace-nowrap">Historial</button>
                    <button id="tab-btn-summary" class="tab-btn whitespace-nowrap">Resumen</button>
                    <button id="tab-btn-storage" class="tab-btn whitespace-nowrap">Almacenamiento</button>
                </nav>
            </div>
        </div>

        <!-- Pestaña de Registro -->
        <div id="tab-content-register" class="tab-content-item">
            <div class="card max-w-lg mx-auto">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Registrar Nueva Inversión</h2>
                <form id="investment-form" class="space-y-4">
                    <div>
                        <label for="investment-name" class="block text-sm font-medium text-gray-600 mb-1">Nombre Inversión</label>
                        <input type="text" id="investment-name" class="form-input" placeholder="Ej: Contrato CPM 1" required>
                    </div>
                    <div>
                        <label for="registration-date" class="block text-sm font-medium text-gray-600 mb-1">Fecha de Registro</label>
                        <input type="date" id="registration-date" class="form-input" required>
                    </div>
                    <div>
                        <label for="cost" class="block text-sm font-medium text-gray-600 mb-1">Costo (MXN)</label>
                        <input type="number" id="cost" class="form-input" placeholder="Ej: 5000.00" required step="0.01">
                    </div>
                    <div>
                        <label for="daily-income" class="block text-sm font-medium text-gray-600 mb-1">Ingreso Diario (MXN)</label>
                        <input type="number" id="daily-income" class="form-input" placeholder="Ej: 50.00" required step="0.01">
                    </div>
                    <div>
                        <label class="flex items-center space-x-2 text-sm font-medium text-gray-600 mb-1">
                            <input type="checkbox" id="has-expiration" class="form-checkbox h-4 w-4 text-blue-600">
                            <span>¿Vencimiento?</span>
                        </label>
                    </div>
                    <div id="expiration-duration" class="hidden">
                        <label for="duration" class="block text-sm font-medium text-gray-600 mb-1">Duración</label>
                        <select id="duration" class="form-input" disabled>
                            <option value="1m">1 mes</option>
                            <option value="3m">3 meses</option>
                            <option value="6m">6 meses</option>
                            <option value="1y">1 año</option>
                            <option value="2y">2 años</option>
                            <option value="3y">3 años</option>
                        </select>
                    </div>
                    <div>
                        <label for="note" class="block text-sm font-medium text-gray-600 mb-1">Nota (Opcional)</label>
                        <textarea id="note" class="form-input" placeholder="Anotaciones sobre esta inversión..." rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn">Agregar Inversión</button>
                </form>
            </div>
        </div>

        <!-- Pestaña de Historial -->
        <div id="tab-content-history" class="tab-content-item hidden">
                <div class="card h-full">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Historial de Inversiones</h2>
                <div id="investment-history" class="space-y-6">
                    <!-- Las inversiones se insertarán aquí dinámicamente -->
                    <p class="text-gray-500 text-center py-8">No hay inversiones registradas aún.</p>
                </div>
            </div>
        </div>

        <!-- Pestaña de Resumen -->
        <div id="tab-content-summary" class="tab-content-item hidden">
            <div class="card max-w-lg mx-auto">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Resumen General</h2>
                <div id="summary-details" class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Tiempo desde la primera inversión:</span>
                        <span id="time-since-first-investment" class="text-xl font-bold text-purple-600"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Costo Total Invertido:</span>
                        <span id="total-cost" class="text-xl font-bold text-gray-800"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Total Recuperado:</span>
                        <span id="total-recovered" class="text-xl font-bold text-green-600"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">ROI anualizado:</span>
                        <span id="annualized-roi" class="text-xl font-bold text-indigo-600"></span>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-gray-600">Evaluación del ROI:</span>
                        <div class="flex items-center gap-3">
                            <span id="roi-evaluation" class="text-xl font-bold text-gray-800">N/A</span>
                            <button id="toggle-roi-table" class="text-sm px-3 py-1 rounded-md border border-gray-200 bg-white hover:bg-gray-50">Mostrar referencia</button>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 mt-2" id="roi-eval-note">Comparando el ROI anualizado con una tabla de referencia para indicar si el rendimiento es malo, aceptable, bueno o excelente.</div>
                    <!-- Modal overlay para la tabla de referencia -->
                    <div id="roi-reference-table" class="modal-overlay" aria-hidden="true">
                        <div class="modal-content max-w-2xl w-11/12">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-800 flex-1">Tabla de evaluación del ROI</h3>
                                <button id="close-roi-table" class="modal-btn modal-btn-cancel px-3 py-1 text-sm" style="flex:none; width:auto;">Cerrar</button>
                            </div>
                            <div class="mt-4 overflow-auto" style="max-height:60vh">
                                <table class="w-full text-sm text-gray-600">
                                    <thead>
                                        <tr>
                                            <th class="text-left pb-2">Veredicto</th>
                                            <th class="text-left pb-2">Rango</th>
                                            <th class="text-left pb-2">Comentario</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="border-t"><td class="py-2">Malo</td><td class="py-2">&lt; 5%</td><td class="py-2">Por debajo de la inflación o bonos de bajo riesgo</td></tr>
                                        <tr class="border-t"><td class="py-2">Aceptable</td><td class="py-2">5–10%</td><td class="py-2">Similar a índices diversificados (ej. S&amp;P 500)</td></tr>
                                        <tr class="border-t"><td class="py-2">Bueno</td><td class="py-2">10–20%</td><td class="py-2">Sobre el promedio histórico; buen rendimiento</td></tr>
                                        <tr class="border-t"><td class="py-2">Excelente</td><td class="py-2">&gt; 20%</td><td class="py-2">Alto retorno (arriesgado)</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Ingresos Diarios Totales:</span>
                        <span id="total-daily-income" class="text-xl font-bold text-green-600"></span>
                    </div>
                    <hr class="border-gray-200">
                    <div class="bg-gray-50 p-4 rounded-lg space-y-3">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Análisis de Ingresos</h3>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Últimos 7 días:</span>
                            <span id="last-7-days-income" class="text-lg font-semibold text-green-600"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Últimas 2 semanas:</span>
                            <span id="last-2-weeks-income" class="text-lg font-semibold text-green-600"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Último mes:</span>
                            <span id="last-month-income" class="text-lg font-semibold text-green-600"></span>
                        </div>
                    </div>
                    <hr class="border-gray-200">
                    <div class="text-center">
                        <span class="text-gray-600 text-sm">Como referencia, si quisieras recuperar el costo total de todas tus inversiones, en base al ingreso diario, tardarías aproximadamente:</span>
                        <p id="total-roi" class="text-2xl font-bold text-blue-600"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pestaña de Almacenamiento -->
        <div id="tab-content-storage" class="tab-content-item hidden">
            <div class="card max-w-lg mx-auto">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Uso de Almacenamiento</h2>
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4 rounded">
                    <p class="text-sm text-blue-700">
                        <i class="fas fa-info-circle mr-2"></i>
                        Los datos se almacenan localmente en LocalStorage.
                    </p>
                </div>
                <div id="storage-details" class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Espacio Total Usado:</span>
                        <span id="total-storage" class="text-xl font-bold text-blue-600"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Número de Registros:</span>
                        <span id="total-records" class="text-xl font-bold text-gray-800"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Última Actualización:</span>
                        <span id="last-update" class="text-xl font-bold text-gray-800"></span>
                    </div>
                    <hr class="border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <button id="download-data" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                            Descargar Datos
                        </button>
                        <div class="relative">
                            <input type="file" id="import-data" accept=".json" class="hidden">
                            <button id="import-data-btn" class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" transform="rotate(180 10 10)" />
                                </svg>
                                Importar Datos
                            </button>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button id="backup-to-discord" class="w-full bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition-colors flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20.317 4.492c-1.53-.69-3.17-1.2-4.885-1.49a.075.075 0 0 0-.079.036c-.21.369-.444.85-.608 1.23a18.566 18.566 0 0 0-5.487 0 12.36 12.36 0 0 0-.617-1.23A.077.077 0 0 0 8.562 3c-1.714.29-3.354.8-4.885 1.491a.07.07 0 0 0-.032.027C.533 9.093-.32 13.555.099 17.961a.08.08 0 0 0 .031.055 20.03 20.03 0 0 0 5.993 2.98.078.078 0 0 0 .084-.026 13.83 13.83 0 0 0 1.226-1.963.074.074 0 0 0-.041-.104 13.175 13.175 0 0 1-1.872-.878.075.075 0 0 1-.008-.125c.126-.093.252-.19.372-.287a.075.075 0 0 1 .078-.01c3.927 1.764 8.18 1.764 12.061 0a.075.075 0 0 1 .079.009c.12.098.245.195.372.288a.075.075 0 0 1-.006.125c-.598.344-1.22.635-1.873.877a.075.075 0 0 0-.041.105c.36.687.772 1.341 1.225 1.962a.077.077 0 0 0 .084.028 19.963 19.963 0 0 0 6.002-2.981.076.076 0 0 0 .032-.054c.5-5.094-.838-9.52-3.549-13.442a.06.06 0 0 0-.031-.028zM8.02 15.278c-1.182 0-2.157-1.069-2.157-2.38 0-1.312.956-2.38 2.157-2.38 1.21 0 2.176 1.077 2.157 2.38 0 1.312-.956 2.38-2.157 2.38zm7.975 0c-1.183 0-2.157-1.069-2.157-2.38 0-1.312.955-2.38 2.157-2.38 1.21 0 2.176 1.077 2.157 2.38 0 1.312-.946 2.38-2.157 2.38z"></path>
                            </svg>
                            Respaldar en Discord
                        </button>
                        <div id="webhook-config" class="mt-4">
                            <label for="discord-webhook" class="block text-sm font-medium text-gray-600 mb-1">URL del Webhook de Discord</label>
                            <input type="url" id="discord-webhook" placeholder="https://discord.com/api/webhooks/..." class="form-input mb-2" autocomplete="off" inputmode="url">
                            <div class="flex justify-end">
                                <button id="save-webhook" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition-colors text-sm">
                                    Guardar URL
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button id="clear-storage" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            Limpiar Almacenamiento
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Referencias DOM ---
            const investmentForm = document.getElementById('investment-form');
            const investmentHistory = document.getElementById('investment-history');
            const hasExpirationCheckbox = document.getElementById('has-expiration');
            const durationContainer = document.getElementById('expiration-duration');
            const durationSelect = document.getElementById('duration');
            
            // Elementos de resumen
            const totalCostEl = document.getElementById('total-cost');
            const totalDailyIncomeEl = document.getElementById('total-daily-income');
            const totalRoiEl = document.getElementById('total-roi');
            const timeSinceFirstInvestmentEl = document.getElementById('time-since-first-investment');
            const totalRecoveredEl = document.getElementById('total-recovered');
            const annualizedRoiEl = document.getElementById('annualized-roi');
            const roiEvalEl = document.getElementById('roi-evaluation');
            const roiNoteEl = document.getElementById('roi-eval-note');
            
            // Elementos de análisis de ingresos
            const last7DaysIncomeEl = document.getElementById('last-7-days-income');
            const last2WeeksIncomeEl = document.getElementById('last-2-weeks-income');
            const lastMonthIncomeEl = document.getElementById('last-month-income');

            // Elementos de almacenamiento
            const totalStorageEl = document.getElementById('total-storage');
            const totalRecordsEl = document.getElementById('total-records');
            const lastUpdateEl = document.getElementById('last-update');
            const clearStorageBtn = document.getElementById('clear-storage');
            const downloadDataBtn = document.getElementById('download-data');
            const importDataInput = document.getElementById('import-data');
            const importDataBtn = document.getElementById('import-data-btn');
            const backupToDiscordBtn = document.getElementById('backup-to-discord');
            const webhookConfigDiv = document.getElementById('webhook-config');
            const discordWebhookInput = document.getElementById('discord-webhook');
            const saveWebhookBtn = document.getElementById('save-webhook');

            // --- Estado ---
            let investments = JSON.parse(localStorage.getItem('cloudPowerMinerInvestments')) || [];
            let discordWebhookUrl = localStorage.getItem('cloudPowerMinerWebhook') || '';

            if (discordWebhookUrl) {
                discordWebhookInput.value = discordWebhookUrl;
            }

            // Formateador de moneda
            const currencyFormatter = new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            });

            const setButtonBusy = (btn, busyText, isBusy) => {
                if (!btn) return;
                if (isBusy) {
                    if (!btn.dataset.originalHtml) btn.dataset.originalHtml = btn.innerHTML;
                    btn.disabled = true;
                    btn.classList.add('opacity-70', 'cursor-not-allowed');
                    btn.innerHTML = `
                        <span class="inline-flex items-center justify-center gap-2">
                            <svg class="spinner" viewBox="0 0 24 24" fill="none">
                                <circle style="opacity:.25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path style="opacity:.75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                            </svg>
                            <span>${busyText}</span>
                        </span>
                    `;
                } else {
                    btn.disabled = false;
                    btn.classList.remove('opacity-70', 'cursor-not-allowed');
                    if (btn.dataset.originalHtml) btn.innerHTML = btn.dataset.originalHtml;
                }
            };

            const showToast = ({ type, title, message }) => {
                const container = document.getElementById('toast-container');
                if (!container) return;

                const toast = document.createElement('div');
                toast.className = `toast toast--${type || 'info'}`;

                const iconSvg = type === 'success'
                    ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>'
                    : type === 'error'
                        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>'
                        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 2a10 10 0 100 20 10 10 0 000-20z"/></svg>';

                toast.innerHTML = `
                    <div class="toast-row">
                        <div class="toast-icon">${iconSvg}</div>
                        <div class="toast-body">
                            <div class="toast-title">${title || ''}</div>
                            <div class="toast-message">${message || ''}</div>
                        </div>
                        <button type="button" class="toast-close" aria-label="Cerrar">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                    <div class="toast-bar"><div></div></div>
                `;

                container.appendChild(toast);
                const closeBtn = toast.querySelector('button');
                const close = () => {
                    toast.style.transition = 'opacity .2s ease, transform .2s ease';
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateY(-6px)';
                    window.setTimeout(() => toast.remove(), 220);
                };
                if (closeBtn) closeBtn.addEventListener('click', close);
                window.setTimeout(close, 4200);
            };

            // --- Funciones Auxiliares ---

            const formatTimeSpan = (days) => {
                if (days >= 365) {
                    const years = Math.floor(days / 365);
                    const remainingMonths = Math.floor((days % 365) / 30);
                    let result = `${years} ${years === 1 ? 'año' : 'años'}`;
                    if (remainingMonths > 0) {
                        result += ` y ${remainingMonths} ${remainingMonths === 1 ? 'mes' : 'meses'}`;
                    }
                    return result;
                } else if (days >= 30) {
                    const months = Math.floor(days / 30);
                    return `${months} ${months === 1 ? 'mes' : 'meses'}`;
                } else {
                    return `${days} ${days === 1 ? 'día' : 'días'}`;
                }
            };

            const calculatePeriodIncome = (days) => {
                const now = new Date();
                const startDate = new Date(now);
                startDate.setDate(startDate.getDate() - days);

                return investments.reduce((total, inv) => {
                    const investmentStartDate = new Date(inv.date);
                    investmentStartDate.setUTCHours(0, 0, 0, 0);
                    
                    if (inv.hasExpiration) {
                        const expirationDate = new Date(inv.expirationDate);
                        expirationDate.setUTCHours(0, 0, 0, 0);
                        
                        if (now > expirationDate) {
                            if (expirationDate < startDate) return total;
                            const daysToExpiration = Math.floor((expirationDate - startDate) / (1000 * 60 * 60 * 24));
                            return total + (Math.min(days, Math.max(0, daysToExpiration)) * inv.dailyIncome);
                        }
                    }
                    
                    const daysActive = Math.floor((now - investmentStartDate) / (1000 * 60 * 60 * 24));
                    return total + (Math.min(days, Math.max(0, daysActive)) * inv.dailyIncome);
                }, 0);
            };

            // --- Funciones de Renderizado ---

            const renderHistory = () => {
                investmentHistory.innerHTML = '';
                if (investments.length === 0) {
                    investmentHistory.innerHTML = '<p class="text-gray-500 text-center py-8">No hay inversiones registradas aún.</p>';
                    return;
                }

                const sortedInvestments = [...investments].sort((a, b) => new Date(b.date) - new Date(a.date));
                const now = new Date();
                now.setUTCHours(0, 0, 0, 0);

                sortedInvestments.forEach(inv => {
                    // Cálculos por inversión
                    const incomeHistory = inv.incomeHistory || [{ date: inv.date, dailyIncome: inv.dailyIncome }];
                    let totalEarned = 0;
                    let currentDate = new Date(inv.date);
                    currentDate.setUTCHours(0, 0, 0, 0);
                    
                    let limitDate = now;
                    if (inv.hasExpiration) {
                        const expirationDate = new Date(inv.expirationDate);
                        expirationDate.setUTCHours(0, 0, 0, 0);
                        if (expirationDate < limitDate) limitDate = expirationDate;
                    }

                    // Cálculo simple
                    let daysActive = 0;
                    if (currentDate < limitDate) {
                        daysActive = Math.floor((limitDate - currentDate) / (1000 * 60 * 60 * 24));
                    }
                    totalEarned = Math.max(0, daysActive * inv.dailyIncome);

                    const recoveryPercentage = Math.min((totalEarned / inv.cost) * 100, 100);
                    const isRecovered = totalEarned >= inv.cost;
                    const timeToRecover = Math.ceil(inv.cost / inv.dailyIncome);
                    const daysPassed = Math.floor((now - new Date(inv.date)) / (1000 * 60 * 60 * 24));

                    // Tags
                    let statusTag = '';
                    let durationTag = '';

                    if (inv.hasExpiration) {
                        const expirationDate = new Date(inv.expirationDate);
                        const isExpired = now > expirationDate;
                        const daysToExpiration = Math.ceil((expirationDate - now) / (1000 * 60 * 60 * 24));
                        
                        const startDate = new Date(inv.date);
                        const totalDuration = Math.ceil((expirationDate - startDate) / (1000 * 60 * 60 * 24));
                        
                        durationTag = `<span class="tag tag-duration">Duración: ${formatTimeSpan(totalDuration)}</span>`;

                        if (isExpired) {
                            statusTag = `<span class="tag tag-expired">Vencida</span>`;
                        } else {
                            statusTag = `<span class="tag tag-expiring">Vence en ${daysToExpiration} días</span>`;
                        }
                        
                        if (isRecovered) statusTag += ` <span class="tag tag-recovered">Recuperada</span>`;
                    } else {
                        durationTag = `<span class="tag tag-no-expiration">Sin vencimiento</span>`;
                        statusTag = isRecovered 
                            ? `<span class="tag tag-recovered">Recuperado</span>` 
                            : `<span class="tag tag-recovering">En recuperación</span>`;
                    }

                    const el = document.createElement('div');
                    el.className = 'card';
                    el.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="flex items-center gap-3 flex-wrap">
                                    <h3 class="text-xl font-semibold text-gray-800">${inv.name}</h3>
                                    ${statusTag}
                                </div>
                                <div class="flex items-center gap-2 mt-1">
                                    ${durationTag}
                                </div>
                                <p class="text-sm text-gray-600 mt-1">Registrado: ${new Date(inv.date).toLocaleDateString('es-MX', { timeZone: 'UTC' })}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-bold text-blue-600">${currencyFormatter.format(inv.cost)}</p>
                                <p class="text-sm text-green-600">+${currencyFormatter.format(inv.dailyIncome)} / día</p>
                                <div class="flex justify-end gap-2 mt-2">
                                    <button class="edit-investment text-blue-600 hover:text-blue-800 p-1.5 rounded-lg border border-blue-200 hover:bg-blue-50 transition-colors" data-id="${inv.id}" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-investment text-red-600 hover:text-red-800 p-1.5 rounded-lg border border-red-200 hover:bg-red-50 transition-colors" data-id="${inv.id}" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        ${inv.note ? `<p class="text-gray-700 pt-2 border-t border-gray-200 mt-2"><em>Nota: ${inv.note}</em></p>` : ''}
                        <div class="space-y-2 pt-2 mt-2">
                             <div class="w-full progress-bar-bg rounded-full h-2.5">
                                <div class="progress-bar-fg h-2.5 rounded-full" style="width: ${recoveryPercentage}%"></div>
                            </div>
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Progreso de recuperación</span>
                                <span>${recoveryPercentage.toFixed(2)}%</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center pt-2 text-sm mt-2 border-t border-gray-100">
                            <div>
                                <p class="font-semibold text-gray-800">${daysPassed} días</p>
                                <p class="text-gray-600">Tiempo transcurrido</p>
                            </div>
                             <div>
                                <p class="font-semibold text-gray-800">${currencyFormatter.format(totalEarned)}</p>
                                <p class="text-gray-600">Monto recuperado</p>
                            </div>
                             <div>
                                <p class="font-semibold text-gray-800">${timeToRecover} días</p>
                                <p class="text-gray-600">ROI estimado (días)</p>
                            </div>
                        </div>
                    `;
                    investmentHistory.appendChild(el);
                });
            };

            const renderSummary = () => {
                const totalCost = investments.reduce((sum, inv) => sum + inv.cost, 0);
                
                // Calcular daily income total (solo activas)
                const now = new Date();
                now.setUTCHours(0, 0, 0, 0);
                
                const activeInvestments = investments.filter(inv => {
                    if (!inv.hasExpiration) return true;
                    return now <= new Date(inv.expirationDate);
                });
                
                const totalDaily = activeInvestments.reduce((sum, inv) => sum + inv.dailyIncome, 0);
                
                // Calcular total recuperado global
                let totalRecovered = 0;
                investments.forEach(inv => {
                    let limitDate = now;
                    if (inv.hasExpiration) {
                        const expirationDate = new Date(inv.expirationDate);
                        expirationDate.setUTCHours(0, 0, 0, 0);
                        if (expirationDate < limitDate) limitDate = expirationDate;
                    }
                    const startDate = new Date(inv.date);
                    startDate.setUTCHours(0, 0, 0, 0);
                    
                    if (startDate < limitDate) {
                        const days = Math.floor((limitDate - startDate) / (1000 * 60 * 60 * 24));
                        totalRecovered += Math.max(0, days * inv.dailyIncome);
                    }
                });

                // UI Updates
                totalCostEl.textContent = currencyFormatter.format(totalCost);
                totalDailyIncomeEl.textContent = currencyFormatter.format(totalDaily);
                totalRecoveredEl.textContent = currencyFormatter.format(totalRecovered);
                
                if (totalDaily > 0) {
                    const daysToRoi = Math.ceil((Math.max(0, totalCost - totalRecovered)) / totalDaily);
                    totalRoiEl.textContent = `${daysToRoi} días restantes`;
                } else {
                    totalRoiEl.textContent = 'N/A (Sin ingresos activos)';
                }

                // Time since first
                if (investments.length > 0) {
                    const firstDate = investments.reduce((min, inv) => {
                        const d = new Date(inv.date);
                        return d < min ? d : min;
                    }, new Date());
                    const daysSince = Math.floor((now - firstDate) / (1000 * 60 * 60 * 24));
                    timeSinceFirstInvestmentEl.textContent = formatTimeSpan(daysSince);
                    
                    // CAGR Calculation
                    const years = daysSince / 365;
                    if (years > 0 && totalCost > 0) {
                         // Simple ROI annualizado
                         let annualRoi = 0;
                         if (years < 1) {
                             const roiRatio = totalRecovered / totalCost;
                             annualRoi = (roiRatio / years) * 100;
                         } else {
                             annualRoi = ((totalRecovered - totalCost) / totalCost) / years * 100;
                         }
                         
                         annualizedRoiEl.textContent = `${annualRoi.toFixed(2)}%`;
                         
                         // Eval
                         let verdict = 'N/A';
                         let color = 'text-gray-800';
                         if (annualRoi < 5) { verdict = 'Malo'; color = 'text-red-600'; }
                         else if (annualRoi < 10) { verdict = 'Aceptable'; color = 'text-yellow-600'; }
                         else if (annualRoi < 20) { verdict = 'Bueno'; color = 'text-green-600'; }
                         else { verdict = 'Excelente'; color = 'text-indigo-600'; }
                         
                         roiEvalEl.textContent = verdict;
                         roiEvalEl.className = `text-xl font-bold ${color}`;
                    }
                } else {
                    timeSinceFirstInvestmentEl.textContent = '0 días';
                    annualizedRoiEl.textContent = '0%';
                }

                // Period Incomes
                last7DaysIncomeEl.textContent = currencyFormatter.format(calculatePeriodIncome(7));
                last2WeeksIncomeEl.textContent = currencyFormatter.format(calculatePeriodIncome(14));
                lastMonthIncomeEl.textContent = currencyFormatter.format(calculatePeriodIncome(30));
            };
            
            const updateStorageInfo = () => {
                const data = JSON.stringify(investments);
                const size = new Blob([data]).size;
                totalStorageEl.textContent = `${(size / 1024).toFixed(2)} KB`;
                totalRecordsEl.textContent = investments.length;
                lastUpdateEl.textContent = new Date().toLocaleString('es-MX');
            };

            const renderApp = () => {
                renderHistory();
                renderSummary();
                updateStorageInfo();
            };

            // --- Modales ---
            
            const showConfirmationModal = (title, message) => {
                return new Promise((resolve) => {
                    const modal = document.createElement('div');
                    modal.className = 'modal-overlay active';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">${title}</h3>
                            <p class="text-gray-600 mb-6">${message}</p>
                            <div class="modal-buttons">
                                <button class="modal-btn modal-btn-cancel">Cancelar</button>
                                <button class="modal-btn modal-btn-confirm">Confirmar</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    const close = (val) => {
                        document.body.removeChild(modal);
                        resolve(val);
                    };
                    
                    modal.querySelector('.modal-btn-cancel').onclick = () => close(false);
                    modal.querySelector('.modal-btn-confirm').onclick = () => close(true);
                    modal.onclick = (e) => { if (e.target === modal) close(false); };
                });
            };

            const showEditModal = (inv) => {
                return new Promise((resolve) => {
                    const modal = document.createElement('div');
                    modal.className = 'modal-overlay active';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4">Editar Inversión</h3>
                            <form id="edit-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-600">Nombre</label>
                                    <input type="text" name="name" class="form-input" value="${inv.name}" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600">Fecha de Registro</label>
                                    <input type="date" name="date" class="form-input" value="${inv.date}" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600">Costo</label>
                                    <input type="number" name="cost" class="form-input" value="${inv.cost}" required step="0.01">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600">Ingreso Diario</label>
                                    <input type="number" name="dailyIncome" class="form-input" value="${inv.dailyIncome}" required step="0.01">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-600">Nota</label>
                                    <textarea name="note" class="form-input" rows="3">${inv.note || ''}</textarea>
                                </div>
                                <div class="modal-buttons">
                                    <button type="button" class="modal-btn modal-btn-cancel">Cancelar</button>
                                    <button type="submit" class="modal-btn modal-btn-confirm" style="background-color: var(--accent-blue);">Guardar</button>
                                </div>
                            </form>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    const form = modal.querySelector('#edit-form');
                    const close = (val) => {
                        document.body.removeChild(modal);
                        resolve(val);
                    };
                    
                    modal.querySelector('.modal-btn-cancel').onclick = () => close(null);
                    form.onsubmit = (e) => {
                        e.preventDefault();
                        const formData = new FormData(form);
                        close({
                            name: formData.get('name'),
                            date: formData.get('date'),
                            cost: parseFloat(formData.get('cost')),
                            dailyIncome: parseFloat(formData.get('dailyIncome')),
                            note: formData.get('note')
                        });
                    };
                    modal.onclick = (e) => { if (e.target === modal) close(null); };
                });
            };

            // --- Event Handlers ---

            hasExpirationCheckbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    durationContainer.classList.remove('hidden');
                    durationSelect.removeAttribute('disabled');
                } else {
                    durationContainer.classList.add('hidden');
                    durationSelect.setAttribute('disabled', 'true');
                }
            });

            investmentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('investment-name').value;
                const dateStr = document.getElementById('registration-date').value;
                const cost = parseFloat(document.getElementById('cost').value);
                const dailyIncome = parseFloat(document.getElementById('daily-income').value);
                const note = document.getElementById('note').value;
                
                if (!name || !dateStr || isNaN(cost) || isNaN(dailyIncome)) return;

                const newInv = {
                    id: Date.now(),
                    name,
                    date: dateStr,
                    cost,
                    dailyIncome,
                    note,
                    hasExpiration: hasExpirationCheckbox.checked
                };

                if (newInv.hasExpiration) {
                    const duration = durationSelect.value;
                    const startDate = new Date(dateStr);
                    const endDate = new Date(startDate);
                    
                    switch(duration) {
                        case '1m': endDate.setMonth(startDate.getMonth() + 1); break;
                        case '3m': endDate.setMonth(startDate.getMonth() + 3); break;
                        case '6m': endDate.setMonth(startDate.getMonth() + 6); break;
                        case '1y': endDate.setFullYear(startDate.getFullYear() + 1); break;
                        case '2y': endDate.setFullYear(startDate.getFullYear() + 2); break;
                        case '3y': endDate.setFullYear(startDate.getFullYear() + 3); break;
                    }
                    newInv.expirationDate = endDate.toISOString();
                }

                investments.push(newInv);
                localStorage.setItem('cloudPowerMinerInvestments', JSON.stringify(investments));
                
                investmentForm.reset();
                durationContainer.classList.add('hidden');
                showToast({ type: 'success', title: 'Inversión registrada', message: 'Se agregó correctamente al historial.' });
                renderApp();
            });

            investmentHistory.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-investment');
                const editBtn = e.target.closest('.edit-investment');

                if (deleteBtn) {
                    const id = parseInt(deleteBtn.dataset.id);
                    if (await showConfirmationModal('Eliminar Inversión', '¿Estás seguro?')) {
                        investments = investments.filter(i => i.id !== id);
                        localStorage.setItem('cloudPowerMinerInvestments', JSON.stringify(investments));
                        renderApp();
                    }
                } else if (editBtn) {
                    const id = parseInt(editBtn.dataset.id);
                    const inv = investments.find(i => i.id === id);
                    if (inv) {
                        const updates = await showEditModal(inv);
                        if (updates) {
                            Object.assign(inv, updates);
                            localStorage.setItem('cloudPowerMinerInvestments', JSON.stringify(investments));
                            renderApp();
                        }
                    }
                }
            });

            // Tabs System
            const tabs = ['register', 'history', 'summary', 'storage'];
            tabs.forEach(tab => {
                const btn = document.getElementById(`tab-btn-${tab}`);
                if (btn) {
                    btn.addEventListener('click', () => {
                        tabs.forEach(t => {
                            document.getElementById(`tab-btn-${t}`).classList.remove('active');
                            const content = document.getElementById(`tab-content-${t}`);
                            if (content) content.classList.add('hidden');
                        });
                        btn.classList.add('active');
                        const activeContent = document.getElementById(`tab-content-${tab}`);
                        if (activeContent) activeContent.classList.remove('hidden');
                    });
                }
            });

            // Storage & Data
            clearStorageBtn.addEventListener('click', async () => {
                if (await showConfirmationModal('Limpiar Todo', '¿Borrar todos los datos permanentemente?')) {
                    localStorage.removeItem('cloudPowerMinerInvestments');
                    investments = [];
                    renderApp();
                    showToast({ type: 'success', title: 'Almacenamiento limpiado', message: 'Se eliminaron todos los registros.' });
                }
            });

            downloadDataBtn.addEventListener('click', () => {
                const urlFromInput = (discordWebhookInput.value || '').trim();
                const isDiscordWebhook = /^https:\/\/(?:canary\.|ptb\.)?discord(?:app)?\.com\/api\/webhooks\//i.test(urlFromInput);
                if (urlFromInput && !isDiscordWebhook) {
                    discordWebhookInput.classList.add('ring-2', 'ring-red-500');
                    showToast({ type: 'error', title: 'URL inválida', message: 'La URL no se incluirá en el backup.' });
                    discordWebhookInput.focus();
                } else {
                    discordWebhookInput.classList.remove('ring-2', 'ring-red-500');
                    if (urlFromInput && urlFromInput !== discordWebhookUrl) {
                        localStorage.setItem('cloudPowerMinerWebhook', urlFromInput);
                        discordWebhookUrl = urlFromInput;
                    }
                }

                const dataStr = JSON.stringify({ type: 'cloud-power-miner-investments', version: '1.0', data: investments, discordWebhookUrl: discordWebhookUrl, exportDate: new Date().toISOString() }, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cloud-power-miner-backup-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            });

            importDataBtn.addEventListener('click', () => importDataInput.click());
            
            importDataInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const text = await file.text();
                    const json = JSON.parse(text);
                    if (json.type === 'cloud-power-miner-investments' || json.type === 'cloud-power-miner') {
                        const data = json.data;
                        if (await showConfirmationModal('Importar', 'Esto reemplazará tus datos actuales. ¿Continuar?')) {
                            investments = data;
                            localStorage.setItem('cloudPowerMinerInvestments', JSON.stringify(investments));

                            const importedWebhookUrl = (json && typeof json === 'object') ? (json.discordWebhookUrl || (json.config && json.config.discordWebhookUrl)) : '';
                            if (typeof importedWebhookUrl === 'string') {
                                const trimmed = importedWebhookUrl.trim();
                                if (trimmed) {
                                    discordWebhookUrl = trimmed;
                                    localStorage.setItem('cloudPowerMinerWebhook', discordWebhookUrl);
                                    discordWebhookInput.value = discordWebhookUrl;
                                } else {
                                    discordWebhookUrl = '';
                                    localStorage.removeItem('cloudPowerMinerWebhook');
                                    discordWebhookInput.value = '';
                                }
                            }

                            renderApp();
                            showToast({ type: 'success', title: 'Importación completa', message: 'Los datos se importaron correctamente.' });
                        }
                    } else {
                        showToast({ type: 'error', title: 'Formato inválido', message: 'El archivo no es compatible con esta aplicación.' });
                    }
                } catch (err) {
                    showToast({ type: 'error', title: 'Error al importar', message: 'No fue posible leer el archivo.' });
                }
                e.target.value = '';
            });

            saveWebhookBtn.addEventListener('click', () => {
                setButtonBusy(saveWebhookBtn, 'Guardando...', true);
                try {
                    const url = discordWebhookInput.value.trim();
                    const isDiscordWebhook = /^https:\/\/(?:canary\.|ptb\.)?discord(?:app)?\.com\/api\/webhooks\//i.test(url);
                    if (url && !isDiscordWebhook) {
                        discordWebhookInput.classList.add('ring-2', 'ring-red-500');
                        showToast({ type: 'error', title: 'URL inválida', message: 'Usa un Webhook de Discord válido.' });
                        discordWebhookInput.focus();
                        return;
                    }
                    discordWebhookInput.classList.remove('ring-2', 'ring-red-500');
                    if (url) {
                        localStorage.setItem('cloudPowerMinerWebhook', url);
                        discordWebhookUrl = url;
                        showToast({ type: 'success', title: 'Webhook guardado', message: 'Se usará para futuros respaldos y exportaciones.' });
                    } else {
                        localStorage.removeItem('cloudPowerMinerWebhook');
                        discordWebhookUrl = '';
                        showToast({ type: 'info', title: 'Webhook eliminado', message: 'No se enviarán respaldos a Discord hasta configurar uno.' });
                    }
                } finally {
                    setButtonBusy(saveWebhookBtn, 'Guardando...', false);
                }
            });

            backupToDiscordBtn.addEventListener('click', async () => {
                setButtonBusy(backupToDiscordBtn, 'Enviando...', true);
                const url = (discordWebhookInput.value || '').trim();
                if (!url) {
                    showToast({ type: 'error', title: 'Falta la URL', message: 'Configura tu URL de Webhook antes de respaldar.' });
                    discordWebhookInput.focus();
                    setButtonBusy(backupToDiscordBtn, 'Enviando...', false);
                    return;
                }
                const isDiscordWebhook = /^https:\/\/(?:canary\.|ptb\.)?discord(?:app)?\.com\/api\/webhooks\//i.test(url);
                if (!isDiscordWebhook) {
                    showToast({ type: 'error', title: 'URL inválida', message: 'Usa un Webhook de Discord válido.' });
                    discordWebhookInput.focus();
                    setButtonBusy(backupToDiscordBtn, 'Enviando...', false);
                    return;
                }
                if (url !== discordWebhookUrl) {
                    localStorage.setItem('cloudPowerMinerWebhook', url);
                    discordWebhookUrl = url;
                }
                if (await showConfirmationModal('Discord', '¿Enviar respaldo al Webhook configurado?')) {
                    try {
                        const formData = new FormData();
                        const totalCost = investments.reduce((sum, inv) => sum + (Number(inv.cost) || 0), 0);
                        const now = new Date();
                        now.setUTCHours(0, 0, 0, 0);
                        const activeInvestments = investments.filter(inv => {
                            if (!inv.hasExpiration) return true;
                            return now <= new Date(inv.expirationDate);
                        });
                        const totalDaily = activeInvestments.reduce((sum, inv) => sum + (Number(inv.dailyIncome) || 0), 0);
                        let totalRecovered = 0;
                        investments.forEach(inv => {
                            let limitDate = now;
                            if (inv.hasExpiration) {
                                const expirationDate = new Date(inv.expirationDate);
                                expirationDate.setUTCHours(0, 0, 0, 0);
                                if (expirationDate < limitDate) limitDate = expirationDate;
                            }
                            const startDate = new Date(inv.date);
                            startDate.setUTCHours(0, 0, 0, 0);
                            if (startDate < limitDate) {
                                const days = Math.floor((limitDate - startDate) / (1000 * 60 * 60 * 24));
                                totalRecovered += Math.max(0, days * (Number(inv.dailyIncome) || 0));
                            }
                        });

                        const backupPayload = { type: 'cloud-power-miner-investments', version: '1.0', data: investments, discordWebhookUrl: discordWebhookUrl, exportDate: new Date().toISOString() };
                        const fileBlob = new Blob([JSON.stringify(backupPayload, null, 2)], { type: 'application/json' });
                        formData.append('file', fileBlob, `cloud-power-miner-backup-${new Date().toISOString().slice(0,10)}.json`);

                        const payload = {
                            content: 'Respaldo automático Cloud Power Miner',
                            username: 'Mining Bot',
                            embeds: [
                                {
                                    title: 'Respaldo de Datos de Cloud Power Miner',
                                    description: 'Resumen',
                                    color: 2454510,
                                    fields: [
                                        { name: 'Total de inversiones', value: String(investments.length), inline: true },
                                        { name: 'Costo total', value: currencyFormatter.format(totalCost), inline: true },
                                        { name: 'Ingreso diario activo', value: currencyFormatter.format(totalDaily), inline: true },
                                        { name: 'Total recuperado', value: currencyFormatter.format(totalRecovered), inline: true },
                                        { name: 'Última actualización', value: new Date().toLocaleString('es-MX'), inline: false }
                                    ],
                                    footer: { text: 'Respaldo automático de inversiones' },
                                    timestamp: new Date().toISOString()
                                }
                            ]
                        };
                        formData.append('payload_json', JSON.stringify(payload));

                        await fetch(discordWebhookUrl, {
                            method: 'POST',
                            body: formData
                        });
                        showToast({ type: 'success', title: 'Respaldo enviado', message: 'Se envió el backup y el resumen al canal de Discord.' });
                    } catch (e) {
                        showToast({ type: 'error', title: 'Error al enviar', message: 'No fue posible enviar el respaldo a Discord.' });
                    } finally {
                        setButtonBusy(backupToDiscordBtn, 'Enviando...', false);
                    }
                } else {
                    setButtonBusy(backupToDiscordBtn, 'Enviando...', false);
                }
            });

            // Modal de referencia ROI
            const toggleRoiBtn = document.getElementById('toggle-roi-table');
            const roiTableModal = document.getElementById('roi-reference-table');
            const closeRoiBtn = document.getElementById('close-roi-table');
            
            if (toggleRoiBtn && roiTableModal) {
                toggleRoiBtn.addEventListener('click', () => roiTableModal.classList.add('active'));
            }
            if (closeRoiBtn && roiTableModal) {
                closeRoiBtn.addEventListener('click', () => roiTableModal.classList.remove('active'));
            }
            if (roiTableModal) {
                roiTableModal.addEventListener('click', (e) => {
                    if (e.target === roiTableModal) roiTableModal.classList.remove('active');
                });
            }

            // Init
            renderApp();
        });
    </script>
    <script src="/theme.js"></script>
</body>
</html>
